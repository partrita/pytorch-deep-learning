<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>6&nbsp; 04 - PyTorch 사용자 정의 데이터셋 – 파이토치 딥러닝 입문</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./05_pytorch_going_modular.html" rel="next">
<link href="./03_pytorch_computer_vision.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-803ae4f7a8810f475153517dc3c4ebae.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./04_pytorch_custom_datasets.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">04 - PyTorch 사용자 정의 데이터셋</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">파이토치 딥러닝 입문</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">딥러닝을 위한 PyTorch 배우기</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_pytorch_fundamentals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">00 - PyTorch 기초</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_pytorch_workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">01 - PyTorch 워크플로우</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_pytorch_classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">02 - PyTorch 신경망 분류</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_pytorch_computer_vision.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">03 - PyTorch 컴퓨터 비전</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_pytorch_custom_datasets.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">04 - PyTorch 사용자 정의 데이터셋</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_pytorch_going_modular.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">05 - PyTorch 모듈화</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_pytorch_transfer_learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">06 - PyTorch 전이 학습</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_pytorch_experiment_tracking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">07 - PyTorch 실험 추적</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_pytorch_paper_replicating.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">08 - PyTorch 논문 복제</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09_pytorch_model_deployment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">09 - PyTorch 모델 배포</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">참고 문헌</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#what-is-a-custom-dataset" id="toc-what-is-a-custom-dataset" class="nav-link active" data-scroll-target="#what-is-a-custom-dataset"><span class="header-section-number">6.1</span> What is a custom dataset?</a></li>
  <li><a href="#이번-장에서-다룰-내용" id="toc-이번-장에서-다룰-내용" class="nav-link" data-scroll-target="#이번-장에서-다룰-내용"><span class="header-section-number">6.2</span> 이번 장에서 다룰 내용</a></li>
  <li><a href="#도움을-받을-수-있는-곳" id="toc-도움을-받을-수-있는-곳" class="nav-link" data-scroll-target="#도움을-받을-수-있는-곳"><span class="header-section-number">6.3</span> 도움을 받을 수 있는 곳</a></li>
  <li><a href="#importing-pytorch-and-setting-up-device-agnostic-code" id="toc-importing-pytorch-and-setting-up-device-agnostic-code" class="nav-link" data-scroll-target="#importing-pytorch-and-setting-up-device-agnostic-code"><span class="header-section-number">6.4</span> 0. Importing PyTorch and setting up device-agnostic code</a></li>
  <li><a href="#get-data" id="toc-get-data" class="nav-link" data-scroll-target="#get-data"><span class="header-section-number">6.5</span> 1. Get data</a></li>
  <li><a href="#become-one-with-the-data-data-preparation" id="toc-become-one-with-the-data-data-preparation" class="nav-link" data-scroll-target="#become-one-with-the-data-data-preparation"><span class="header-section-number">6.6</span> 2. Become one with the data (data preparation)</a>
  <ul class="collapse">
  <li><a href="#visualize-an-image" id="toc-visualize-an-image" class="nav-link" data-scroll-target="#visualize-an-image"><span class="header-section-number">6.6.1</span> 2.1 Visualize an image</a></li>
  </ul></li>
  <li><a href="#transforming-data" id="toc-transforming-data" class="nav-link" data-scroll-target="#transforming-data"><span class="header-section-number">6.7</span> 3. Transforming data</a>
  <ul class="collapse">
  <li><a href="#transforming-data-with-torchvision.transforms" id="toc-transforming-data-with-torchvision.transforms" class="nav-link" data-scroll-target="#transforming-data-with-torchvision.transforms"><span class="header-section-number">6.7.1</span> 3.1 Transforming data with <code>torchvision.transforms</code></a></li>
  </ul></li>
  <li><a href="#option-1-loading-image-data-using-imagefolder" id="toc-option-1-loading-image-data-using-imagefolder" class="nav-link" data-scroll-target="#option-1-loading-image-data-using-imagefolder"><span class="header-section-number">6.8</span> 4. Option 1: Loading Image Data Using <code>ImageFolder</code></a>
  <ul class="collapse">
  <li><a href="#turn-loaded-images-into-dataloaders" id="toc-turn-loaded-images-into-dataloaders" class="nav-link" data-scroll-target="#turn-loaded-images-into-dataloaders"><span class="header-section-number">6.8.1</span> 4.1 Turn loaded images into <code>DataLoader</code>’s</a></li>
  </ul></li>
  <li><a href="#option-2-loading-image-data-with-a-custom-dataset" id="toc-option-2-loading-image-data-with-a-custom-dataset" class="nav-link" data-scroll-target="#option-2-loading-image-data-with-a-custom-dataset"><span class="header-section-number">6.9</span> 5. Option 2: Loading Image Data with a Custom <code>Dataset</code></a>
  <ul class="collapse">
  <li><a href="#creating-a-helper-function-to-get-class-names" id="toc-creating-a-helper-function-to-get-class-names" class="nav-link" data-scroll-target="#creating-a-helper-function-to-get-class-names"><span class="header-section-number">6.9.1</span> 5.1 Creating a helper function to get class names</a></li>
  <li><a href="#create-a-custom-dataset-to-replicate-imagefolder" id="toc-create-a-custom-dataset-to-replicate-imagefolder" class="nav-link" data-scroll-target="#create-a-custom-dataset-to-replicate-imagefolder"><span class="header-section-number">6.9.2</span> 5.2 Create a custom <code>Dataset</code> to replicate <code>ImageFolder</code></a></li>
  <li><a href="#create-a-function-to-display-random-images" id="toc-create-a-function-to-display-random-images" class="nav-link" data-scroll-target="#create-a-function-to-display-random-images"><span class="header-section-number">6.9.3</span> 5.3 Create a function to display random images</a></li>
  <li><a href="#turn-custom-loaded-images-into-dataloaders" id="toc-turn-custom-loaded-images-into-dataloaders" class="nav-link" data-scroll-target="#turn-custom-loaded-images-into-dataloaders"><span class="header-section-number">6.9.4</span> 5.4 Turn custom loaded images into <code>DataLoader</code>’s</a></li>
  </ul></li>
  <li><a href="#other-forms-of-transforms-data-augmentation" id="toc-other-forms-of-transforms-data-augmentation" class="nav-link" data-scroll-target="#other-forms-of-transforms-data-augmentation"><span class="header-section-number">6.10</span> 6. Other forms of transforms (data augmentation)</a></li>
  <li><a href="#model-0-tinyvgg-without-data-augmentation" id="toc-model-0-tinyvgg-without-data-augmentation" class="nav-link" data-scroll-target="#model-0-tinyvgg-without-data-augmentation"><span class="header-section-number">6.11</span> 7. Model 0: TinyVGG without data augmentation</a>
  <ul class="collapse">
  <li><a href="#creating-transforms-and-loading-data-for-model-0" id="toc-creating-transforms-and-loading-data-for-model-0" class="nav-link" data-scroll-target="#creating-transforms-and-loading-data-for-model-0"><span class="header-section-number">6.11.1</span> 7.1 Creating transforms and loading data for Model 0</a></li>
  <li><a href="#create-tinyvgg-model-class" id="toc-create-tinyvgg-model-class" class="nav-link" data-scroll-target="#create-tinyvgg-model-class"><span class="header-section-number">6.11.2</span> 7.2 Create TinyVGG model class</a></li>
  <li><a href="#try-a-forward-pass-on-a-single-image-to-test-the-model" id="toc-try-a-forward-pass-on-a-single-image-to-test-the-model" class="nav-link" data-scroll-target="#try-a-forward-pass-on-a-single-image-to-test-the-model"><span class="header-section-number">6.11.3</span> 7.3 Try a forward pass on a single image (to test the model)</a></li>
  <li><a href="#use-torchinfo-to-get-an-idea-of-the-shapes-going-through-our-model" id="toc-use-torchinfo-to-get-an-idea-of-the-shapes-going-through-our-model" class="nav-link" data-scroll-target="#use-torchinfo-to-get-an-idea-of-the-shapes-going-through-our-model"><span class="header-section-number">6.11.4</span> 7.4 Use <code>torchinfo</code> to get an idea of the shapes going through our model</a></li>
  <li><a href="#create-train-test-loop-functions" id="toc-create-train-test-loop-functions" class="nav-link" data-scroll-target="#create-train-test-loop-functions"><span class="header-section-number">6.11.5</span> 7.5 Create train &amp; test loop functions</a></li>
  <li><a href="#creating-a-train-function-to-combine-train_step-and-test_step" id="toc-creating-a-train-function-to-combine-train_step-and-test_step" class="nav-link" data-scroll-target="#creating-a-train-function-to-combine-train_step-and-test_step"><span class="header-section-number">6.11.6</span> 7.6 Creating a <code>train()</code> function to combine <code>train_step()</code> and <code>test_step()</code></a></li>
  <li><a href="#train-and-evaluate-model-0" id="toc-train-and-evaluate-model-0" class="nav-link" data-scroll-target="#train-and-evaluate-model-0"><span class="header-section-number">6.11.7</span> 7.7 Train and Evaluate Model 0</a></li>
  <li><a href="#plot-the-loss-curves-of-model-0" id="toc-plot-the-loss-curves-of-model-0" class="nav-link" data-scroll-target="#plot-the-loss-curves-of-model-0"><span class="header-section-number">6.11.8</span> 7.8 Plot the loss curves of Model 0</a></li>
  </ul></li>
  <li><a href="#what-should-an-ideal-loss-curve-look-like" id="toc-what-should-an-ideal-loss-curve-look-like" class="nav-link" data-scroll-target="#what-should-an-ideal-loss-curve-look-like"><span class="header-section-number">6.12</span> 8. What should an ideal loss curve look like?</a>
  <ul class="collapse">
  <li><a href="#how-to-deal-with-overfitting" id="toc-how-to-deal-with-overfitting" class="nav-link" data-scroll-target="#how-to-deal-with-overfitting"><span class="header-section-number">6.12.1</span> 8.1 How to deal with overfitting</a></li>
  <li><a href="#how-to-deal-with-underfitting" id="toc-how-to-deal-with-underfitting" class="nav-link" data-scroll-target="#how-to-deal-with-underfitting"><span class="header-section-number">6.12.2</span> 8.2 How to deal with underfitting</a></li>
  <li><a href="#the-balance-between-overfitting-and-underfitting" id="toc-the-balance-between-overfitting-and-underfitting" class="nav-link" data-scroll-target="#the-balance-between-overfitting-and-underfitting"><span class="header-section-number">6.12.3</span> 8.3 The balance between overfitting and underfitting</a></li>
  </ul></li>
  <li><a href="#model-1-tinyvgg-with-data-augmentation" id="toc-model-1-tinyvgg-with-data-augmentation" class="nav-link" data-scroll-target="#model-1-tinyvgg-with-data-augmentation"><span class="header-section-number">6.13</span> 9. Model 1: TinyVGG with Data Augmentation</a>
  <ul class="collapse">
  <li><a href="#create-transform-with-data-augmentation" id="toc-create-transform-with-data-augmentation" class="nav-link" data-scroll-target="#create-transform-with-data-augmentation"><span class="header-section-number">6.13.1</span> 9.1 Create transform with data augmentation</a></li>
  <li><a href="#create-train-and-test-datasets-and-dataloaders" id="toc-create-train-and-test-datasets-and-dataloaders" class="nav-link" data-scroll-target="#create-train-and-test-datasets-and-dataloaders"><span class="header-section-number">6.13.2</span> 9.2 Create train and test <code>Dataset</code>’s and <code>DataLoader</code>’s</a></li>
  <li><a href="#construct-and-train-model-1" id="toc-construct-and-train-model-1" class="nav-link" data-scroll-target="#construct-and-train-model-1"><span class="header-section-number">6.13.3</span> 9.3 Construct and train Model 1</a></li>
  <li><a href="#plot-the-loss-curves-of-model-1" id="toc-plot-the-loss-curves-of-model-1" class="nav-link" data-scroll-target="#plot-the-loss-curves-of-model-1"><span class="header-section-number">6.13.4</span> 9.4 Plot the loss curves of Model 1</a></li>
  </ul></li>
  <li><a href="#compare-model-results" id="toc-compare-model-results" class="nav-link" data-scroll-target="#compare-model-results"><span class="header-section-number">6.14</span> 10. Compare model results</a></li>
  <li><a href="#make-a-prediction-on-a-custom-image" id="toc-make-a-prediction-on-a-custom-image" class="nav-link" data-scroll-target="#make-a-prediction-on-a-custom-image"><span class="header-section-number">6.15</span> 11. Make a prediction on a custom image</a>
  <ul class="collapse">
  <li><a href="#loading-in-a-custom-image-with-pytorch" id="toc-loading-in-a-custom-image-with-pytorch" class="nav-link" data-scroll-target="#loading-in-a-custom-image-with-pytorch"><span class="header-section-number">6.15.1</span> 11.1 Loading in a custom image with PyTorch</a></li>
  <li><a href="#predicting-on-custom-images-with-a-trained-pytorch-model" id="toc-predicting-on-custom-images-with-a-trained-pytorch-model" class="nav-link" data-scroll-target="#predicting-on-custom-images-with-a-trained-pytorch-model"><span class="header-section-number">6.15.2</span> 11.2 Predicting on custom images with a trained PyTorch model</a></li>
  <li><a href="#putting-custom-image-prediction-together-building-a-function" id="toc-putting-custom-image-prediction-together-building-a-function" class="nav-link" data-scroll-target="#putting-custom-image-prediction-together-building-a-function"><span class="header-section-number">6.15.3</span> 11.3 Putting custom image prediction together: building a function</a></li>
  </ul></li>
  <li><a href="#main-takeaways" id="toc-main-takeaways" class="nav-link" data-scroll-target="#main-takeaways"><span class="header-section-number">6.16</span> Main takeaways</a></li>
  <li><a href="#연습-문제" id="toc-연습-문제" class="nav-link" data-scroll-target="#연습-문제"><span class="header-section-number">6.17</span> 연습 문제</a></li>
  <li><a href="#추가-학습-자료" id="toc-추가-학습-자료" class="nav-link" data-scroll-target="#추가-학습-자료"><span class="header-section-number">6.18</span> 추가 학습 자료</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">04 - PyTorch 사용자 정의 데이터셋</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><a href="https://colab.research.google.com/github/mrdbourke/pytorch-deep-learning/blob/main/04_pytorch_custom_datasets.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<p>In the last notebook, <a href="https://www.learnpytorch.io/03_pytorch_computer_vision/">notebook 03</a>, we looked at how to build computer vision models on an in-built dataset in PyTorch (FashionMNIST).</p>
<p>The steps we took are similar across many different problems in machine learning.</p>
<p>Find a dataset, turn the dataset into numbers, build a model (or find an existing model) to find patterns in those numbers that can be used for prediction.</p>
<p>PyTorch has many built-in datasets used for a wide number of machine learning benchmarks, however, you’ll often want to use your own <strong>custom dataset</strong>.</p>
<section id="what-is-a-custom-dataset" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="what-is-a-custom-dataset"><span class="header-section-number">6.1</span> What is a custom dataset?</h2>
<p>A <strong>custom dataset</strong> is a collection of data relating to a specific problem you’re working on.</p>
<p>In essence, a <strong>custom dataset</strong> can be comprised of almost anything.</p>
<p>For example, if we were building a food image classification app like <a href="https://nutrify.app">Nutrify</a>, our custom dataset might be images of food.</p>
<p>Or if we were trying to build a model to classify whether or not a text-based review on a website was positive or negative, our custom dataset might be examples of existing customer reviews and their ratings.</p>
<p>Or if we were trying to build a sound classification app, our custom dataset might be sound samples alongside their sample labels.</p>
<p>Or if we were trying to build a recommendation system for customers purchasing things on our website, our custom dataset might be examples of products other people have bought.</p>
<p><img src="https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/04-pytorch-domain-libraries.png" alt="different pytorch domain libraries can be used for specific PyTorch problems" width="1000/"></p>
<p><em>PyTorch includes many existing functions to load in various custom datasets in the <a href="https://pytorch.org/vision/stable/index.html"><code>TorchVision</code></a>, <a href="https://pytorch.org/text/stable/index.html"><code>TorchText</code></a>, <a href="https://pytorch.org/audio/stable/index.html"><code>TorchAudio</code></a> and <a href="https://pytorch.org/torchrec/"><code>TorchRec</code></a> domain libraries.</em></p>
<p>But sometimes these existing functions may not be enough.</p>
<p>In that case, we can always subclass <code>torch.utils.data.Dataset</code> and customize it to our liking.</p>
</section>
<section id="이번-장에서-다룰-내용" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="이번-장에서-다룰-내용"><span class="header-section-number">6.2</span> 이번 장에서 다룰 내용</h2>
<p>We’re going to be applying the PyTorch Workflow we covered in <a href="https://www.learnpytorch.io/01_pytorch_workflow/">notebook 01</a> and <a href="https://www.learnpytorch.io/02_pytorch_classification/">notebook 02</a> to a computer vision problem.</p>
<p>But instead of using an in-built PyTorch dataset, we’re going to be using our own dataset of pizza, steak and sushi images.</p>
<p>The goal will be to load these images and then build a model to train and predict on them.</p>
<p><img src="https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/04-pytorch-food-vision-layout.png" alt="building a pipeline to load in food images and then building a pytorch model to classify those food images" width="800"></p>
<p><em>What we’re going to build. We’ll use <code>torchvision.datasets</code> as well as our own custom <code>Dataset</code> class to load in images of food and then we’ll build a PyTorch computer vision model to hopefully be able to classify them.</em></p>
<p>Specifically, we’re going to cover:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Topic</strong></th>
<th><strong>Contents</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>0. Importing PyTorch and setting up device-agnostic code</strong></td>
<td>Let’s get PyTorch loaded and then follow best practice to setup our code to be device-agnostic.</td>
</tr>
<tr class="even">
<td><strong>1. Get data</strong></td>
<td>We’re going to be using our own <strong>custom dataset</strong> of pizza, steak and sushi images.</td>
</tr>
<tr class="odd">
<td><strong>2. Become one with the data (data preparation)</strong></td>
<td>At the beginning of any new machine learning problem, it’s paramount to understand the data you’re working with. Here we’ll take some steps to figure out what data we have.</td>
</tr>
<tr class="even">
<td><strong>3. Transforming data</strong></td>
<td>Often, the data you get won’t be 100% ready to use with a machine learning model, here we’ll look at some steps we can take to <em>transform</em> our images so they’re ready to be used with a model.</td>
</tr>
<tr class="odd">
<td><strong>4. Loading data with <code>ImageFolder</code> (option 1)</strong></td>
<td>PyTorch has many in-built data loading functions for common types of data. <code>ImageFolder</code> is helpful if our images are in standard image classification format.</td>
</tr>
<tr class="even">
<td><strong>5. Loading image data with a custom <code>Dataset</code></strong></td>
<td>What if PyTorch didn’t have an in-built function to load data with? This is where we can build our own custom subclass of <code>torch.utils.data.Dataset</code>.</td>
</tr>
<tr class="odd">
<td><strong>6. Other forms of transforms (data augmentation)</strong></td>
<td>Data augmentation is a common technique for expanding the diversity of your training data. Here we’ll explore some of <code>torchvision</code>’s in-built data augmentation functions.</td>
</tr>
<tr class="even">
<td><strong>7. Model 0: TinyVGG without data augmentation</strong></td>
<td>By this stage, we’ll have our data ready, let’s build a model capable of fitting it. We’ll also create some training and testing functions for training and evaluating our model.</td>
</tr>
<tr class="odd">
<td><strong>8. Exploring loss curves</strong></td>
<td>Loss curves are a great way to see how your model is training/improving over time. They’re also a good way to see if your model is <strong>underfitting</strong> or <strong>overfitting</strong>.</td>
</tr>
<tr class="even">
<td><strong>9. Model 1: TinyVGG with data augmentation</strong></td>
<td>By now, we’ve tried a model <em>without</em>, how about we try one <em>with</em> data augmentation?</td>
</tr>
<tr class="odd">
<td><strong>10. Compare model results</strong></td>
<td>Let’s compare our different models’ loss curves and see which performed better and discuss some options for improving performance.</td>
</tr>
<tr class="even">
<td><strong>11. Making a prediction on a custom image</strong></td>
<td>Our model is trained to on a dataset of pizza, steak and sushi images. In this section we’ll cover how to use our trained model to predict on an image <em>outside</em> of our existing dataset.</td>
</tr>
</tbody>
</table>
</section>
<section id="도움을-받을-수-있는-곳" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="도움을-받을-수-있는-곳"><span class="header-section-number">6.3</span> 도움을 받을 수 있는 곳</h2>
<p>All of the materials for this course <a href="https://github.com/mrdbourke/pytorch-deep-learning">live on GitHub</a>.</p>
<p>If you run into trouble, you can ask a question on the course <a href="https://github.com/mrdbourke/pytorch-deep-learning/discussions">GitHub Discussions page</a> there too.</p>
<p>And of course, there’s the <a href="https://pytorch.org/docs/stable/index.html">PyTorch documentation</a> and <a href="https://discuss.pytorch.org/">PyTorch developer forums</a>, a very helpful place for all things PyTorch.</p>
</section>
<section id="importing-pytorch-and-setting-up-device-agnostic-code" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="importing-pytorch-and-setting-up-device-agnostic-code"><span class="header-section-number">6.4</span> 0. Importing PyTorch and setting up device-agnostic code</h2>
<div id="cell-6" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 참고: this notebook requires torch &gt;= 1.10.0</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>torch.__version__</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>'1.11.0'</code></pre>
</div>
</div>
<p>And now let’s follow best practice and setup device-agnostic code.</p>
<blockquote class="blockquote">
<p><strong>참고:</strong> If you’re using Google Colab, and you don’t have a GPU turned on yet, it’s now time to turn one on via <code>Runtime -&gt; Change runtime type -&gt; Hardware accelerator -&gt; GPU</code>. If you do this, your runtime will likely reset and you’ll have to run all of the cells above by going <code>Runtime -&gt; Run before</code>.</p>
</blockquote>
<div id="cell-8" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup device-agnostic code</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> <span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>device</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>'cuda'</code></pre>
</div>
</div>
</section>
<section id="get-data" class="level2" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="get-data"><span class="header-section-number">6.5</span> 1. Get data</h2>
<p>First thing’s first we need some data.</p>
<p>And like any good cooking show, some data has already been prepared for us.</p>
<p>We’re going to start small.</p>
<p>Because we’re not looking to train the biggest model or use the biggest dataset yet.</p>
<p>Machine learning is an iterative process, start small, get something working and increase when necessary.</p>
<p>The data we’re going to be using is a subset of the <a href="https://data.vision.ee.ethz.ch/cvl/datasets_extra/food-101/">Food101 dataset</a>.</p>
<p>Food101 is popular computer vision benchmark as it contains 1000 images of 101 different kinds of foods, totaling 101,000 images (75,750 train and 25,250 test).</p>
<p>Can you think of 101 different foods?</p>
<p>Can you think of a computer program to classify 101 foods?</p>
<p>I can.</p>
<p>A machine learning model!</p>
<p>Specifically, a PyTorch computer vision model like we covered in <a href="https://www.learnpytorch.io/03_pytorch_computer_vision/">notebook 03</a>.</p>
<p>Instead of 101 food classes though, we’re going to start with 3: pizza, steak and sushi.</p>
<p>And instead of 1,000 images per class, we’re going to start with a random 10% (start small, increase when necessary).</p>
<p>If you’d like to see where the data came from you see the following resources: * Original <a href="https://data.vision.ee.ethz.ch/cvl/datasets_extra/food-101/">Food101 dataset and paper website</a>. * <a href="https://pytorch.org/vision/main/generated/torchvision.datasets.Food101.html"><code>torchvision.datasets.Food101</code></a> - the version of the data I downloaded for this notebook. * <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/extras/04_custom_data_creation.ipynb"><code>extras/04_custom_data_creation.ipynb</code></a> - a notebook I used to format the Food101 dataset to use for this notebook. * <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/data/pizza_steak_sushi.zip"><code>data/pizza_steak_sushi.zip</code></a> - the zip archive of pizza, steak and sushi images from Food101, created with the notebook linked above.</p>
<p>Let’s write some code to download the formatted data from GitHub.</p>
<blockquote class="blockquote">
<p><strong>참고:</strong> The dataset we’re about to use has been pre-formatted for what we’d like to use it for. However, you’ll often have to format your own datasets for whatever problem you’re working on. This is a regular practice in the machine learning world.</p>
</blockquote>
<div id="cell-10" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zipfile</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup path to data folder</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> Path(<span class="st">"data/"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>image_path <span class="op">=</span> data_path <span class="op">/</span> <span class="st">"pizza_steak_sushi"</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># If the image folder doesn't exist, download it and prepare it... </span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> image_path.is_dir():</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>image_path<span class="sc">}</span><span class="ss"> directory exists."</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Did not find </span><span class="sc">{</span>image_path<span class="sc">}</span><span class="ss"> directory, creating one..."</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    image_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Download pizza, steak, sushi data</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(data_path <span class="op">/</span> <span class="st">"pizza_steak_sushi.zip"</span>, <span class="st">"wb"</span>) <span class="im">as</span> f:</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        request <span class="op">=</span> requests.get(<span class="st">"https://github.com/mrdbourke/pytorch-deep-learning/raw/main/data/pizza_steak_sushi.zip"</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Downloading pizza, steak, sushi data..."</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        f.write(request.content)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Unzip pizza, steak, sushi data</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> zipfile.ZipFile(data_path <span class="op">/</span> <span class="st">"pizza_steak_sushi.zip"</span>, <span class="st">"r"</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Unzipping pizza, steak, sushi data..."</span>) </span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        zip_ref.extractall(image_path)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>data/pizza_steak_sushi directory exists.</code></pre>
</div>
</div>
</section>
<section id="become-one-with-the-data-data-preparation" class="level2" data-number="6.6">
<h2 data-number="6.6" class="anchored" data-anchor-id="become-one-with-the-data-data-preparation"><span class="header-section-number">6.6</span> 2. Become one with the data (data preparation)</h2>
<p>Dataset downloaded!</p>
<p>Time to become one with it.</p>
<p>This is another important step before building a model.</p>
<p>As Abraham Lossfunction said…</p>
<p><img src="https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/04-abraham-lossfunction.png" alt="tweet by mrdbourke, if I had eight hours to build a machine learning model, I'd spend the first 6 hours preparing my dataset" width="800/"></p>
<p><em>Data preparation is paramount. Before building a model, become one with the data. Ask: What am I trying to do here? Source: <a href="https://twitter.com/mrdbourke">@mrdbourke Twitter</a>.</em></p>
<p>What’s inspecting the data and becoming one with it?</p>
<p>Before starting a project or building any kind of model, it’s important to know what data you’re working with.</p>
<p>In our case, we have images of pizza, steak and sushi in standard image classification format.</p>
<p>Image classification format contains separate classes of images in seperate directories titled with a particular class name.</p>
<p>For example, all images of <code>pizza</code> are contained in the <code>pizza/</code> directory.</p>
<p>This format is popular across many different image classification benchmarks, including <a href="https://www.image-net.org/">ImageNet</a> (of the most popular computer vision benchmark datasets).</p>
<p>You can see an example of the storage format below, the images numbers are arbitrary.</p>
<pre><code>pizza_steak_sushi/ &lt;- overall dataset folder
    train/ &lt;- training images
        pizza/ &lt;- class name as folder name
            image01.jpeg
            image02.jpeg
            ...
        steak/
            image24.jpeg
            image25.jpeg
            ...
        sushi/
            image37.jpeg
            ...
    test/ &lt;- testing images
        pizza/
            image101.jpeg
            image102.jpeg
            ...
        steak/
            image154.jpeg
            image155.jpeg
            ...
        sushi/
            image167.jpeg
            ...</code></pre>
<p>The goal will be to <strong>take this data storage structure and turn it into a dataset usable with PyTorch</strong>.</p>
<blockquote class="blockquote">
<p><strong>참고:</strong> The structure of the data you work with will vary depending on the problem you’re working on. But the premise still remains: become one with the data, then find a way to best turn it into a dataset compatible with PyTorch.</p>
</blockquote>
<p>We can inspect what’s in our data directory by writing a small helper function to walk through each of the subdirectories and count the files present.</p>
<p>To do so, we’ll use Python’s in-built <a href="https://docs.python.org/3/library/os.html#os.walk"><code>os.walk()</code></a>.</p>
<div id="cell-12" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> walk_through_dir(dir_path):</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">  Walks through dir_path returning its contents.</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">  Args:</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">    dir_path (str or pathlib.Path): target directory</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">  </span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">  Returns:</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">    A print out of:</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">      number of subdiretories in dir_path</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">      number of images (files) in each subdirectory</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">      name of each subdirectory</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">  """</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> dirpath, dirnames, filenames <span class="kw">in</span> os.walk(dir_path):</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span><span class="bu">len</span>(dirnames)<span class="sc">}</span><span class="ss"> directories and </span><span class="sc">{</span><span class="bu">len</span>(filenames)<span class="sc">}</span><span class="ss"> images in '</span><span class="sc">{</span>dirpath<span class="sc">}</span><span class="ss">'."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-13" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>walk_through_dir(image_path)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 2 directories and 0 images in 'data\pizza_steak_sushi'.
There are 3 directories and 0 images in 'data\pizza_steak_sushi\test'.
There are 0 directories and 25 images in 'data\pizza_steak_sushi\test\pizza'.
There are 0 directories and 19 images in 'data\pizza_steak_sushi\test\steak'.
There are 0 directories and 31 images in 'data\pizza_steak_sushi\test\sushi'.
There are 3 directories and 0 images in 'data\pizza_steak_sushi\train'.
There are 0 directories and 78 images in 'data\pizza_steak_sushi\train\pizza'.
There are 0 directories and 75 images in 'data\pizza_steak_sushi\train\steak'.
There are 0 directories and 72 images in 'data\pizza_steak_sushi\train\sushi'.</code></pre>
</div>
</div>
<p>Excellent!</p>
<p>It looks like we’ve got about 75 images per training class and 25 images per testing class.</p>
<p>That should be enough to get started.</p>
<p>Remember, these images are subsets of the original Food101 dataset.</p>
<p>You can see how they were created in the <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/extras/04_custom_data_creation.ipynb">data creation notebook</a>.</p>
<p>While we’re at it, let’s setup our training and testing paths.</p>
<div id="cell-15" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup train and testing paths</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>train_dir <span class="op">=</span> image_path <span class="op">/</span> <span class="st">"train"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>test_dir <span class="op">=</span> image_path <span class="op">/</span> <span class="st">"test"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>train_dir, test_dir</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>(WindowsPath('data/pizza_steak_sushi/train'),
 WindowsPath('data/pizza_steak_sushi/test'))</code></pre>
</div>
</div>
<section id="visualize-an-image" class="level3" data-number="6.6.1">
<h3 data-number="6.6.1" class="anchored" data-anchor-id="visualize-an-image"><span class="header-section-number">6.6.1</span> 2.1 Visualize an image</h3>
<p>Okay, we’ve seen how our directory structure is formatted.</p>
<p>Now in the spirit of the data explorer, it’s time to <em>visualize, visualize, visualize!</em></p>
<p>Let’s write some code to: 1. Get all of the image paths using <a href="https://docs.python.org/3/library/pathlib.html#pathlib.Path.glob"><code>pathlib.Path.glob()</code></a> to find all of the files ending in <code>.jpg</code>. 2. Pick a random image path using Python’s <a href="https://docs.python.org/3/library/random.html#random.choice"><code>random.choice()</code></a>. 3. Get the image class name using <a href="https://docs.python.org/3/library/pathlib.html#pathlib.PurePath.parent"><code>pathlib.Path.parent.stem</code></a>. 4. And since we’re working with images, we’ll open the random image path using <a href="https://pillow.readthedocs.io/en/stable/reference/Image.html#PIL.Image.open"><code>PIL.Image.open()</code></a> (PIL stands for Python Image Library). 5. We’ll then show the image and print some metadata.</p>
<div id="cell-17" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seed</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">42</span>) <span class="co"># &lt;- try changing this and see what happens</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Get all image paths (* means "any combination")</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>image_path_list <span class="op">=</span> <span class="bu">list</span>(image_path.glob(<span class="st">"*/*/*.jpg"</span>))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Get random image path</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>random_image_path <span class="op">=</span> random.choice(image_path_list)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Get image class from path name (the image class is the name of the directory where the image is stored)</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>image_class <span class="op">=</span> random_image_path.parent.stem</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Open image</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> Image.<span class="bu">open</span>(random_image_path)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Print metadata</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Random image path: </span><span class="sc">{</span>random_image_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image class: </span><span class="sc">{</span>image_class<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image height: </span><span class="sc">{</span>img<span class="sc">.</span>height<span class="sc">}</span><span class="ss">"</span>) </span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image width: </span><span class="sc">{</span>img<span class="sc">.</span>width<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>img</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Random image path: data\pizza_steak_sushi\test\sushi\2394442.jpg
Image class: sushi
Image height: 408
Image width: 512</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-8-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can do the same with <a href="https://matplotlib.org/3.5.0/api/_as_gen/matplotlib.pyplot.imshow.html"><code>matplotlib.pyplot.imshow()</code></a>, except we have to convert the image to a NumPy array first.</p>
<div id="cell-19" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn the image into an array</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>img_as_array <span class="op">=</span> np.asarray(img)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the image with matplotlib</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">7</span>))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>plt.imshow(img_as_array)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"Image class: </span><span class="sc">{</span>image_class<span class="sc">}</span><span class="ss"> | Image shape: </span><span class="sc">{</span>img_as_array<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> -&gt; [height, width, color_channels]"</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="va">False</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="transforming-data" class="level2" data-number="6.7">
<h2 data-number="6.7" class="anchored" data-anchor-id="transforming-data"><span class="header-section-number">6.7</span> 3. Transforming data</h2>
<p>Now what if we wanted to load our image data into PyTorch?</p>
<p>Before we can use our image data with PyTorch we need to:</p>
<ol type="1">
<li>Turn it into tensors (numerical representations of our images).</li>
<li>Turn it into a <code>torch.utils.data.Dataset</code> and subsequently a <code>torch.utils.data.DataLoader</code>, we’ll call these <code>Dataset</code> and <code>DataLoader</code> for short.</li>
</ol>
<p>There are several different kinds of pre-built datasets and dataset loaders for PyTorch, depending on the problem you’re working on.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th><strong>Problem space</strong></th>
<th><strong>Pre-built Datasets and Functions</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Vision</strong></td>
<td><a href="https://pytorch.org/vision/stable/datasets.html"><code>torchvision.datasets</code></a></td>
</tr>
<tr class="even">
<td><strong>Audio</strong></td>
<td><a href="https://pytorch.org/audio/stable/datasets.html"><code>torchaudio.datasets</code></a></td>
</tr>
<tr class="odd">
<td><strong>Text</strong></td>
<td><a href="https://pytorch.org/text/stable/datasets.html"><code>torchtext.datasets</code></a></td>
</tr>
<tr class="even">
<td><strong>Recommendation system</strong></td>
<td><a href="https://pytorch.org/torchrec/torchrec.datasets.html"><code>torchrec.datasets</code></a></td>
</tr>
</tbody>
</table>
<p>Since we’re working with a vision problem, we’ll be looking at <code>torchvision.datasets</code> for our data loading functions as well as <a href="https://pytorch.org/vision/stable/transforms.html"><code>torchvision.transforms</code></a> for preparing our data.</p>
<p>Let’s import some base libraries.</p>
<div id="cell-21" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> datasets, transforms</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="transforming-data-with-torchvision.transforms" class="level3" data-number="6.7.1">
<h3 data-number="6.7.1" class="anchored" data-anchor-id="transforming-data-with-torchvision.transforms"><span class="header-section-number">6.7.1</span> 3.1 Transforming data with <code>torchvision.transforms</code></h3>
<p>We’ve got folders of images but before we can use them with PyTorch, we need to convert them into tensors.</p>
<p>One of the ways we can do this is by using the <code>torchvision.transforms</code> module.</p>
<p><code>torchvision.transforms</code> contains many pre-built methods for formatting images, turning them into tensors and even manipulating them for <strong>data augmentation</strong> (the practice of altering data to make it harder for a model to learn, we’ll see this later on) purposes .</p>
<p>To get experience with <code>torchvision.transforms</code>, let’s write a series of transform steps that: 1. Resize the images using <a href="https://pytorch.org/vision/stable/generated/torchvision.transforms.Resize.html#torchvision.transforms.Resize"><code>transforms.Resize()</code></a> (from about 512x512 to 64x64, the same shape as the images on the <a href="https://poloclub.github.io/cnn-explainer/">CNN Explainer website</a>). 2. Flip our images randomly on the horizontal using <a href="https://pytorch.org/vision/stable/generated/torchvision.transforms.RandomHorizontalFlip.html#torchvision.transforms.RandomHorizontalFlip"><code>transforms.RandomHorizontalFlip()</code></a> (this could be considered a form of data augmentation because it will artificially change our image data). 3. Turn our images from a PIL image to a PyTorch tensor using <a href="https://pytorch.org/vision/stable/generated/torchvision.transforms.ToTensor.html#torchvision.transforms.ToTensor"><code>transforms.ToTensor()</code></a>.</p>
<p>We can compile all of these steps using <a href="https://pytorch.org/vision/stable/generated/torchvision.transforms.Compose.html#torchvision.transforms.Compose"><code>torchvision.transforms.Compose()</code></a>.</p>
<div id="cell-23" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Write transform for image</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>data_transform <span class="op">=</span> transforms.Compose([</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resize the images to 64x64</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    transforms.Resize(size<span class="op">=</span>(<span class="dv">64</span>, <span class="dv">64</span>)),</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Flip the images randomly on the horizontal</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    transforms.RandomHorizontalFlip(p<span class="op">=</span><span class="fl">0.5</span>), <span class="co"># p = probability of flip, 0.5 = 50% chance</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turn the image into a torch.Tensor</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor() <span class="co"># this also converts all pixel values from 0 to 255 to be between 0.0 and 1.0 </span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now we’ve got a composition of transforms, let’s write a function to try them out on various images.</p>
<div id="cell-25" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_transformed_images(image_paths, transform, n<span class="op">=</span><span class="dv">3</span>, seed<span class="op">=</span><span class="dv">42</span>):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plots a series of random images from image_paths.</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Will open n image paths from image_paths, transform them</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">    with transform and plot them side by side.</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">        image_paths (list): List of target image paths. </span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">        transform (PyTorch Transforms): Transforms to apply to images.</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">        n (int, optional): Number of images to plot. Defaults to 3.</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">        seed (int, optional): Random seed for the random generator. Defaults to 42.</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    random.seed(seed)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    random_image_paths <span class="op">=</span> random.sample(image_paths, k<span class="op">=</span>n)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> image_path <span class="kw">in</span> random_image_paths:</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> Image.<span class="bu">open</span>(image_path) <span class="im">as</span> f:</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>            fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>            ax[<span class="dv">0</span>].imshow(f) </span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>            ax[<span class="dv">0</span>].set_title(<span class="ss">f"Original </span><span class="ch">\n</span><span class="ss">Size: </span><span class="sc">{</span>f<span class="sc">.</span>size<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>            ax[<span class="dv">0</span>].axis(<span class="st">"off"</span>)</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Transform and plot image</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 참고: permute() will change shape of image to suit matplotlib </span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># (PyTorch default is [C, H, W] but Matplotlib is [H, W, C])</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>            transformed_image <span class="op">=</span> transform(f).permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>) </span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>            ax[<span class="dv">1</span>].imshow(transformed_image) </span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>            ax[<span class="dv">1</span>].set_title(<span class="ss">f"Transformed </span><span class="ch">\n</span><span class="ss">Size: </span><span class="sc">{</span>transformed_image<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>            ax[<span class="dv">1</span>].axis(<span class="st">"off"</span>)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>            fig.suptitle(<span class="ss">f"Class: </span><span class="sc">{</span>image_path<span class="sc">.</span>parent<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>plot_transformed_images(image_path_list, </span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>                        transform<span class="op">=</span>data_transform, </span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>                        n<span class="op">=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-12-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-12-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Nice!</p>
<p>We’ve now got a way to convert our images to tensors using <code>torchvision.transforms</code>.</p>
<p>We also manipulate their size and orientation if needed (some models prefer images of different sizes and shapes).</p>
<p>Generally, the larger the shape of the image, the more information a model can recover.</p>
<p>For example, an image of size <code>[256, 256, 3]</code> will have 16x more pixels than an image of size <code>[64, 64, 3]</code> (<code>(256*256*3)/(64*64*3)=16</code>).</p>
<p>However, the tradeoff is that more pixels requires more computations.</p>
<blockquote class="blockquote">
<p><strong>Exercise:</strong> Try commenting out one of the transforms in <code>data_transform</code> and running the plotting function <code>plot_transformed_images()</code> again, what happens?</p>
</blockquote>
</section>
</section>
<section id="option-1-loading-image-data-using-imagefolder" class="level2" data-number="6.8">
<h2 data-number="6.8" class="anchored" data-anchor-id="option-1-loading-image-data-using-imagefolder"><span class="header-section-number">6.8</span> 4. Option 1: Loading Image Data Using <a href="https://pytorch.org/vision/stable/generated/torchvision.datasets.ImageFolder.html#torchvision.datasets.ImageFolder"><code>ImageFolder</code></a></h2>
<p>Alright, time to turn our image data into a <code>Dataset</code> capable of being used with PyTorch.</p>
<p>Since our data is in standard image classification format, we can use the class <a href="https://pytorch.org/vision/stable/generated/torchvision.datasets.ImageFolder.html#torchvision.datasets.ImageFolder"><code>torchvision.datasets.ImageFolder</code></a>.</p>
<p>Where we can pass it the file path of a target image directory as well as a series of transforms we’d like to perform on our images.</p>
<p>Let’s test it out on our data folders <code>train_dir</code> and <code>test_dir</code> passing in <code>transform=data_transform</code> to turn our images into tensors.</p>
<div id="cell-28" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use ImageFolder to create dataset(s)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> datasets</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>train_data <span class="op">=</span> datasets.ImageFolder(root<span class="op">=</span>train_dir, <span class="co"># target folder of images</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                                  transform<span class="op">=</span>data_transform, <span class="co"># transforms to perform on data (images)</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                                  target_transform<span class="op">=</span><span class="va">None</span>) <span class="co"># transforms to perform on labels (if necessary)</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> datasets.ImageFolder(root<span class="op">=</span>test_dir, </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>                                 transform<span class="op">=</span>data_transform)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Train data:</span><span class="ch">\n</span><span class="sc">{</span>train_data<span class="sc">}</span><span class="ch">\n</span><span class="ss">Test data:</span><span class="ch">\n</span><span class="sc">{</span>test_data<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data:
Dataset ImageFolder
    Number of datapoints: 225
    Root location: data\pizza_steak_sushi\train
    StandardTransform
Transform: Compose(
               Resize(size=(64, 64), interpolation=bilinear, max_size=None, antialias=None)
               RandomHorizontalFlip(p=0.5)
               ToTensor()
           )
Test data:
Dataset ImageFolder
    Number of datapoints: 75
    Root location: data\pizza_steak_sushi\test
    StandardTransform
Transform: Compose(
               Resize(size=(64, 64), interpolation=bilinear, max_size=None, antialias=None)
               RandomHorizontalFlip(p=0.5)
               ToTensor()
           )</code></pre>
</div>
</div>
<p>Beautiful!</p>
<p>It looks like PyTorch has registered our <code>Dataset</code>’s.</p>
<p>Let’s inspect them by checking out the <code>classes</code> and <code>class_to_idx</code> attributes as well as the lengths of our training and test sets.</p>
<div id="cell-30" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get class names as a list</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>class_names <span class="op">=</span> train_data.classes</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>class_names</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>['pizza', 'steak', 'sushi']</code></pre>
</div>
</div>
<div id="cell-31" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Can also get class names as a dict</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>class_dict <span class="op">=</span> train_data.class_to_idx</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>class_dict</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>{'pizza': 0, 'steak': 1, 'sushi': 2}</code></pre>
</div>
</div>
<div id="cell-32" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the lengths</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(train_data), <span class="bu">len</span>(test_data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>(225, 75)</code></pre>
</div>
</div>
<p>Nice! Looks like we’ll be able to use these to reference for later.</p>
<p>How about our images and labels?</p>
<p>How do they look?</p>
<p>We can index on our <code>train_data</code> and <code>test_data</code> <code>Dataset</code>’s to find samples and their target labels.</p>
<div id="cell-34" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>img, label <span class="op">=</span> train_data[<span class="dv">0</span>][<span class="dv">0</span>], train_data[<span class="dv">0</span>][<span class="dv">1</span>]</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image tensor:</span><span class="ch">\n</span><span class="sc">{</span>img<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image shape: </span><span class="sc">{</span>img<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image datatype: </span><span class="sc">{</span>img<span class="sc">.</span>dtype<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image label: </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Label datatype: </span><span class="sc">{</span><span class="bu">type</span>(label)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Image tensor:
tensor([[[0.1137, 0.1020, 0.0980,  ..., 0.1255, 0.1216, 0.1176],
         [0.1059, 0.0980, 0.0980,  ..., 0.1294, 0.1294, 0.1294],
         [0.1020, 0.0980, 0.0941,  ..., 0.1333, 0.1333, 0.1333],
         ...,
         [0.1098, 0.1098, 0.1255,  ..., 0.1686, 0.1647, 0.1686],
         [0.0863, 0.0941, 0.1098,  ..., 0.1686, 0.1647, 0.1686],
         [0.0863, 0.0863, 0.0980,  ..., 0.1686, 0.1647, 0.1647]],

        [[0.0745, 0.0706, 0.0745,  ..., 0.0588, 0.0588, 0.0588],
         [0.0706, 0.0706, 0.0745,  ..., 0.0627, 0.0627, 0.0627],
         [0.0706, 0.0745, 0.0745,  ..., 0.0706, 0.0706, 0.0706],
         ...,
         [0.1255, 0.1333, 0.1373,  ..., 0.2510, 0.2392, 0.2392],
         [0.1098, 0.1176, 0.1255,  ..., 0.2510, 0.2392, 0.2314],
         [0.1020, 0.1059, 0.1137,  ..., 0.2431, 0.2353, 0.2275]],

        [[0.0941, 0.0902, 0.0902,  ..., 0.0196, 0.0196, 0.0196],
         [0.0902, 0.0863, 0.0902,  ..., 0.0196, 0.0157, 0.0196],
         [0.0902, 0.0902, 0.0902,  ..., 0.0157, 0.0157, 0.0196],
         ...,
         [0.1294, 0.1333, 0.1490,  ..., 0.1961, 0.1882, 0.1804],
         [0.1098, 0.1137, 0.1255,  ..., 0.1922, 0.1843, 0.1804],
         [0.1059, 0.1020, 0.1059,  ..., 0.1843, 0.1804, 0.1765]]])
Image shape: torch.Size([3, 64, 64])
Image datatype: torch.float32
Image label: 0
Label datatype: &lt;class 'int'&gt;</code></pre>
</div>
</div>
<p>Our images are now in the form of a tensor (with shape <code>[3, 64, 64]</code>) and the labels are in the form of an integer relating to a specific class (as referenced by the <code>class_to_idx</code> attribute).</p>
<p>How about we plot a single image tensor using <code>matplotlib</code>?</p>
<p>We’ll first have to to permute (rearrange the order of its dimensions) so it’s compatible.</p>
<p>Right now our image dimensions are in the format <code>CHW</code> (color channels, height, width) but <code>matplotlib</code> prefers <code>HWC</code> (height, width, color channels).</p>
<div id="cell-36" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rearrange the order of dimensions</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>img_permute <span class="op">=</span> img.permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print out different shapes (before and after permute)</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Original shape: </span><span class="sc">{</span>img<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> -&gt; [color_channels, height, width]"</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image permute shape: </span><span class="sc">{</span>img_permute<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> -&gt; [height, width, color_channels]"</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the image</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">7</span>))</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>plt.imshow(img.permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>))</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"off"</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>plt.title(class_names[label], fontsize<span class="op">=</span><span class="dv">14</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original shape: torch.Size([3, 64, 64]) -&gt; [color_channels, height, width]
Image permute shape: torch.Size([64, 64, 3]) -&gt; [height, width, color_channels]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-18-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Notice the image is now more pixelated (less quality).</p>
<p>This is due to it being resized from <code>512x512</code> to <code>64x64</code> pixels.</p>
<p>The intuition here is that if you think the image is harder to recognize what’s going on, chances are a model will find it harder to understand too.</p>
<section id="turn-loaded-images-into-dataloaders" class="level3" data-number="6.8.1">
<h3 data-number="6.8.1" class="anchored" data-anchor-id="turn-loaded-images-into-dataloaders"><span class="header-section-number">6.8.1</span> 4.1 Turn loaded images into <code>DataLoader</code>’s</h3>
<p>We’ve got our images as PyTorch <code>Dataset</code>’s but now let’s turn them into <code>DataLoader</code>’s.</p>
<p>We’ll do so using <a href="https://pytorch.org/docs/stable/data.html#torch.utils.data.DataLoader"><code>torch.utils.data.DataLoader</code></a>.</p>
<p>Turning our <code>Dataset</code>’s into <code>DataLoader</code>’s makes them iterable so a model can go through learn the relationships between samples and targets (features and labels).</p>
<p>To keep things simple, we’ll use a <code>batch_size=1</code> and <code>num_workers=1</code>.</p>
<p>What’s <code>num_workers</code>?</p>
<p>Good question.</p>
<p>It defines how many subprocesses will be created to load your data.</p>
<p>Think of it like this, the higher value <code>num_workers</code> is set to, the more compute power PyTorch will use to load your data.</p>
<p>Personally, I usually set it to the total number of CPUs on my machine via Python’s <a href="https://docs.python.org/3/library/os.html#os.cpu_count"><code>os.cpu_count()</code></a>.</p>
<p>This ensures the <code>DataLoader</code> recruits as many cores as possible to load data.</p>
<blockquote class="blockquote">
<p><strong>참고:</strong> There are more parameters you can get familiar with using <code>torch.utils.data.DataLoader</code> in the <a href="https://pytorch.org/docs/stable/data.html#torch.utils.data.DataLoader">PyTorch documentation</a>.</p>
</blockquote>
<div id="cell-39" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn train and test Datasets into DataLoaders</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>train_dataloader <span class="op">=</span> DataLoader(dataset<span class="op">=</span>train_data, </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                              batch_size<span class="op">=</span><span class="dv">1</span>, <span class="co"># how many samples per batch?</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                              num_workers<span class="op">=</span><span class="dv">1</span>, <span class="co"># how many subprocesses to use for data loading? (higher = more)</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                              shuffle<span class="op">=</span><span class="va">True</span>) <span class="co"># shuffle the data?</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>test_dataloader <span class="op">=</span> DataLoader(dataset<span class="op">=</span>test_data, </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>                             batch_size<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>                             num_workers<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>                             shuffle<span class="op">=</span><span class="va">False</span>) <span class="co"># don't usually need to shuffle testing data</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>train_dataloader, test_dataloader</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>(&lt;torch.utils.data.dataloader.DataLoader at 0x1fd2cf94fa0&gt;,
 &lt;torch.utils.data.dataloader.DataLoader at 0x1fd2cf94dc0&gt;)</code></pre>
</div>
</div>
<p>Wonderful!</p>
<p>Now our data is iterable.</p>
<p>Let’s try it out and check the shapes.</p>
<div id="cell-41" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>img, label <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(train_dataloader))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Batch size will now be 1, try changing the batch_size parameter above and see what happens</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image shape: </span><span class="sc">{</span>img<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> -&gt; [batch_size, color_channels, height, width]"</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Label shape: </span><span class="sc">{</span>label<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Image shape: torch.Size([1, 3, 64, 64]) -&gt; [batch_size, color_channels, height, width]
Label shape: torch.Size([1])</code></pre>
</div>
</div>
<p>We could now use these <code>DataLoader</code>’s with a training and testing loop to train a model.</p>
<p>But before we do, let’s look at another option to load images (or almost any other kind of data).</p>
</section>
</section>
<section id="option-2-loading-image-data-with-a-custom-dataset" class="level2" data-number="6.9">
<h2 data-number="6.9" class="anchored" data-anchor-id="option-2-loading-image-data-with-a-custom-dataset"><span class="header-section-number">6.9</span> 5. Option 2: Loading Image Data with a Custom <code>Dataset</code></h2>
<p>What if a pre-built <code>Dataset</code> creator like <a href="https://pytorch.org/vision/stable/datasets.html#torchvision.datasets.ImageFolder"><code>torchvision.datasets.ImageFolder()</code></a> didn’t exist?</p>
<p>Or one for your specific problem didn’t exist?</p>
<p>Well, you could build your own.</p>
<p>But wait, what are the pros and cons of creating your own custom way to load <code>Dataset</code>’s?</p>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Pros of creating a custom <code>Dataset</code></th>
<th>Cons of creating a custom <code>Dataset</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Can create a <code>Dataset</code> out of almost anything.</td>
<td>Even though you <em>could</em> create a <code>Dataset</code> out of almost anything, it doesn’t mean it will work.</td>
</tr>
<tr class="even">
<td>Not limited to PyTorch pre-built <code>Dataset</code> functions.</td>
<td>Using a custom <code>Dataset</code> often results in writing more code, which could be prone to errors or performance issues.</td>
</tr>
</tbody>
</table>
<p>To see this in action, let’s work towards replicating <code>torchvision.datasets.ImageFolder()</code> by subclassing <code>torch.utils.data.Dataset</code> (the base class for all <code>Dataset</code>’s in PyTorch).</p>
<p>We’ll start by importing the modules we need: * Python’s <code>os</code> for dealing with directories (our data is stored in directories). * Python’s <code>pathlib</code> for dealing with filepaths (each of our images has a unique filepath). * <code>torch</code> for all things PyTorch. * PIL’s <code>Image</code> class for loading images. * <code>torch.utils.data.Dataset</code> to subclass and create our own custom <code>Dataset</code>. * <code>torchvision.transforms</code> to turn our images into tensors. * Various types from Python’s <code>typing</code> module to add type hints to our code.</p>
<blockquote class="blockquote">
<p><strong>참고:</strong> You can customize the following steps for your own dataset. The premise remains: write code to load your data in the format you’d like it.</p>
</blockquote>
<div id="cell-44" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pathlib</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> transforms</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple, Dict, List</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Remember how our instances of <code>torchvision.datasets.ImageFolder()</code> allowed us to use the <code>classes</code> and <code>class_to_idx</code> attributes?</p>
<div id="cell-46" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instance of torchvision.datasets.ImageFolder()</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>train_data.classes, train_data.class_to_idx</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>(['pizza', 'steak', 'sushi'], {'pizza': 0, 'steak': 1, 'sushi': 2})</code></pre>
</div>
</div>
<section id="creating-a-helper-function-to-get-class-names" class="level3" data-number="6.9.1">
<h3 data-number="6.9.1" class="anchored" data-anchor-id="creating-a-helper-function-to-get-class-names"><span class="header-section-number">6.9.1</span> 5.1 Creating a helper function to get class names</h3>
<p>Let’s write a helper function capable of creating a list of class names and a dictionary of class names and their indexes given a directory path.</p>
<p>To do so, we’ll: 1. Get the class names using <code>os.scandir()</code> to traverse a target directory (ideally the directory is in standard image classification format). 2. Raise an error if the class names aren’t found (if this happens, there might be something wrong with the directory structure). 3. Turn the class names into a dictionary of numerical labels, one for each class.</p>
<p>Let’s see a small example of step 1 before we write the full function.</p>
<div id="cell-48" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup path for target directory</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>target_directory <span class="op">=</span> train_dir</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Target directory: </span><span class="sc">{</span>target_directory<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the class names from the target directory</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>class_names_found <span class="op">=</span> <span class="bu">sorted</span>([entry.name <span class="cf">for</span> entry <span class="kw">in</span> <span class="bu">list</span>(os.scandir(image_path <span class="op">/</span> <span class="st">"train"</span>))])</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Class names found: </span><span class="sc">{</span>class_names_found<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Target directory: data\pizza_steak_sushi\train
Class names found: ['pizza', 'steak', 'sushi']</code></pre>
</div>
</div>
<p>Excellent!</p>
<p>How about we turn it into a full function?</p>
<div id="cell-50" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make function to find classes in target directory</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_classes(directory: <span class="bu">str</span>) <span class="op">-&gt;</span> Tuple[List[<span class="bu">str</span>], Dict[<span class="bu">str</span>, <span class="bu">int</span>]]:</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Finds the class folder names in a target directory.</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Assumes target directory is in standard image classification format.</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co">        directory (str): target directory to load classnames from.</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Tuple[List[str], Dict[str, int]]: (list_of_class_names, dict(class_name: idx...))</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Example:</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co">        find_classes("food_images/train")</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="co">        &gt;&gt;&gt; (["class_1", "class_2"], {"class_1": 0, ...})</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Get the class names by scanning the target directory</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    classes <span class="op">=</span> <span class="bu">sorted</span>(entry.name <span class="cf">for</span> entry <span class="kw">in</span> os.scandir(directory) <span class="cf">if</span> entry.is_dir())</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Raise an error if class names not found</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> classes:</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="ss">f"Couldn't find any classes in </span><span class="sc">{</span>directory<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Crearte a dictionary of index labels (computers prefer numerical rather than string labels)</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    class_to_idx <span class="op">=</span> {cls_name: i <span class="cf">for</span> i, cls_name <span class="kw">in</span> <span class="bu">enumerate</span>(classes)}</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> classes, class_to_idx</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Looking good!</p>
<p>Now let’s test out our <code>find_classes()</code> function.</p>
<div id="cell-52" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>find_classes(train_dir)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>(['pizza', 'steak', 'sushi'], {'pizza': 0, 'steak': 1, 'sushi': 2})</code></pre>
</div>
</div>
<p>Woohoo! Looking good!</p>
</section>
<section id="create-a-custom-dataset-to-replicate-imagefolder" class="level3" data-number="6.9.2">
<h3 data-number="6.9.2" class="anchored" data-anchor-id="create-a-custom-dataset-to-replicate-imagefolder"><span class="header-section-number">6.9.2</span> 5.2 Create a custom <code>Dataset</code> to replicate <code>ImageFolder</code></h3>
<p>Now we’re ready to build our own custom <code>Dataset</code>.</p>
<p>We’ll build one to replicate the functionality of <code>torchvision.datasets.ImageFolder()</code>.</p>
<p>This will be good practice, plus, it’ll reveal a few of the required steps to make your own custom <code>Dataset</code>.</p>
<p>It’ll be a fair bit of a code… but nothing we can’t handle!</p>
<p>Let’s break it down: 1. Subclass <code>torch.utils.data.Dataset</code>. 2. Initialize our subclass with a <code>targ_dir</code> parameter (the target data directory) and <code>transform</code> parameter (so we have the option to transform our data if needed). 3. Create several attributes for <code>paths</code> (the paths of our target images), <code>transform</code> (the transforms we might like to use, this can be <code>None</code>), <code>classes</code> and <code>class_to_idx</code> (from our <code>find_classes()</code> function). 4. Create a function to load images from file and return them, this could be using <code>PIL</code> or <a href="https://pytorch.org/vision/stable/io.html#image"><code>torchvision.io</code></a> (for input/output of vision data). 5. Overwrite the <code>__len__</code> method of <code>torch.utils.data.Dataset</code> to return the number of samples in the <code>Dataset</code>, this is recommended but not required. This is so you can call <code>len(Dataset)</code>. 6. Overwrite the <code>__getitem__</code> method of <code>torch.utils.data.Dataset</code> to return a single sample from the <code>Dataset</code>, this is required.</p>
<p>Let’s do it!</p>
<div id="cell-55" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Write a custom dataset class (inherits from torch.utils.data.Dataset)</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Subclass torch.utils.data.Dataset</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ImageFolderCustom(Dataset):</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Initialize with a targ_dir and transform (optional) parameter</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, targ_dir: <span class="bu">str</span>, transform<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3. Create class attributes</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get all image paths</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.paths <span class="op">=</span> <span class="bu">list</span>(pathlib.Path(targ_dir).glob(<span class="st">"*/*.jpg"</span>)) <span class="co"># note: you'd have to update this if you've got .png's or .jpeg's</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Setup transforms</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.transform <span class="op">=</span> transform</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create classes and class_to_idx attributes</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.classes, <span class="va">self</span>.class_to_idx <span class="op">=</span> find_classes(targ_dir)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Make function to load images</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> load_image(<span class="va">self</span>, index: <span class="bu">int</span>) <span class="op">-&gt;</span> Image.Image:</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Opens an image via a path and returns it."</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>        image_path <span class="op">=</span> <span class="va">self</span>.paths[index]</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Image.<span class="bu">open</span>(image_path) </span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Overwrite the __len__() method (optional but recommended for subclasses of torch.utils.data.Dataset)</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Returns the total number of samples."</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.paths)</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6. Overwrite the __getitem__() method (required for subclasses of torch.utils.data.Dataset)</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, index: <span class="bu">int</span>) <span class="op">-&gt;</span> Tuple[torch.Tensor, <span class="bu">int</span>]:</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Returns one sample of data, data and label (X, y)."</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> <span class="va">self</span>.load_image(index)</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>        class_name  <span class="op">=</span> <span class="va">self</span>.paths[index].parent.name <span class="co"># expects path in data_folder/class_name/image.jpeg</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>        class_idx <span class="op">=</span> <span class="va">self</span>.class_to_idx[class_name]</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Transform if necessary</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.transform:</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.transform(img), class_idx <span class="co"># return data, label (X, y)</span></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> img, class_idx <span class="co"># return data, label (X, y)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Woah! A whole bunch of code to load in our images.</p>
<p>This is one of the downsides of creating your own custom <code>Dataset</code>’s.</p>
<p>However, now we’ve written it once, we could move it into a <code>.py</code> file such as <code>data_loader.py</code> along with some other helpful data functions and reuse it later on.</p>
<p>Before we test out our new <code>ImageFolderCustom</code> class, let’s create some transforms to prepare our images.</p>
<div id="cell-57" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Augment train data</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>train_transforms <span class="op">=</span> transforms.Compose([</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((<span class="dv">64</span>, <span class="dv">64</span>)),</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    transforms.RandomHorizontalFlip(p<span class="op">=</span><span class="fl">0.5</span>),</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor()</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Don't augment test data, only reshape</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>test_transforms <span class="op">=</span> transforms.Compose([</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((<span class="dv">64</span>, <span class="dv">64</span>)),</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor()</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now comes the moment of truth!</p>
<p>Let’s turn our training images (contained in <code>train_dir</code>) and our testing images (contained in <code>test_dir</code>) into <code>Dataset</code>’s using our own <code>ImageFolderCustom</code> class.</p>
<div id="cell-59" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>train_data_custom <span class="op">=</span> ImageFolderCustom(targ_dir<span class="op">=</span>train_dir, </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>                                      transform<span class="op">=</span>train_transforms)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>test_data_custom <span class="op">=</span> ImageFolderCustom(targ_dir<span class="op">=</span>test_dir, </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>                                     transform<span class="op">=</span>test_transforms)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>train_data_custom, test_data_custom</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>(&lt;__main__.ImageFolderCustom at 0x1fd2cf886d0&gt;,
 &lt;__main__.ImageFolderCustom at 0x1fd2cf5a0d0&gt;)</code></pre>
</div>
</div>
<p>Hmm… no errors, did it work?</p>
<p>Let’s try calling <code>len()</code> on our new <code>Dataset</code>’s and find the <code>classes</code> and <code>class_to_idx</code> attributes.</p>
<div id="cell-61" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(train_data_custom), <span class="bu">len</span>(test_data_custom)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>(225, 75)</code></pre>
</div>
</div>
<div id="cell-62" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>train_data_custom.classes</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>['pizza', 'steak', 'sushi']</code></pre>
</div>
</div>
<div id="cell-63" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>train_data_custom.class_to_idx</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>{'pizza': 0, 'steak': 1, 'sushi': 2}</code></pre>
</div>
</div>
<p><code>len(test_data_custom) == len(test_data)</code> and <code>len(test_data_custom) == len(test_data)</code> Yes!!!</p>
<p>It looks like it worked.</p>
<p>We could check for equality with the <code>Dataset</code>’s made by the <code>torchvision.datasets.ImageFolder()</code> class too.</p>
<div id="cell-65" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for equality amongst our custom Dataset and ImageFolder Dataset</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>((<span class="bu">len</span>(train_data_custom) <span class="op">==</span> <span class="bu">len</span>(train_data)) <span class="op">&amp;</span> (<span class="bu">len</span>(test_data_custom) <span class="op">==</span> <span class="bu">len</span>(test_data)))</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train_data_custom.classes <span class="op">==</span> train_data.classes)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train_data_custom.class_to_idx <span class="op">==</span> train_data.class_to_idx)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>True
True
True</code></pre>
</div>
</div>
<p>Ho ho!</p>
<p>Look at us go!</p>
<p>Three <code>True</code>’s!</p>
<p>You can’t get much better than that.</p>
<p>How about we take it up a notch and plot some random images to test our <code>__getitem__</code> override?</p>
</section>
<section id="create-a-function-to-display-random-images" class="level3" data-number="6.9.3">
<h3 data-number="6.9.3" class="anchored" data-anchor-id="create-a-function-to-display-random-images"><span class="header-section-number">6.9.3</span> 5.3 Create a function to display random images</h3>
<p>You know what time it is!</p>
<p>Time to put on our data explorer’s hat and <em>visualize, visualize, visualize!</em></p>
<p>Let’s create a helper function called <code>display_random_images()</code> that helps us visualize images in our <code>Dataset'</code>s.</p>
<p>Specifically, it’ll: 1. Take in a <code>Dataset</code> and a number of other parameters such as <code>classes</code> (the names of our target classes), the number of images to display (<code>n</code>) and a random seed. 2. To prevent the display getting out of hand, we’ll cap <code>n</code> at 10 images. 3. Set the random seed for reproducible plots (if <code>seed</code> is set). 4. Get a list of random sample indexes (we can use Python’s <code>random.sample()</code> for this) to plot. 5. Setup a <code>matplotlib</code> plot. 6. Loop through the random sample indexes found in step 4 and plot them with <code>matplotlib</code>. 7. Make sure the sample images are of shape <code>HWC</code> (height, width, color channels) so we can plot them.</p>
<div id="cell-68" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Take in a Dataset as well as a list of class names</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> display_random_images(dataset: torch.utils.data.dataset.Dataset,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>                          classes: List[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>                          n: <span class="bu">int</span> <span class="op">=</span> <span class="dv">10</span>,</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>                          display_shape: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>                          seed: <span class="bu">int</span> <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Adjust display if n too high</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>        display_shape <span class="op">=</span> <span class="va">False</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"For display purposes, n shouldn't be larger than 10, setting to 10 and removing shape display."</span>)</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Set random seed</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed:</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>        random.seed(seed)</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Get random sample indexes</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>    random_samples_idx <span class="op">=</span> random.sample(<span class="bu">range</span>(<span class="bu">len</span>(dataset)), k<span class="op">=</span>n)</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Setup plot</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">8</span>))</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6. Loop through samples and display random samples </span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, targ_sample <span class="kw">in</span> <span class="bu">enumerate</span>(random_samples_idx):</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>        targ_image, targ_label <span class="op">=</span> dataset[targ_sample][<span class="dv">0</span>], dataset[targ_sample][<span class="dv">1</span>]</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 7. Adjust image tensor shape for plotting: [color_channels, height, width] -&gt; [color_channels, height, width]</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>        targ_image_adjust <span class="op">=</span> targ_image.permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>)</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot adjusted samples</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">1</span>, n, i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>        plt.imshow(targ_image_adjust)</span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>        plt.axis(<span class="st">"off"</span>)</span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> classes:</span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>            title <span class="op">=</span> <span class="ss">f"class: </span><span class="sc">{</span>classes[targ_label]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> display_shape:</span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>                title <span class="op">=</span> title <span class="op">+</span> <span class="ss">f"</span><span class="ch">\n</span><span class="ss">shape: </span><span class="sc">{</span>targ_image_adjust<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>        plt.title(title)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>What a good looking function!</p>
<p>Let’s test it out first with the <code>Dataset</code> we created with <code>torchvision.datasets.ImageFolder()</code>.</p>
<div id="cell-70" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display random images from ImageFolder created Dataset</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>display_random_images(train_data, </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>                      n<span class="op">=</span><span class="dv">5</span>, </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>                      classes<span class="op">=</span>class_names,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>                      seed<span class="op">=</span><span class="va">None</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-34-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>And now with the <code>Dataset</code> we created with our own <code>ImageFolderCustom</code>.</p>
<div id="cell-72" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display random images from ImageFolderCustom Dataset</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>display_random_images(train_data_custom, </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>                      n<span class="op">=</span><span class="dv">12</span>, </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>                      classes<span class="op">=</span>class_names,</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>                      seed<span class="op">=</span><span class="va">None</span>) <span class="co"># Try setting the seed for reproducible images</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>For display purposes, n shouldn't be larger than 10, setting to 10 and removing shape display.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-35-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Nice!!!</p>
<p>Looks like our <code>ImageFolderCustom</code> is working just as we’d like it to.</p>
</section>
<section id="turn-custom-loaded-images-into-dataloaders" class="level3" data-number="6.9.4">
<h3 data-number="6.9.4" class="anchored" data-anchor-id="turn-custom-loaded-images-into-dataloaders"><span class="header-section-number">6.9.4</span> 5.4 Turn custom loaded images into <code>DataLoader</code>’s</h3>
<p>We’ve got a way to turn our raw images into <code>Dataset</code>’s (features mapped to labels or <code>X</code>’s mapped to <code>y</code>’s) through our <code>ImageFolderCustom</code> class.</p>
<p>Now how could we turn our custom <code>Dataset</code>’s into <code>DataLoader</code>’s?</p>
<p>If you guessed by using <code>torch.utils.data.DataLoader()</code>, you’d be right!</p>
<p>Because our custom <code>Dataset</code>’s subclass <code>torch.utils.data.Dataset</code>, we can use them directly with <code>torch.utils.data.DataLoader()</code>.</p>
<p>And we can do using very similar steps to before except this time we’ll be using our custom created <code>Dataset</code>’s.</p>
<div id="cell-75" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn train and test custom Dataset's into DataLoader's</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>train_dataloader_custom <span class="op">=</span> DataLoader(dataset<span class="op">=</span>train_data_custom, <span class="co"># use custom created train Dataset</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>                                     batch_size<span class="op">=</span><span class="dv">1</span>, <span class="co"># how many samples per batch?</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                                     num_workers<span class="op">=</span><span class="dv">0</span>, <span class="co"># how many subprocesses to use for data loading? (higher = more)</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                                     shuffle<span class="op">=</span><span class="va">True</span>) <span class="co"># shuffle the data?</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>test_dataloader_custom <span class="op">=</span> DataLoader(dataset<span class="op">=</span>test_data_custom, <span class="co"># use custom created test Dataset</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                                    batch_size<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>                                    num_workers<span class="op">=</span><span class="dv">0</span>, </span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>                                    shuffle<span class="op">=</span><span class="va">False</span>) <span class="co"># don't usually need to shuffle testing data</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>train_dataloader_custom, test_dataloader_custom</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>(&lt;torch.utils.data.dataloader.DataLoader at 0x1fd2cfabf10&gt;,
 &lt;torch.utils.data.dataloader.DataLoader at 0x1fd2cfabb80&gt;)</code></pre>
</div>
</div>
<p>Do the shapes of the samples look the same?</p>
<div id="cell-77" class="cell" data-execution_count="40">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get image and label from custom DataLoader</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>img_custom, label_custom <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(train_dataloader_custom))</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Batch size will now be 1, try changing the batch_size parameter above and see what happens</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image shape: </span><span class="sc">{</span>img_custom<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> -&gt; [batch_size, color_channels, height, width]"</span>)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Label shape: </span><span class="sc">{</span>label_custom<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Image shape: torch.Size([1, 3, 64, 64]) -&gt; [batch_size, color_channels, height, width]
Label shape: torch.Size([1])</code></pre>
</div>
</div>
<p>They sure do!</p>
<p>Let’s now take a lot at some other forms of data transforms.</p>
</section>
</section>
<section id="other-forms-of-transforms-data-augmentation" class="level2" data-number="6.10">
<h2 data-number="6.10" class="anchored" data-anchor-id="other-forms-of-transforms-data-augmentation"><span class="header-section-number">6.10</span> 6. Other forms of transforms (data augmentation)</h2>
<p>We’ve seen a couple of transforms on our data already but there’s plenty more.</p>
<p>You can see them all in the <a href="https://pytorch.org/vision/stable/transforms.html"><code>torchvision.transforms</code> documentation</a>.</p>
<p>The purpose of tranforms is to alter your images in some way.</p>
<p>That may be turning your images into a tensor (as we’ve seen before).</p>
<p>Or cropping it or randomly erasing a portion or randomly rotating them.</p>
<p>Doing this kinds of transforms is often referred to as <strong>data augmentation</strong>.</p>
<p><strong>Data augmentation</strong> is the process of altering your data in such a way that you <em>artificially</em> increase the diversity of your training set.</p>
<p>Training a model on this <em>artificially</em> altered dataset hopefully results in a model that is capable of better <em>generalization</em> (the patterns it learns are more robust to future unseen examples).</p>
<p>You can see many different examples of data augmentation performed on images using <code>torchvision.transforms</code> in PyTorch’s <a href="https://pytorch.org/vision/main/auto_examples/transforms/plot_transforms_illustrations.html">Illustration of Transforms example</a>.</p>
<p>But let’s try one out ourselves.</p>
<p>Machine learning is all about harnessing the power of randomness and research shows that random transforms (like <a href="https://pytorch.org/vision/stable/auto_examples/plot_transforms.html#randaugment"><code>transforms.RandAugment()</code></a> and <a href="https://pytorch.org/vision/stable/auto_examples/plot_transforms.html#trivialaugmentwide"><code>transforms.TrivialAugmentWide()</code></a>) generally perform better than hand-picked transforms.</p>
<p>The idea behind <a href="https://arxiv.org/abs/2103.10158">TrivialAugment</a> is… well, trivial.</p>
<p>You have a set of transforms and you randomly pick a number of them to perform on an image and at a random magnitude between a given range (a higher magnitude means more instense).</p>
<p>The PyTorch team even <a href="https://pytorch.org/blog/how-to-train-state-of-the-art-models-using-torchvision-latest-primitives/#break-down-of-key-accuracy-improvements">used TrivialAugment it to train their latest state-of-the-art vision models</a>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/04-trivial-augment-being-using-in-PyTorch-resize.png" class="img-fluid figure-img"></p>
<figcaption>trivial augment data augmentation being used for PyTorch state of the art training</figcaption>
</figure>
</div>
<p><em>TrivialAugment was one of the ingredients used in a recent state of the art training upgrade to various PyTorch vision models.</em></p>
<p>How about we test it out on some of our own images?</p>
<p>The main parameter to pay attention to in <code>transforms.TrivialAugmentWide()</code> is <code>num_magnitude_bins=31</code>.</p>
<p>It defines how much of a range an intensity value will be picked to apply a certain transform, <code>0</code> being no range and <code>31</code> being maximum range (highest chance for highest intensity).</p>
<p>We can incorporate <code>transforms.TrivialAugmentWide()</code> into <code>transforms.Compose()</code>.</p>
<div id="cell-80" class="cell" data-execution_count="41">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> transforms</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>train_transforms <span class="op">=</span> transforms.Compose([</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((<span class="dv">224</span>, <span class="dv">224</span>)),</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    transforms.TrivialAugmentWide(num_magnitude_bins<span class="op">=</span><span class="dv">31</span>), <span class="co"># how intense </span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor() <span class="co"># use ToTensor() last to get everything between 0 &amp; 1</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Don't need to perform augmentation on the test data</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>test_transforms <span class="op">=</span> transforms.Compose([</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((<span class="dv">224</span>, <span class="dv">224</span>)), </span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor()</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<blockquote class="blockquote">
<p><strong>참고:</strong> You usually don’t perform data augmentation on the test set. The idea of data augmentation is to to <em>artificially</em> increase the diversity of the training set to better predict on the testing set.</p>
<p>However, you do need to make sure your test set images are transformed to tensors. We size the test images to the same size as our training images too, however, inference can be done on different size images if necessary (though this may alter performance).</p>
</blockquote>
<p>Beautiful, now we’ve got a training transform (with data augmentation) and test transform (without data augmentation).</p>
<p>Let’s test our data augmentation out!</p>
<div id="cell-82" class="cell" data-execution_count="42">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get all image paths</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>image_path_list <span class="op">=</span> <span class="bu">list</span>(image_path.glob(<span class="st">"*/*/*.jpg"</span>))</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot random images</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>plot_transformed_images(</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    image_paths<span class="op">=</span>image_path_list,</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    transform<span class="op">=</span>train_transforms,</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    n<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    seed<span class="op">=</span><span class="va">None</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-39-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-39-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-39-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Try running the cell above a few times and seeing how the original image changes as it goes through the transform.</p>
</section>
<section id="model-0-tinyvgg-without-data-augmentation" class="level2" data-number="6.11">
<h2 data-number="6.11" class="anchored" data-anchor-id="model-0-tinyvgg-without-data-augmentation"><span class="header-section-number">6.11</span> 7. Model 0: TinyVGG without data augmentation</h2>
<p>Alright, we’ve seen how to turn our data from images in folders to transformed tensors.</p>
<p>Now let’s construct a computer vision model to see if we can classify if an image is of pizza, steak or sushi.</p>
<p>To begin, we’ll start with a simple transform, only resizing the images to <code>(64, 64)</code> and turning them into tensors.</p>
<section id="creating-transforms-and-loading-data-for-model-0" class="level3" data-number="6.11.1">
<h3 data-number="6.11.1" class="anchored" data-anchor-id="creating-transforms-and-loading-data-for-model-0"><span class="header-section-number">6.11.1</span> 7.1 Creating transforms and loading data for Model 0</h3>
<div id="cell-86" class="cell" data-execution_count="43">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create simple transform</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>simple_transform <span class="op">=</span> transforms.Compose([ </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((<span class="dv">64</span>, <span class="dv">64</span>)),</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor(),</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Excellent, now we’ve got a simple transform, let’s: 1. Load the data, turning each of our training and test folders first into a <code>Dataset</code> with <code>torchvision.datasets.ImageFolder()</code> 2. Then into a <code>DataLoader</code> using <code>torch.utils.data.DataLoader()</code>. * We’ll set the <code>batch_size=32</code> and <code>num_workers</code> to as many CPUs on our machine (this will depend on what machine you’re using).</p>
<div id="cell-88" class="cell" data-execution_count="44">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Load and transform data</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> datasets</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>train_data_simple <span class="op">=</span> datasets.ImageFolder(root<span class="op">=</span>train_dir, transform<span class="op">=</span>simple_transform)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>test_data_simple <span class="op">=</span> datasets.ImageFolder(root<span class="op">=</span>test_dir, transform<span class="op">=</span>simple_transform)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Turn data into DataLoaders</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup batch size and number of workers </span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>NUM_WORKERS <span class="op">=</span> os.cpu_count()</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Creating DataLoader's with batch size </span><span class="sc">{</span>BATCH_SIZE<span class="sc">}</span><span class="ss"> and </span><span class="sc">{</span>NUM_WORKERS<span class="sc">}</span><span class="ss"> workers."</span>)</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataLoader's</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>train_dataloader_simple <span class="op">=</span> DataLoader(train_data_simple, </span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>                                     batch_size<span class="op">=</span>BATCH_SIZE, </span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>                                     shuffle<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>                                     num_workers<span class="op">=</span>NUM_WORKERS)</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>test_dataloader_simple <span class="op">=</span> DataLoader(test_data_simple, </span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>                                    batch_size<span class="op">=</span>BATCH_SIZE, </span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>                                    shuffle<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>                                    num_workers<span class="op">=</span>NUM_WORKERS)</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>train_dataloader_simple, test_dataloader_simple</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating DataLoader's with batch size 32 and 16 workers.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>(&lt;torch.utils.data.dataloader.DataLoader at 0x1fd2ce5c4f0&gt;,
 &lt;torch.utils.data.dataloader.DataLoader at 0x1fd1d0e10d0&gt;)</code></pre>
</div>
</div>
<p><code>DataLoader</code>’s created!</p>
<p>Let’s build a model.</p>
</section>
<section id="create-tinyvgg-model-class" class="level3" data-number="6.11.2">
<h3 data-number="6.11.2" class="anchored" data-anchor-id="create-tinyvgg-model-class"><span class="header-section-number">6.11.2</span> 7.2 Create TinyVGG model class</h3>
<p>In <a href="https://www.learnpytorch.io/03_pytorch_computer_vision/#7-model-2-building-a-convolutional-neural-network-cnn">notebook 03</a>, we used the TinyVGG model from the <a href="https://poloclub.github.io/cnn-explainer/">CNN Explainer website</a>.</p>
<p>Let’s recreate the same model, except this time we’ll be using color images instead of grayscale (<code>in_channels=3</code> instead of <code>in_channels=1</code> for RGB pixels).</p>
<div id="cell-91" class="cell" data-execution_count="45">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TinyVGG(nn.Module):</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Model architecture copying TinyVGG from: </span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="co">    https://poloclub.github.io/cnn-explainer/</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_shape: <span class="bu">int</span>, hidden_units: <span class="bu">int</span>, output_shape: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv_block_1 <span class="op">=</span> nn.Sequential(</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>            nn.Conv2d(in_channels<span class="op">=</span>input_shape, </span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>                      out_channels<span class="op">=</span>hidden_units, </span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>                      kernel_size<span class="op">=</span><span class="dv">3</span>, <span class="co"># how big is the square that's going over the image?</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>                      stride<span class="op">=</span><span class="dv">1</span>, <span class="co"># default</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>                      padding<span class="op">=</span><span class="dv">1</span>), <span class="co"># options = "valid" (no padding) or "same" (output has same shape as input) or int for specific number </span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>            nn.Conv2d(in_channels<span class="op">=</span>hidden_units, </span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>                      out_channels<span class="op">=</span>hidden_units,</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>                      kernel_size<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>                      stride<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>                      padding<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>            nn.MaxPool2d(kernel_size<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>                         stride<span class="op">=</span><span class="dv">2</span>) <span class="co"># default stride value is same as kernel_size</span></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv_block_2 <span class="op">=</span> nn.Sequential(</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>            nn.Conv2d(hidden_units, hidden_units, kernel_size<span class="op">=</span><span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>            nn.Conv2d(hidden_units, hidden_units, kernel_size<span class="op">=</span><span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>            nn.MaxPool2d(<span class="dv">2</span>)</span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.classifier <span class="op">=</span> nn.Sequential(</span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>            nn.Flatten(),</span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Where did this in_features shape come from? </span></span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># It's because each layer of our network compresses and changes the shape of our inputs data.</span></span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>            nn.Linear(in_features<span class="op">=</span>hidden_units<span class="op">*</span><span class="dv">16</span><span class="op">*</span><span class="dv">16</span>,</span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a>                      out_features<span class="op">=</span>output_shape)</span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x: torch.Tensor):</span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.conv_block_1(x)</span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(x.shape)</span></span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.conv_block_2(x)</span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(x.shape)</span></span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.classifier(x)</span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(x.shape)</span></span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb69-47"><a href="#cb69-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return self.classifier(self.conv_block_2(self.conv_block_1(x))) # &lt;- leverage the benefits of operator fusion</span></span>
<span id="cb69-48"><a href="#cb69-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-49"><a href="#cb69-49" aria-hidden="true" tabindex="-1"></a>torch.manual_seed(<span class="dv">42</span>)</span>
<span id="cb69-50"><a href="#cb69-50" aria-hidden="true" tabindex="-1"></a>model_0 <span class="op">=</span> TinyVGG(input_shape<span class="op">=</span><span class="dv">3</span>, <span class="co"># number of color channels (3 for RGB) </span></span>
<span id="cb69-51"><a href="#cb69-51" aria-hidden="true" tabindex="-1"></a>                  hidden_units<span class="op">=</span><span class="dv">10</span>, </span>
<span id="cb69-52"><a href="#cb69-52" aria-hidden="true" tabindex="-1"></a>                  output_shape<span class="op">=</span><span class="bu">len</span>(train_data.classes)).to(device)</span>
<span id="cb69-53"><a href="#cb69-53" aria-hidden="true" tabindex="-1"></a>model_0</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>TinyVGG(
  (conv_block_1): Sequential(
    (0): Conv2d(3, 10, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (1): ReLU()
    (2): Conv2d(10, 10, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (3): ReLU()
    (4): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
  )
  (conv_block_2): Sequential(
    (0): Conv2d(10, 10, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (1): ReLU()
    (2): Conv2d(10, 10, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (3): ReLU()
    (4): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
  )
  (classifier): Sequential(
    (0): Flatten(start_dim=1, end_dim=-1)
    (1): Linear(in_features=2560, out_features=3, bias=True)
  )
)</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p><strong>참고:</strong> One of the ways to speed up deep learning models computing on a GPU is to leverage <strong>operator fusion</strong>.</p>
<p>This means in the <code>forward()</code> method in our model above, instead of calling a layer block and reassigning <code>x</code> every time, we call each block in succession (see the final line of the <code>forward()</code> method in the model above for an example).</p>
<p>This saves the time spent reassigning <code>x</code> (memory heavy) and focuses on only computing on <code>x</code>.</p>
<p>See <a href="https://horace.io/brrr_intro.html"><em>Making Deep Learning Go Brrrr From First Principles</em></a> by Horace He for more ways on how to speed up machine learning models.</p>
</blockquote>
<p>Now that’s a nice looking model!</p>
<p>How about we test it out with a forward pass on a single image?</p>
</section>
<section id="try-a-forward-pass-on-a-single-image-to-test-the-model" class="level3" data-number="6.11.3">
<h3 data-number="6.11.3" class="anchored" data-anchor-id="try-a-forward-pass-on-a-single-image-to-test-the-model"><span class="header-section-number">6.11.3</span> 7.3 Try a forward pass on a single image (to test the model)</h3>
<p>A good way to test a model is to do a forward pass on a single piece of data.</p>
<p>It’s also handy way to test the input and output shapes of our different layers.</p>
<p>To do a forward pass on a single image, let’s: 1. Get a batch of images and labels from the <code>DataLoader</code>. 2. Get a single image from the batch and <code>unsqueeze()</code> the image so it has a batch size of <code>1</code> (so its shape fits the model). 3. Perform inference on a single image (making sure to send the image to the target <code>device</code>). 4. Print out what’s happening and convert the model’s raw output logits to prediction probabilities with <code>torch.softmax()</code> (since we’re working with multi-class data) and convert the prediction probabilities to prediction labels with <code>torch.argmax()</code>.</p>
<div id="cell-94" class="cell" data-execution_count="46">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Get a batch of images and labels from the DataLoader</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>img_batch, label_batch <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(train_dataloader_simple))</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Get a single image from the batch and unsqueeze the image so its shape fits the model</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>img_single, label_single <span class="op">=</span> img_batch[<span class="dv">0</span>].unsqueeze(dim<span class="op">=</span><span class="dv">0</span>), label_batch[<span class="dv">0</span>]</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Single image shape: </span><span class="sc">{</span>img_single<span class="sc">.</span>shape<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Perform a forward pass on a single image</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>model_0.<span class="bu">eval</span>()</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.inference_mode():</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>    pred <span class="op">=</span> model_0(img_single.to(device))</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Print out what's happening and convert model logits -&gt; pred probs -&gt; pred label</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Output logits:</span><span class="ch">\n</span><span class="sc">{</span>pred<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Output prediction probabilities:</span><span class="ch">\n</span><span class="sc">{</span>torch<span class="sc">.</span>softmax(pred, dim<span class="op">=</span><span class="dv">1</span>)<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Output prediction label:</span><span class="ch">\n</span><span class="sc">{</span>torch<span class="sc">.</span>argmax(torch.softmax(pred, dim<span class="op">=</span><span class="dv">1</span>), dim<span class="op">=</span><span class="dv">1</span>)<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Actual label:</span><span class="ch">\n</span><span class="sc">{</span>label_single<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Single image shape: torch.Size([1, 3, 64, 64])

Output logits:
tensor([[0.0578, 0.0635, 0.0352]], device='cuda:0')

Output prediction probabilities:
tensor([[0.3352, 0.3371, 0.3277]], device='cuda:0')

Output prediction label:
tensor([1], device='cuda:0')

Actual label:
2</code></pre>
</div>
</div>
<p>Wonderful, it looks like our model is outputting what we’d expect it to output.</p>
<p>You can run the cell above a few times and each time have a different image be predicted on.</p>
<p>And you’ll probably notice the predictions are often wrong.</p>
<p>This is to be expected because the model hasn’t been trained yet and it’s essentially guessing using random weights.</p>
</section>
<section id="use-torchinfo-to-get-an-idea-of-the-shapes-going-through-our-model" class="level3" data-number="6.11.4">
<h3 data-number="6.11.4" class="anchored" data-anchor-id="use-torchinfo-to-get-an-idea-of-the-shapes-going-through-our-model"><span class="header-section-number">6.11.4</span> 7.4 Use <code>torchinfo</code> to get an idea of the shapes going through our model</h3>
<p>Printing out our model with <code>print(model)</code> gives us an idea of what’s going on with our model.</p>
<p>And we can print out the shapes of our data throughout the <code>forward()</code> method.</p>
<p>However, a helpful way to get information from our model is to use <a href="https://github.com/TylerYep/torchinfo"><code>torchinfo</code></a>.</p>
<p><code>torchinfo</code> comes with a <code>summary()</code> method that takes a PyTorch model as well as an <code>input_shape</code> and returns what happens as a tensor moves through your model.</p>
<blockquote class="blockquote">
<p><strong>참고:</strong> If you’re using Google Colab, you’ll need to install <code>torchinfo</code>.</p>
</blockquote>
<div id="cell-97" class="cell" data-execution_count="47">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install torchinfo if it's not available, import it if it is</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: </span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> torchinfo</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>pip install torchinfo</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> torchinfo</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchinfo <span class="im">import</span> summary</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>summary(model_0, input_size<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">64</span>, <span class="dv">64</span>]) <span class="co"># do a test pass through of an example input size </span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Collecting torchinfo
  Downloading torchinfo-1.6.5-py3-none-any.whl (21 kB)
Installing collected packages: torchinfo
Successfully installed torchinfo-1.6.5</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>==========================================================================================
Layer (type:depth-idx)                   Output Shape              Param #
==========================================================================================
TinyVGG                                  --                        --
├─Sequential: 1-1                        [1, 10, 32, 32]           --
│    └─Conv2d: 2-1                       [1, 10, 64, 64]           280
│    └─ReLU: 2-2                         [1, 10, 64, 64]           --
│    └─Conv2d: 2-3                       [1, 10, 64, 64]           910
│    └─ReLU: 2-4                         [1, 10, 64, 64]           --
│    └─MaxPool2d: 2-5                    [1, 10, 32, 32]           --
├─Sequential: 1-2                        [1, 10, 16, 16]           --
│    └─Conv2d: 2-6                       [1, 10, 32, 32]           910
│    └─ReLU: 2-7                         [1, 10, 32, 32]           --
│    └─Conv2d: 2-8                       [1, 10, 32, 32]           910
│    └─ReLU: 2-9                         [1, 10, 32, 32]           --
│    └─MaxPool2d: 2-10                   [1, 10, 16, 16]           --
├─Sequential: 1-3                        [1, 3]                    --
│    └─Flatten: 2-11                     [1, 2560]                 --
│    └─Linear: 2-12                      [1, 3]                    7,683
==========================================================================================
Total params: 10,693
Trainable params: 10,693
Non-trainable params: 0
Total mult-adds (M): 6.75
==========================================================================================
Input size (MB): 0.05
Forward/backward pass size (MB): 0.82
Params size (MB): 0.04
Estimated Total Size (MB): 0.91
==========================================================================================</code></pre>
</div>
</div>
<p>Nice!</p>
<p>The output of <code>torchinfo.summary()</code> gives us a whole bunch of information about our model.</p>
<p>Such as <code>Total params</code>, the total number of parameters in our model, the <code>Estimated Total Size (MB)</code> which is the size of our model.</p>
<p>You can also see the change in input and output shapes as data of a certain <code>input_size</code> moves through our model.</p>
<p>Right now, our parameter numbers and total model size is low.</p>
<p>This because we’re starting with a small model.</p>
<p>And if we need to increase its size later, we can.</p>
</section>
<section id="create-train-test-loop-functions" class="level3" data-number="6.11.5">
<h3 data-number="6.11.5" class="anchored" data-anchor-id="create-train-test-loop-functions"><span class="header-section-number">6.11.5</span> 7.5 Create train &amp; test loop functions</h3>
<p>We’ve got data and we’ve got a model.</p>
<p>Now let’s make some training and test loop functions to train our model on the training data and evaluate our model on the testing data.</p>
<p>And to make sure we can use these the training and testing loops again, we’ll functionize them.</p>
<p>Specifically, we’re going to make three functions: 1. <code>train_step()</code> - takes in a model, a <code>DataLoader</code>, a loss function and an optimizer and trains the model on the <code>DataLoader</code>. 2. <code>test_step()</code> - takes in a model, a <code>DataLoader</code> and a loss function and evaluates the model on the <code>DataLoader</code>. 3. <code>train()</code> - performs 1. and 2. together for a given number of epochs and returns a results dictionary.</p>
<blockquote class="blockquote">
<p><strong>참고:</strong> We covered the steps in a PyTorch opimization loop in <a href="https://www.learnpytorch.io/01_pytorch_workflow/#creating-an-optimization-loop-in-pytorch">notebook 01</a>, as well as the<a href="https://youtu.be/Nutpusq_AFw">Unofficial PyTorch Optimization Loop Song</a> and we’ve built similar functions in <a href="https://www.learnpytorch.io/03_pytorch_computer_vision/#62-functionizing-training-and-test-loops">notebook 03</a>.</p>
</blockquote>
<p>Let’s start by building <code>train_step()</code>.</p>
<p>Because we’re dealing with batches in the <code>DataLoader</code>’s, we’ll accumulate the model loss and accuracy values during training (by adding them up for each batch) and then adjust them at the end before we return them.</p>
<div id="cell-100" class="cell" data-execution_count="48">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_step(model: torch.nn.Module, </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>               dataloader: torch.utils.data.DataLoader, </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>               loss_fn: torch.nn.Module, </span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>               optimizer: torch.optim.Optimizer):</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Put model in train mode</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    model.train()</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup train loss and train accuracy values</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>    train_loss, train_acc <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through data loader data batches</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch, (X, y) <span class="kw">in</span> <span class="bu">enumerate</span>(dataloader):</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Send data to target device</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>        X, y <span class="op">=</span> X.to(device), y.to(device)</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1. Forward pass</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model(X)</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2. Calculate  and accumulate loss</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> loss_fn(y_pred, y)</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">+=</span> loss.item() </span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3. Optimizer zero grad</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad()</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 4. Loss backward</span></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 5. Optimizer step</span></span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate and accumulate accuracy metric across all batches</span></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>        y_pred_class <span class="op">=</span> torch.argmax(torch.softmax(y_pred, dim<span class="op">=</span><span class="dv">1</span>), dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>        train_acc <span class="op">+=</span> (y_pred_class <span class="op">==</span> y).<span class="bu">sum</span>().item()<span class="op">/</span><span class="bu">len</span>(y_pred)</span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust metrics to get average loss and accuracy per batch </span></span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a>    train_loss <span class="op">=</span> train_loss <span class="op">/</span> <span class="bu">len</span>(dataloader)</span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a>    train_acc <span class="op">=</span> train_acc <span class="op">/</span> <span class="bu">len</span>(dataloader)</span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_loss, train_acc</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Woohoo! <code>train_step()</code> function done.</p>
<p>Now let’s do the same for the <code>test_step()</code> function.</p>
<p>The main difference here will be the <code>test_step()</code> won’t take in an optimizer and therefore won’t perform gradient descent.</p>
<p>But since we’ll be doing inference, we’ll make sure to turn on the <code>torch.inference_mode()</code> context manager for making predictions.</p>
<div id="cell-102" class="cell" data-execution_count="49">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_step(model: torch.nn.Module, </span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>              dataloader: torch.utils.data.DataLoader, </span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>              loss_fn: torch.nn.Module):</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Put model in eval mode</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>() </span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup test loss and test accuracy values</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    test_loss, test_acc <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turn on inference context manager</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.inference_mode():</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Loop through DataLoader batches</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch, (X, y) <span class="kw">in</span> <span class="bu">enumerate</span>(dataloader):</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Send data to target device</span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>            X, y <span class="op">=</span> X.to(device), y.to(device)</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 1. Forward pass</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>            test_pred_logits <span class="op">=</span> model(X)</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 2. Calculate and accumulate loss</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> loss_fn(test_pred_logits, y)</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>            test_loss <span class="op">+=</span> loss.item()</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate and accumulate accuracy</span></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>            test_pred_labels <span class="op">=</span> test_pred_logits.argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>            test_acc <span class="op">+=</span> ((test_pred_labels <span class="op">==</span> y).<span class="bu">sum</span>().item()<span class="op">/</span><span class="bu">len</span>(test_pred_labels))</span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust metrics to get average loss and accuracy per batch </span></span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>    test_loss <span class="op">=</span> test_loss <span class="op">/</span> <span class="bu">len</span>(dataloader)</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>    test_acc <span class="op">=</span> test_acc <span class="op">/</span> <span class="bu">len</span>(dataloader)</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> test_loss, test_acc</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Excellent!</p>
</section>
<section id="creating-a-train-function-to-combine-train_step-and-test_step" class="level3" data-number="6.11.6">
<h3 data-number="6.11.6" class="anchored" data-anchor-id="creating-a-train-function-to-combine-train_step-and-test_step"><span class="header-section-number">6.11.6</span> 7.6 Creating a <code>train()</code> function to combine <code>train_step()</code> and <code>test_step()</code></h3>
<p>Now we need a way to put our <code>train_step()</code> and <code>test_step()</code> functions together.</p>
<p>To do so, we’ll package them up in a <code>train()</code> function.</p>
<p>This function will train the model as well as evaluate it.</p>
<p>Specificially, it’ll: 1. Take in a model, a <code>DataLoader</code> for training and test sets, an optimizer, a loss function and how many epochs to perform each train and test step for. 2. Create an empty results dictionary for <code>train_loss</code>, <code>train_acc</code>, <code>test_loss</code> and <code>test_acc</code> values (we can fill this up as training goes on). 3. Loop through the training and test step functions for a number of epochs. 4. Print out what’s happening at the end of each epoch. 5. Update the empty results dictionary with the updated metrics each epoch. 6. Return the filled</p>
<p>To keep track of the number of epochs we’ve been through, let’s import <code>tqdm</code> from <code>tqdm.auto</code> (<a href="https://github.com/tqdm/tqdm"><code>tqdm</code></a> is one of the most popular progress bar libraries for Python and <code>tqdm.auto</code> automatically decides what kind of progress bar is best for your computing environment, e.g.&nbsp;Jupyter Notebook vs.&nbsp;Python script).</p>
<div id="cell-105" class="cell" data-execution_count="50">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Take in various parameters required for training and test steps</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(model: torch.nn.Module, </span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>          train_dataloader: torch.utils.data.DataLoader, </span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>          test_dataloader: torch.utils.data.DataLoader, </span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>          optimizer: torch.optim.Optimizer,</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>          loss_fn: torch.nn.Module <span class="op">=</span> nn.CrossEntropyLoss(),</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>          epochs: <span class="bu">int</span> <span class="op">=</span> <span class="dv">5</span>):</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Create empty results dictionary</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {<span class="st">"train_loss"</span>: [],</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"train_acc"</span>: [],</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"test_loss"</span>: [],</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"test_acc"</span>: []</span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Loop through training and testing steps for a number of epochs</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(epochs)):</span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>        train_loss, train_acc <span class="op">=</span> train_step(model<span class="op">=</span>model,</span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>                                           dataloader<span class="op">=</span>train_dataloader,</span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>                                           loss_fn<span class="op">=</span>loss_fn,</span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>                                           optimizer<span class="op">=</span>optimizer)</span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>        test_loss, test_acc <span class="op">=</span> test_step(model<span class="op">=</span>model,</span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>            dataloader<span class="op">=</span>test_dataloader,</span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>            loss_fn<span class="op">=</span>loss_fn)</span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 4. Print out what's happening</span></span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(</span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"Epoch: </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss"> | "</span></span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"train_loss: </span><span class="sc">{</span>train_loss<span class="sc">:.4f}</span><span class="ss"> | "</span></span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"train_acc: </span><span class="sc">{</span>train_acc<span class="sc">:.4f}</span><span class="ss"> | "</span></span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"test_loss: </span><span class="sc">{</span>test_loss<span class="sc">:.4f}</span><span class="ss"> | "</span></span>
<span id="cb78-34"><a href="#cb78-34" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"test_acc: </span><span class="sc">{</span>test_acc<span class="sc">:.4f}</span><span class="ss">"</span></span>
<span id="cb78-35"><a href="#cb78-35" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb78-36"><a href="#cb78-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-37"><a href="#cb78-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 5. Update results dictionary</span></span>
<span id="cb78-38"><a href="#cb78-38" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"train_loss"</span>].append(train_loss)</span>
<span id="cb78-39"><a href="#cb78-39" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"train_acc"</span>].append(train_acc)</span>
<span id="cb78-40"><a href="#cb78-40" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"test_loss"</span>].append(test_loss)</span>
<span id="cb78-41"><a href="#cb78-41" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"test_acc"</span>].append(test_acc)</span>
<span id="cb78-42"><a href="#cb78-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-43"><a href="#cb78-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6. Return the filled results at the end of the epochs</span></span>
<span id="cb78-44"><a href="#cb78-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="train-and-evaluate-model-0" class="level3" data-number="6.11.7">
<h3 data-number="6.11.7" class="anchored" data-anchor-id="train-and-evaluate-model-0"><span class="header-section-number">6.11.7</span> 7.7 Train and Evaluate Model 0</h3>
<p>Alright, alright, alright we’ve got all of the ingredients we need to train and evaluate our model.</p>
<p>Time to put our <code>TinyVGG</code> model, <code>DataLoader</code>’s and <code>train()</code> function together to see if we can build a model capable of discerning between pizza, steak and sushi!</p>
<p>Let’s recreate <code>model_0</code> (we don’t need to but we will for completeness) then call our <code>train()</code> function passing in the necessary parameters.</p>
<p>To keep our experiments quick, we’ll train our model for <strong>5 epochs</strong> (though you could increase this if you want).</p>
<p>As for an <strong>optimizer</strong> and <strong>loss function</strong>, we’ll use <code>torch.nn.CrossEntropyLoss()</code> (since we’re working with multi-class classification data) and <code>torch.optim.Adam()</code> with a learning rate of <code>1e-3</code> respecitvely.</p>
<p>To see how long things take, we’ll import Python’s <a href="https://docs.python.org/3/library/timeit.html#timeit.default_timer"><code>timeit.default_timer()</code></a> method to calculate the training time.</p>
<div id="cell-107" class="cell" data-execution_count="51">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set random seeds</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>torch.manual_seed(<span class="dv">42</span>) </span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>torch.cuda.manual_seed(<span class="dv">42</span>)</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set number of epochs</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>NUM_EPOCHS <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Recreate an instance of TinyVGG</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>model_0 <span class="op">=</span> TinyVGG(input_shape<span class="op">=</span><span class="dv">3</span>, <span class="co"># number of color channels (3 for RGB) </span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>                  hidden_units<span class="op">=</span><span class="dv">10</span>, </span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>                  output_shape<span class="op">=</span><span class="bu">len</span>(train_data.classes)).to(device)</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup loss function and optimizer</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(params<span class="op">=</span>model_0.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Start the timer</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> default_timer <span class="im">as</span> timer </span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> timer()</span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Train model_0 </span></span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>model_0_results <span class="op">=</span> train(model<span class="op">=</span>model_0, </span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>                        train_dataloader<span class="op">=</span>train_dataloader_simple,</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>                        test_dataloader<span class="op">=</span>test_dataloader_simple,</span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>                        optimizer<span class="op">=</span>optimizer,</span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>                        loss_fn<span class="op">=</span>loss_fn, </span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>                        epochs<span class="op">=</span>NUM_EPOCHS)</span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a><span class="co"># End the timer and print out how long it took</span></span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a>end_time <span class="op">=</span> timer()</span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total training time: </span><span class="sc">{</span>end_time<span class="op">-</span>start_time<span class="sc">:.3f}</span><span class="ss"> seconds"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2c85ff44df474e51864e685699d375e9","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch: 1 | train_loss: 1.1078 | train_acc: 0.2578 | test_loss: 1.1360 | test_acc: 0.2604
Epoch: 2 | train_loss: 1.0847 | train_acc: 0.4258 | test_loss: 1.1620 | test_acc: 0.1979
Epoch: 3 | train_loss: 1.1157 | train_acc: 0.2930 | test_loss: 1.1695 | test_acc: 0.1979
Epoch: 4 | train_loss: 1.0955 | train_acc: 0.4141 | test_loss: 1.1380 | test_acc: 0.1979
Epoch: 5 | train_loss: 1.0985 | train_acc: 0.2930 | test_loss: 1.1420 | test_acc: 0.1979
Total training time: 65.122 seconds</code></pre>
</div>
</div>
<p>Hmm…</p>
<p>It looks like our model performed pretty poorly.</p>
<p>But that’s okay for now, we’ll keep persevering.</p>
<p>What are some ways you could potentially improve it?</p>
<blockquote class="blockquote">
<p><strong>참고:</strong> Check out the <a href="https://www.learnpytorch.io/02_pytorch_classification/#5-improving-a-model-from-a-model-perspective"><em>Improving a model (from a model perspective)</em> section in notebook 02</a> for ideas on improving our TinyVGG model.</p>
</blockquote>
</section>
<section id="plot-the-loss-curves-of-model-0" class="level3" data-number="6.11.8">
<h3 data-number="6.11.8" class="anchored" data-anchor-id="plot-the-loss-curves-of-model-0"><span class="header-section-number">6.11.8</span> 7.8 Plot the loss curves of Model 0</h3>
<p>From the print outs of our <code>model_0</code> training, it didn’t look like it did too well.</p>
<p>But we can further evaluate it by plotting the model’s <strong>loss curves</strong>.</p>
<p><strong>Loss curves</strong> show the model’s results over time.</p>
<p>And they’re a great way to see how your model performs on different datasets (e.g.&nbsp;training and test).</p>
<p>Let’s create a function to plot the values in our <code>model_0_results</code> dictionary.</p>
<div id="cell-110" class="cell" data-execution_count="52">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the model_0_results keys</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>model_0_results.keys()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>dict_keys(['train_loss', 'train_acc', 'test_loss', 'test_acc'])</code></pre>
</div>
</div>
<p>We’ll need to extract each of these keys and turn them into a plot.</p>
<div id="cell-112" class="cell" data-execution_count="53">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_loss_curves(results: Dict[<span class="bu">str</span>, List[<span class="bu">float</span>]]):</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plots training curves of a results dictionary.</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="co">        results (dict): dictionary containing list of values, e.g.</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="co">            {"train_loss": [...],</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="co">             "train_acc": [...],</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="co">             "test_loss": [...],</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="co">             "test_acc": [...]}</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the loss values of the results dictionary (training and test)</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> results[<span class="st">'train_loss'</span>]</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>    test_loss <span class="op">=</span> results[<span class="st">'test_loss'</span>]</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the accuracy values of the results dictionary (training and test)</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> results[<span class="st">'train_acc'</span>]</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>    test_accuracy <span class="op">=</span> results[<span class="st">'test_acc'</span>]</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Figure out how many epochs there were</span></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>    epochs <span class="op">=</span> <span class="bu">range</span>(<span class="bu">len</span>(results[<span class="st">'train_loss'</span>]))</span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup a plot </span></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">7</span>))</span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot loss</span></span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>    plt.plot(epochs, loss, label<span class="op">=</span><span class="st">'train_loss'</span>)</span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>    plt.plot(epochs, test_loss, label<span class="op">=</span><span class="st">'test_loss'</span>)</span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Loss'</span>)</span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Epochs'</span>)</span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot accuracy</span></span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a>    plt.plot(epochs, accuracy, label<span class="op">=</span><span class="st">'train_accuracy'</span>)</span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a>    plt.plot(epochs, test_accuracy, label<span class="op">=</span><span class="st">'test_accuracy'</span>)</span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Accuracy'</span>)</span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Epochs'</span>)</span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true" tabindex="-1"></a>    plt.legend()<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Okay, let’s test our <code>plot_loss_curves()</code> function out.</p>
<div id="cell-114" class="cell" data-execution_count="54">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>plot_loss_curves(model_0_results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-51-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Woah.</p>
<p>Looks like things are all over the place…</p>
<p>But we kind of knew that because our model’s print out results during training didn’t show much promise.</p>
<p>You could try training the model for longer and see what happens when you plot a loss curve over a longer time horizon.</p>
</section>
</section>
<section id="what-should-an-ideal-loss-curve-look-like" class="level2" data-number="6.12">
<h2 data-number="6.12" class="anchored" data-anchor-id="what-should-an-ideal-loss-curve-look-like"><span class="header-section-number">6.12</span> 8. What should an ideal loss curve look like?</h2>
<p>Looking at training and test loss curves is a great way to see if your model is <strong>overfitting</strong>.</p>
<p>An overfitting model is one that performs better (often by a considerable margin) on the training set than the validation/test set.</p>
<p>If your training loss is far lower than your test loss, your model is <strong>overfitting</strong>.</p>
<p>As in, it’s learning the patterns in the training too well and those patterns aren’t generalizing to the test data.</p>
<p>The other side is when your training and test loss are not as low as you’d like, this is considered <strong>underfitting</strong>.</p>
<p>The ideal position for a training and test loss curve is for them to line up closely with each other.</p>
<p><img src="https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/04-loss-curves-overfitting-underfitting-ideal.jpg" alt="different training and test loss curves illustrating overfitting, underfitting and the ideal loss curves" width="800"></p>
<p><em>Left: If your training and test loss curves aren’t as low as you’d like, this is considered <strong>underfitting</strong>. </em>Middle:* When your test/validation loss is higher than your training loss this is considered <strong>overfitting</strong>. <em>Right:</em> The ideal scenario is when your training and test loss curves line up over time. This means your model is generalizing well. There are more combinations and different things loss curves can do, for more on these, see Google’s <a href="https://developers.google.com/machine-learning/testing-debugging/metrics/interpretic">Interpreting Loss Curves guide</a>.*</p>
<section id="how-to-deal-with-overfitting" class="level3" data-number="6.12.1">
<h3 data-number="6.12.1" class="anchored" data-anchor-id="how-to-deal-with-overfitting"><span class="header-section-number">6.12.1</span> 8.1 How to deal with overfitting</h3>
<p>Since the main problem with overfitting is that you’re model is fitting the training data <em>too well</em>, you’ll want to use techniques to “reign it in”.</p>
<p>A common technique of preventing overfitting is known as <a href="https://ml-cheatsheet.readthedocs.io/en/latest/regularization.html"><strong>regularization</strong></a>.</p>
<p>I like to think of this as “making our models more regular”, as in, capable of fitting <em>more</em> kinds of data.</p>
<p>Let’s discuss a few methods to prevent overfitting.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th><strong>Method to prevent overfitting</strong></th>
<th><strong>What is it?</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Get more data</strong></td>
<td>Having more data gives the model more opportunities to learn patterns, patterns which may be more generalizable to new examples.</td>
</tr>
<tr class="even">
<td><strong>Simplify your model</strong></td>
<td>If the current model is already overfitting the training data, it may be too complicated of a model. This means it’s learning the patterns of the data too well and isn’t able to generalize well to unseen data. One way to simplify a model is to reduce the number of layers it uses or to reduce the number of hidden units in each layer.</td>
</tr>
<tr class="odd">
<td><strong>Use data augmentation</strong></td>
<td><a href="https://developers.google.com/machine-learning/glossary#data-augmentation"><strong>Data augmentation</strong></a> manipulates the training data in a way so that’s harder for the model to learn as it artificially adds more variety to the data. If a model is able to learn patterns in augmented data, the model may be able to generalize better to unseen data.</td>
</tr>
<tr class="even">
<td><strong>Use transfer learning</strong></td>
<td><a href="https://developers.google.com/machine-learning/glossary#transfer-learning"><strong>Transfer learning</strong></a> involves leveraging the patterns (also called pretrained weights) one model has learned to use as the foundation for your own task. In our case, we could use one computer vision model pretrained on a large variety of images and then tweak it slightly to be more specialized for food images.</td>
</tr>
<tr class="odd">
<td><strong>Use dropout layers</strong></td>
<td>Dropout layers randomly remove connections between hidden layers in neural networks, effectively simplifying a model but also making the remaining connections better. See <a href="https://pytorch.org/docs/stable/generated/torch.nn.Dropout.html"><code>torch.nn.Dropout()</code></a> for more.</td>
</tr>
<tr class="even">
<td><strong>Use learning rate decay</strong></td>
<td>The idea here is to slowly decrease the learning rate as a model trains. This is akin to reaching for a coin at the back of a couch. The closer you get, the smaller your steps. The same with the learning rate, the closer you get to <a href="https://developers.google.com/machine-learning/glossary#convergence"><strong>convergence</strong></a>, the smaller you’ll want your weight updates to be.</td>
</tr>
<tr class="odd">
<td><strong>Use early stopping</strong></td>
<td><a href="https://developers.google.com/machine-learning/glossary#early_stopping"><strong>Early stopping</strong></a> stops model training <em>before</em> it begins to overfit. As in, say the model’s loss has stopped decreasing for the past 10 epochs (this number is arbitrary), you may want to stop the model training here and go with the model weights that had the lowest loss (10 epochs prior).</td>
</tr>
</tbody>
</table>
<p>There are more methods for dealing with overfitting but these are some of the main ones.</p>
<p>As you start to build more and more deep models, you’ll find because deep learnings are <em>so good</em> at learning patterns in data, dealing with overfitting is one of the primary problems of deep learning.</p>
</section>
<section id="how-to-deal-with-underfitting" class="level3" data-number="6.12.2">
<h3 data-number="6.12.2" class="anchored" data-anchor-id="how-to-deal-with-underfitting"><span class="header-section-number">6.12.2</span> 8.2 How to deal with underfitting</h3>
<p>When a model is <a href="https://developers.google.com/machine-learning/glossary#underfitting"><strong>underfitting</strong></a> it is considered to have poor predictive power on the training and test sets.</p>
<p>In essence, an underfitting model will fail to reduce the loss values to a desired level.</p>
<p>Right now, looking at our current loss curves, I’d considered our <code>TinyVGG</code> model, <code>model_0</code>, to be underfitting the data.</p>
<p>The main idea behind dealing with underfitting is to <em>increase</em> your model’s predictive power.</p>
<p>There are several ways to do this.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Method to prevent underfitting</strong></th>
<th><strong>What is it?</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Add more layers/units to your model</strong></td>
<td>If your model is underfitting, it may not have enough capability to <em>learn</em> the required patterns/weights/representations of the data to be predictive. One way to add more predictive power to your model is to increase the number of hidden layers/units within those layers.</td>
</tr>
<tr class="even">
<td><strong>Tweak the learning rate</strong></td>
<td>Perhaps your model’s learning rate is too high to begin with. And it’s trying to update its weights each epoch too much, in turn not learning anything. In this case, you might lower the learning rate and see what happens.</td>
</tr>
<tr class="odd">
<td><strong>Use transfer learning</strong></td>
<td>Transfer learning is capable of preventing overfitting and underfitting. It involves using the patterns from a previously working model and adjusting them to your own problem.</td>
</tr>
<tr class="even">
<td><strong>Train for longer</strong></td>
<td>Sometimes a model just needs more time to learn representations of data. If you find in your smaller experiments your model isn’t learning anything, perhaps leaving it train for a more epochs may result in better performance.</td>
</tr>
<tr class="odd">
<td><strong>Use less regularization</strong></td>
<td>Perhaps your model is underfitting because you’re trying to prevent overfitting too much. Holding back on regularization techniques can help your model fit the data better.</td>
</tr>
</tbody>
</table>
</section>
<section id="the-balance-between-overfitting-and-underfitting" class="level3" data-number="6.12.3">
<h3 data-number="6.12.3" class="anchored" data-anchor-id="the-balance-between-overfitting-and-underfitting"><span class="header-section-number">6.12.3</span> 8.3 The balance between overfitting and underfitting</h3>
<p>None of the methods discussed above are silver bullets, meaning, they don’t always work.</p>
<p>And preventing overfitting and underfitting is possibly the most active area of machine learning research.</p>
<p>Since everone wants their models to fit better (less underfitting) but not so good they don’t generalize well and perform in the real world (less overfitting).</p>
<p>There’s a fine line between overfitting and underfitting.</p>
<p>Because too much of each can cause the other.</p>
<p>Transfer learning is perhaps one of the most powerful techniques when it comes to dealing with both overfitting and underfitting on your own problems.</p>
<p>Rather than handcraft different overfitting and underfitting techniques, transfer learning enables you to take an already working model in a similar problem space to yours (say one from <a href="https://paperswithcode.com/sota">paperswithcode.com/sota</a> or <a href="https://huggingface.co/models">Hugging Face models</a>) and apply it to your own dataset.</p>
<p>We’ll see the power of transfer learning in a later notebook.</p>
</section>
</section>
<section id="model-1-tinyvgg-with-data-augmentation" class="level2" data-number="6.13">
<h2 data-number="6.13" class="anchored" data-anchor-id="model-1-tinyvgg-with-data-augmentation"><span class="header-section-number">6.13</span> 9. Model 1: TinyVGG with Data Augmentation</h2>
<p>Time to try out another model!</p>
<p>This time, let’s load in the data and use <strong>data augmentation</strong> to see if it improves our results in anyway.</p>
<p>First, we’ll compose a training transform to include <code>transforms.TrivialAugmentWide()</code> as well as resize and turn our images into tensors.</p>
<p>We’ll do the same for a testing transform except without the data augmentation.</p>
<section id="create-transform-with-data-augmentation" class="level3" data-number="6.13.1">
<h3 data-number="6.13.1" class="anchored" data-anchor-id="create-transform-with-data-augmentation"><span class="header-section-number">6.13.1</span> 9.1 Create transform with data augmentation</h3>
<div id="cell-121" class="cell" data-execution_count="55">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create training transform with TrivialAugment</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>train_transform_trivial_augment <span class="op">=</span> transforms.Compose([</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((<span class="dv">64</span>, <span class="dv">64</span>)),</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    transforms.TrivialAugmentWide(num_magnitude_bins<span class="op">=</span><span class="dv">31</span>),</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor() </span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create testing transform (no data augmentation)</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>test_transform <span class="op">=</span> transforms.Compose([</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((<span class="dv">64</span>, <span class="dv">64</span>)),</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor()</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Wonderful!</p>
<p>Now let’s turn our images into <code>Dataset</code>’s using <code>torchvision.datasets.ImageFolder()</code> and then into <code>DataLoader</code>’s with <code>torch.utils.data.DataLoader()</code>.</p>
</section>
<section id="create-train-and-test-datasets-and-dataloaders" class="level3" data-number="6.13.2">
<h3 data-number="6.13.2" class="anchored" data-anchor-id="create-train-and-test-datasets-and-dataloaders"><span class="header-section-number">6.13.2</span> 9.2 Create train and test <code>Dataset</code>’s and <code>DataLoader</code>’s</h3>
<p>We’ll make sure the train <code>Dataset</code> uses the <code>train_transform_trivial_augment</code> and the test <code>Dataset</code> uses the <code>test_transform</code>.</p>
<div id="cell-123" class="cell" data-execution_count="56">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn image folders into Datasets</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>train_data_augmented <span class="op">=</span> datasets.ImageFolder(train_dir, transform<span class="op">=</span>train_transform_trivial_augment)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>test_data_simple <span class="op">=</span> datasets.ImageFolder(test_dir, transform<span class="op">=</span>test_transform)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>train_data_augmented, test_data_simple</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>(Dataset ImageFolder
     Number of datapoints: 225
     Root location: data\pizza_steak_sushi\train
     StandardTransform
 Transform: Compose(
                Resize(size=(64, 64), interpolation=bilinear, max_size=None, antialias=None)
                TrivialAugmentWide(num_magnitude_bins=31, interpolation=InterpolationMode.NEAREST, fill=None)
                ToTensor()
            ),
 Dataset ImageFolder
     Number of datapoints: 75
     Root location: data\pizza_steak_sushi\test
     StandardTransform
 Transform: Compose(
                Resize(size=(64, 64), interpolation=bilinear, max_size=None, antialias=None)
                ToTensor()
            ))</code></pre>
</div>
</div>
<p>And we’ll make <code>DataLoader</code>’s with a <code>batch_size=32</code> and with <code>num_workers</code> set to the number of CPUs available on our machine (we can get this using Python’s <code>os.cpu_count()</code>).</p>
<div id="cell-125" class="cell" data-execution_count="57">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn Datasets into DataLoader's</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>NUM_WORKERS <span class="op">=</span> os.cpu_count()</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>torch.manual_seed(<span class="dv">42</span>)</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>train_dataloader_augmented <span class="op">=</span> DataLoader(train_data_augmented, </span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>                                        batch_size<span class="op">=</span>BATCH_SIZE, </span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>                                        shuffle<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>                                        num_workers<span class="op">=</span>NUM_WORKERS)</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>test_dataloader_simple <span class="op">=</span> DataLoader(test_data_simple, </span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>                                    batch_size<span class="op">=</span>BATCH_SIZE, </span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>                                    shuffle<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>                                    num_workers<span class="op">=</span>NUM_WORKERS)</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>train_dataloader_augmented, test_dataloader</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>(&lt;torch.utils.data.dataloader.DataLoader at 0x1fd2d0531c0&gt;,
 &lt;torch.utils.data.dataloader.DataLoader at 0x1fd2cf94dc0&gt;)</code></pre>
</div>
</div>
</section>
<section id="construct-and-train-model-1" class="level3" data-number="6.13.3">
<h3 data-number="6.13.3" class="anchored" data-anchor-id="construct-and-train-model-1"><span class="header-section-number">6.13.3</span> 9.3 Construct and train Model 1</h3>
<p>Data loaded!</p>
<p>Now to build our next model, <code>model_1</code>, we can reuse our <code>TinyVGG</code> class from before.</p>
<p>We’ll make sure to send it to the target device.</p>
<div id="cell-127" class="cell" data-execution_count="58">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create model_1 and send it to the target device</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>torch.manual_seed(<span class="dv">42</span>)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>model_1 <span class="op">=</span> TinyVGG(</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    input_shape<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    hidden_units<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    output_shape<span class="op">=</span><span class="bu">len</span>(train_data_augmented.classes)).to(device)</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>model_1</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>TinyVGG(
  (conv_block_1): Sequential(
    (0): Conv2d(3, 10, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (1): ReLU()
    (2): Conv2d(10, 10, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (3): ReLU()
    (4): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
  )
  (conv_block_2): Sequential(
    (0): Conv2d(10, 10, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (1): ReLU()
    (2): Conv2d(10, 10, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (3): ReLU()
    (4): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
  )
  (classifier): Sequential(
    (0): Flatten(start_dim=1, end_dim=-1)
    (1): Linear(in_features=2560, out_features=3, bias=True)
  )
)</code></pre>
</div>
</div>
<p>Model ready!</p>
<p>Time to train!</p>
<p>Since we’ve already got functions for the training loop (<code>train_step()</code>) and testing loop (<code>test_step()</code>) and a function to put them together in <code>train()</code>, let’s reuse those.</p>
<p>We’ll use the same setup as <code>model_0</code> with only the <code>train_dataloader</code> parameter varying: * Train for 5 epochs. * Use <code>train_dataloader=train_dataloader_augmented</code> as the training data in <code>train()</code>. * Use <code>torch.nn.CrossEntropyLoss()</code> as the loss function (since we’re working with multi-class classification). * Use <code>torch.optim.Adam()</code> with <code>lr=0.001</code> as the learning rate as the optimizer.</p>
<div id="cell-129" class="cell" data-execution_count="59">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set random seeds</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>torch.manual_seed(<span class="dv">42</span>) </span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>torch.cuda.manual_seed(<span class="dv">42</span>)</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set number of epochs</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>NUM_EPOCHS <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup loss function and optimizer</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(params<span class="op">=</span>model_1.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Start the timer</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> default_timer <span class="im">as</span> timer </span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> timer()</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Train model_1</span></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>model_1_results <span class="op">=</span> train(model<span class="op">=</span>model_1, </span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>                        train_dataloader<span class="op">=</span>train_dataloader_augmented,</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>                        test_dataloader<span class="op">=</span>test_dataloader_simple,</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>                        optimizer<span class="op">=</span>optimizer,</span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>                        loss_fn<span class="op">=</span>loss_fn, </span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>                        epochs<span class="op">=</span>NUM_EPOCHS)</span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a><span class="co"># End the timer and print out how long it took</span></span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>end_time <span class="op">=</span> timer()</span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total training time: </span><span class="sc">{</span>end_time<span class="op">-</span>start_time<span class="sc">:.3f}</span><span class="ss"> seconds"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c7c28bab3e334a5c8754dcd6127c3ba2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch: 1 | train_loss: 1.1074 | train_acc: 0.2461 | test_loss: 1.1058 | test_acc: 0.2604
Epoch: 2 | train_loss: 1.0791 | train_acc: 0.4258 | test_loss: 1.1382 | test_acc: 0.2604
Epoch: 3 | train_loss: 1.0804 | train_acc: 0.4258 | test_loss: 1.1683 | test_acc: 0.2604
Epoch: 4 | train_loss: 1.1287 | train_acc: 0.3047 | test_loss: 1.1626 | test_acc: 0.2604
Epoch: 5 | train_loss: 1.0884 | train_acc: 0.4258 | test_loss: 1.1481 | test_acc: 0.2604
Total training time: 67.543 seconds</code></pre>
</div>
</div>
<p>Hmm…</p>
<p>It doesn’t look like our model performed very well again.</p>
<p>Let’s check out its loss curves.</p>
</section>
<section id="plot-the-loss-curves-of-model-1" class="level3" data-number="6.13.4">
<h3 data-number="6.13.4" class="anchored" data-anchor-id="plot-the-loss-curves-of-model-1"><span class="header-section-number">6.13.4</span> 9.4 Plot the loss curves of Model 1</h3>
<p>Since we’ve got the results of <code>model_1</code> saved in a results dictionary, <code>model_1_results</code>, we can plot them using <code>plot_loss_curves()</code>.</p>
<div id="cell-132" class="cell" data-execution_count="60">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>plot_loss_curves(model_1_results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-57-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Wow…</p>
<p>These don’t look very good either…</p>
<p>Is our model <strong>underfitting</strong> or <strong>overfitting</strong>?</p>
<p>Or both?</p>
<p>Ideally we’d like it have higher accuracy and lower loss right?</p>
<p>What are some methods you could try to use to achieve these?</p>
</section>
</section>
<section id="compare-model-results" class="level2" data-number="6.14">
<h2 data-number="6.14" class="anchored" data-anchor-id="compare-model-results"><span class="header-section-number">6.14</span> 10. Compare model results</h2>
<p>Even though our models our performing quite poorly, we can still write code to compare them.</p>
<p>Let’s first turn our model results in pandas DataFrames.</p>
<div id="cell-135" class="cell" data-execution_count="61">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>model_0_df <span class="op">=</span> pd.DataFrame(model_0_results)</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>model_1_df <span class="op">=</span> pd.DataFrame(model_1_results)</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>model_0_df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_acc</th>
<th data-quarto-table-cell-role="th">test_loss</th>
<th data-quarto-table-cell-role="th">test_acc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>1.107832</td>
<td>0.257812</td>
<td>1.136025</td>
<td>0.260417</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>1.084726</td>
<td>0.425781</td>
<td>1.161953</td>
<td>0.197917</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>1.115656</td>
<td>0.292969</td>
<td>1.169479</td>
<td>0.197917</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>1.095543</td>
<td>0.414062</td>
<td>1.137993</td>
<td>0.197917</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>1.098464</td>
<td>0.292969</td>
<td>1.142002</td>
<td>0.197917</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>And now we can write some plotting code using <code>matplotlib</code> to visualize the results of <code>model_0</code> and <code>model_1</code> together.</p>
<div id="cell-137" class="cell" data-execution_count="62">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup a plot </span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get number of epochs</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="bu">range</span>(<span class="bu">len</span>(model_0_df))</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot train loss</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>plt.plot(epochs, model_0_df[<span class="st">"train_loss"</span>], label<span class="op">=</span><span class="st">"Model 0"</span>)</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>plt.plot(epochs, model_1_df[<span class="st">"train_loss"</span>], label<span class="op">=</span><span class="st">"Model 1"</span>)</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Train Loss"</span>)</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Epochs"</span>)</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot test loss</span></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>plt.plot(epochs, model_0_df[<span class="st">"test_loss"</span>], label<span class="op">=</span><span class="st">"Model 0"</span>)</span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>plt.plot(epochs, model_1_df[<span class="st">"test_loss"</span>], label<span class="op">=</span><span class="st">"Model 1"</span>)</span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Test Loss"</span>)</span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Epochs"</span>)</span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot train accuracy</span></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>plt.plot(epochs, model_0_df[<span class="st">"train_acc"</span>], label<span class="op">=</span><span class="st">"Model 0"</span>)</span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>plt.plot(epochs, model_1_df[<span class="st">"train_acc"</span>], label<span class="op">=</span><span class="st">"Model 1"</span>)</span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Train Accuracy"</span>)</span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Epochs"</span>)</span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot test accuracy</span></span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">4</span>)</span>
<span id="cb96-33"><a href="#cb96-33" aria-hidden="true" tabindex="-1"></a>plt.plot(epochs, model_0_df[<span class="st">"test_acc"</span>], label<span class="op">=</span><span class="st">"Model 0"</span>)</span>
<span id="cb96-34"><a href="#cb96-34" aria-hidden="true" tabindex="-1"></a>plt.plot(epochs, model_1_df[<span class="st">"test_acc"</span>], label<span class="op">=</span><span class="st">"Model 1"</span>)</span>
<span id="cb96-35"><a href="#cb96-35" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Test Accuracy"</span>)</span>
<span id="cb96-36"><a href="#cb96-36" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Epochs"</span>)</span>
<span id="cb96-37"><a href="#cb96-37" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-59-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It looks like our models both performed equally poorly and were kind of sporadic (the metrics go up and down sharply).</p>
<p>If you built <code>model_2</code>, what would you do differently to try and improve performance?</p>
</section>
<section id="make-a-prediction-on-a-custom-image" class="level2" data-number="6.15">
<h2 data-number="6.15" class="anchored" data-anchor-id="make-a-prediction-on-a-custom-image"><span class="header-section-number">6.15</span> 11. Make a prediction on a custom image</h2>
<p>If you’ve trained a model on a certain dataset, chances are you’d like to make a prediction on on your own custom data.</p>
<p>In our case, since we’ve trained a model on pizza, steak and sushi images, how could we use our model to make a prediction on one of our own images?</p>
<p>To do so, we can load an image and then <strong>preprocess it in a way that matches the type of data our model was trained on</strong>.</p>
<p>In other words, we’ll have to convert our own custom image to a tensor and make sure it’s in the right datatype before passing it to our model.</p>
<p>Let’s start by downloading a custom image.</p>
<p>Since our model predicts whether an image contains pizza, steak or sushi, let’s download a photo of <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/images/04-pizza-dad.jpeg">my Dad giving two thumbs up to a big pizza from the Learn PyTorch for Deep Learning GitHub</a>.</p>
<p>We download the image using Python’s <code>requests</code> module.</p>
<blockquote class="blockquote">
<p><strong>참고:</strong> If you’re using Google Colab, you can also upload an image to the current session by going to the left hand side menu -&gt; Files -&gt; Upload to session storage. Beware though, this image will delete when your Google Colab session ends.</p>
</blockquote>
<div id="cell-140" class="cell" data-execution_count="63">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download custom image</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup custom image path</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>custom_image_path <span class="op">=</span> data_path <span class="op">/</span> <span class="st">"04-pizza-dad.jpeg"</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the image if it doesn't already exist</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> custom_image_path.is_file():</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(custom_image_path, <span class="st">"wb"</span>) <span class="im">as</span> f:</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># When downloading from GitHub, need to use the "raw" file link</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>        request <span class="op">=</span> requests.get(<span class="st">"https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/04-pizza-dad.jpeg"</span>)</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Downloading </span><span class="sc">{</span>custom_image_path<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>        f.write(request.content)</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>custom_image_path<span class="sc">}</span><span class="ss"> already exists, skipping download."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>data\04-pizza-dad.jpeg already exists, skipping download.</code></pre>
</div>
</div>
<section id="loading-in-a-custom-image-with-pytorch" class="level3" data-number="6.15.1">
<h3 data-number="6.15.1" class="anchored" data-anchor-id="loading-in-a-custom-image-with-pytorch"><span class="header-section-number">6.15.1</span> 11.1 Loading in a custom image with PyTorch</h3>
<p>Excellent!</p>
<p>Looks like we’ve got a custom image downloaded and ready to go at <code>data/04-pizza-dad.jpeg</code>.</p>
<p>Time to load it in.</p>
<p>PyTorch’s <code>torchvision</code> has several input and output (“IO” or “io” for short) methods for reading and writing images and video in <a href="https://pytorch.org/vision/stable/io.html"><code>torchvision.io</code></a>.</p>
<p>Since we want to load in an image, we’ll use <a href="https://pytorch.org/vision/stable/generated/torchvision.io.read_image.html#torchvision.io.read_image"><code>torchvision.io.read_image()</code></a>.</p>
<p>This method will read a JPEG or PNG image and turn it into a 3 dimensional RGB or grayscale <code>torch.Tensor</code> with values of datatype <code>uint8</code> in range <code>[0, 255]</code>.</p>
<p>Let’s try it out.</p>
<div id="cell-142" class="cell" data-execution_count="64">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in custom image</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>custom_image_uint8 <span class="op">=</span> torchvision.io.read_image(<span class="bu">str</span>(custom_image_path))</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Print out image data</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Custom image tensor:</span><span class="ch">\n</span><span class="sc">{</span>custom_image_uint8<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Custom image shape: </span><span class="sc">{</span>custom_image_uint8<span class="sc">.</span>shape<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Custom image dtype: </span><span class="sc">{</span>custom_image_uint8<span class="sc">.</span>dtype<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Custom image tensor:
tensor([[[154, 175, 181,  ...,  21,  18,  14],
         [146, 167, 180,  ...,  21,  18,  15],
         [124, 146, 171,  ...,  18,  17,  15],
         ...,
         [ 72,  59,  45,  ..., 152, 150, 148],
         [ 64,  55,  41,  ..., 150, 147, 144],
         [ 64,  60,  46,  ..., 149, 146, 143]],

        [[171, 189, 193,  ...,  22,  19,  15],
         [163, 181, 194,  ...,  22,  19,  16],
         [141, 163, 185,  ...,  19,  18,  16],
         ...,
         [ 55,  42,  28,  ..., 106, 104, 102],
         [ 47,  38,  24,  ..., 108, 105, 102],
         [ 47,  43,  29,  ..., 107, 104, 101]],

        [[117, 138, 145,  ...,  17,  14,  10],
         [109, 130, 145,  ...,  17,  14,  11],
         [ 87, 111, 136,  ...,  14,  13,  11],
         ...,
         [ 35,  22,   8,  ...,  54,  52,  50],
         [ 27,  18,   4,  ...,  50,  47,  44],
         [ 27,  23,   9,  ...,  49,  46,  43]]], dtype=torch.uint8)

Custom image shape: torch.Size([3, 4032, 3024])

Custom image dtype: torch.uint8</code></pre>
</div>
</div>
<p>Nice! Looks like our image is in tensor format, however, is this image format compatible with our model?</p>
<p>Our <code>custom_image</code> tensor is of datatype <code>torch.uint8</code> and its values are between <code>[0, 255]</code>.</p>
<p>But our model takes image tensors of datatype <code>torch.float32</code> and with values between <code>[0, 1]</code>.</p>
<p>So before we use our custom image with our model, <strong>we’ll need to convert it to the same format as the data our model is trained on</strong>.</p>
<p>If we don’t do this, our model will error.</p>
<div id="cell-144" class="cell" data-execution_count="65">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Try to make a prediction on image in uint8 format (this will error)</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>model_1.<span class="bu">eval</span>()</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.inference_mode():</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    model_1(custom_image_uint8.to(device))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg ansi-bold">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg ansi-bold">RuntimeError</span>                              Traceback (most recent call last)
Input <span class="ansi-green-fg ansi-bold">In [65]</span>, in <span class="ansi-cyan-fg">&lt;cell line: 3&gt;</span><span class="ansi-blue-fg ansi-bold">()</span>
<span class="ansi-green-fg">      2</span> model_1<span style="color:rgb(98,98,98)">.</span>eval()
<span class="ansi-green-fg">      3</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> torch<span style="color:rgb(98,98,98)">.</span>inference_mode():
<span class="ansi-green-fg ansi-bold">----&gt; 4</span>     <span class="ansi-yellow-bg">model_1</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">custom_image_uint8</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">to</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">device</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\module.py:1110</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *input, **kwargs)</span>
<span class="ansi-green-fg">   1106</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg">   1107</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg">   1108</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg">   1109</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg ansi-bold">-&gt; 1110</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> forward_call(<span style="color:rgb(98,98,98)">*</span><span style="color:rgb(0,135,0)">input</span>, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">   1111</span> <span style="font-style:italic;color:rgb(95,135,135)"># Do not call functions when jit is used</span>
<span class="ansi-green-fg">   1112</span> full_backward_hooks, non_full_backward_hooks <span style="color:rgb(98,98,98)">=</span> [], []

Input <span class="ansi-green-fg ansi-bold">In [45]</span>, in <span class="ansi-cyan-fg">TinyVGG.forward</span><span class="ansi-blue-fg ansi-bold">(self, x)</span>
<span class="ansi-green-fg">     39</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x: torch<span style="color:rgb(98,98,98)">.</span>Tensor):
<span class="ansi-green-fg ansi-bold">---&gt; 40</span>     x <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">conv_block_1</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">     41</span>     <span style="font-style:italic;color:rgb(95,135,135)"># print(x.shape)</span>
<span class="ansi-green-fg">     42</span>     x <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>conv_block_2(x)

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\module.py:1110</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *input, **kwargs)</span>
<span class="ansi-green-fg">   1106</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg">   1107</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg">   1108</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg">   1109</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg ansi-bold">-&gt; 1110</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> forward_call(<span style="color:rgb(98,98,98)">*</span><span style="color:rgb(0,135,0)">input</span>, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">   1111</span> <span style="font-style:italic;color:rgb(95,135,135)"># Do not call functions when jit is used</span>
<span class="ansi-green-fg">   1112</span> full_backward_hooks, non_full_backward_hooks <span style="color:rgb(98,98,98)">=</span> [], []

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\container.py:141</span>, in <span class="ansi-cyan-fg">Sequential.forward</span><span class="ansi-blue-fg ansi-bold">(self, input)</span>
<span class="ansi-green-fg">    139</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>):
<span class="ansi-green-fg">    140</span>     <span style="font-weight:bold;color:rgb(0,135,0)">for</span> module <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span>:
<span class="ansi-green-fg ansi-bold">--&gt; 141</span>         <span style="color:rgb(0,135,0)">input</span> <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">module</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    142</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">input</span>

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\module.py:1110</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *input, **kwargs)</span>
<span class="ansi-green-fg">   1106</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg">   1107</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg">   1108</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg">   1109</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg ansi-bold">-&gt; 1110</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> forward_call(<span style="color:rgb(98,98,98)">*</span><span style="color:rgb(0,135,0)">input</span>, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">   1111</span> <span style="font-style:italic;color:rgb(95,135,135)"># Do not call functions when jit is used</span>
<span class="ansi-green-fg">   1112</span> full_backward_hooks, non_full_backward_hooks <span style="color:rgb(98,98,98)">=</span> [], []

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\conv.py:447</span>, in <span class="ansi-cyan-fg">Conv2d.forward</span><span class="ansi-blue-fg ansi-bold">(self, input)</span>
<span class="ansi-green-fg">    446</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Tensor:
<span class="ansi-green-fg ansi-bold">--&gt; 447</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_conv_forward</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">bias</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\conv.py:443</span>, in <span class="ansi-cyan-fg">Conv2d._conv_forward</span><span class="ansi-blue-fg ansi-bold">(self, input, weight, bias)</span>
<span class="ansi-green-fg">    439</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>padding_mode <span style="color:rgb(98,98,98)">!=</span> <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">zeros</span><span style="color:rgb(175,0,0)">'</span>:
<span class="ansi-green-fg">    440</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> F<span style="color:rgb(98,98,98)">.</span>conv2d(F<span style="color:rgb(98,98,98)">.</span>pad(<span style="color:rgb(0,135,0)">input</span>, <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_reversed_padding_repeated_twice, mode<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>padding_mode),
<span class="ansi-green-fg">    441</span>                     weight, bias, <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>stride,
<span class="ansi-green-fg">    442</span>                     _pair(<span style="color:rgb(98,98,98)">0</span>), <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>dilation, <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>groups)
<span class="ansi-green-fg ansi-bold">--&gt; 443</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">F</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">conv2d</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">bias</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">stride</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    444</span> <span class="ansi-yellow-bg">                </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">padding</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">dilation</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">groups</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg ansi-bold">RuntimeError</span>: Input type (torch.cuda.ByteTensor) and weight type (torch.cuda.FloatTensor) should be the same</pre>
</div>
</div>
</div>
<p>If we try to make a prediction on an image in a different datatype to what our model was trained on, we get an error like the following:</p>
<blockquote class="blockquote">
<p><code>RuntimeError: Input type (torch.cuda.ByteTensor) and weight type (torch.cuda.FloatTensor) should be the same</code></p>
</blockquote>
<p>Let’s fix this by converting our custom image to the same datatype as what our model was trained on (<code>torch.float32</code>).</p>
<div id="cell-146" class="cell" data-execution_count="66">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load in custom image and convert the tensor values to float32</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>custom_image <span class="op">=</span> torchvision.io.read_image(<span class="bu">str</span>(custom_image_path)).<span class="bu">type</span>(torch.float32)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Divide the image pixel values by 255 to get them between [0, 1]</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>custom_image <span class="op">=</span> custom_image <span class="op">/</span> <span class="fl">255.</span> </span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print out image data</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Custom image tensor:</span><span class="ch">\n</span><span class="sc">{</span>custom_image<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Custom image shape: </span><span class="sc">{</span>custom_image<span class="sc">.</span>shape<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Custom image dtype: </span><span class="sc">{</span>custom_image<span class="sc">.</span>dtype<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Custom image tensor:
tensor([[[0.6039, 0.6863, 0.7098,  ..., 0.0824, 0.0706, 0.0549],
         [0.5725, 0.6549, 0.7059,  ..., 0.0824, 0.0706, 0.0588],
         [0.4863, 0.5725, 0.6706,  ..., 0.0706, 0.0667, 0.0588],
         ...,
         [0.2824, 0.2314, 0.1765,  ..., 0.5961, 0.5882, 0.5804],
         [0.2510, 0.2157, 0.1608,  ..., 0.5882, 0.5765, 0.5647],
         [0.2510, 0.2353, 0.1804,  ..., 0.5843, 0.5725, 0.5608]],

        [[0.6706, 0.7412, 0.7569,  ..., 0.0863, 0.0745, 0.0588],
         [0.6392, 0.7098, 0.7608,  ..., 0.0863, 0.0745, 0.0627],
         [0.5529, 0.6392, 0.7255,  ..., 0.0745, 0.0706, 0.0627],
         ...,
         [0.2157, 0.1647, 0.1098,  ..., 0.4157, 0.4078, 0.4000],
         [0.1843, 0.1490, 0.0941,  ..., 0.4235, 0.4118, 0.4000],
         [0.1843, 0.1686, 0.1137,  ..., 0.4196, 0.4078, 0.3961]],

        [[0.4588, 0.5412, 0.5686,  ..., 0.0667, 0.0549, 0.0392],
         [0.4275, 0.5098, 0.5686,  ..., 0.0667, 0.0549, 0.0431],
         [0.3412, 0.4353, 0.5333,  ..., 0.0549, 0.0510, 0.0431],
         ...,
         [0.1373, 0.0863, 0.0314,  ..., 0.2118, 0.2039, 0.1961],
         [0.1059, 0.0706, 0.0157,  ..., 0.1961, 0.1843, 0.1725],
         [0.1059, 0.0902, 0.0353,  ..., 0.1922, 0.1804, 0.1686]]])

Custom image shape: torch.Size([3, 4032, 3024])

Custom image dtype: torch.float32</code></pre>
</div>
</div>
</section>
<section id="predicting-on-custom-images-with-a-trained-pytorch-model" class="level3" data-number="6.15.2">
<h3 data-number="6.15.2" class="anchored" data-anchor-id="predicting-on-custom-images-with-a-trained-pytorch-model"><span class="header-section-number">6.15.2</span> 11.2 Predicting on custom images with a trained PyTorch model</h3>
<p>Beautiful, it looks like our image data is now in the same format our model was trained on.</p>
<p>Except for one thing…</p>
<p>It’s <code>shape</code>.</p>
<p>Our model was trained on images with shape <code>[3, 64, 64]</code>, whereas our custom image is currently <code>[3, 4032, 3024]</code>.</p>
<p>How could we make sure our custom image is the same shape as the images our model was trained on?</p>
<p>Are there any <code>torchvision.transforms</code> that could help?</p>
<p>Before we answer that question, let’s plot the image with <code>matplotlib</code> to make sure it looks okay, remember we’ll have to permute the dimensions from <code>CHW</code> to <code>HWC</code> to suit <code>matplotlib</code>’s requirements.</p>
<div id="cell-148" class="cell" data-execution_count="67">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot custom image</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>plt.imshow(custom_image.permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>)) <span class="co"># need to permute image dimensions from CHW -&gt; HWC otherwise matplotlib will error</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"Image shape: </span><span class="sc">{</span>custom_image<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="va">False</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-64-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Two thumbs up!</p>
<p>Now how could we get our image to be the same size as the images our model was trained on?</p>
<p>One way to do so is with <code>torchvision.transforms.Resize()</code>.</p>
<p>Let’s compose a transform pipeline to do so.</p>
<div id="cell-150" class="cell" data-execution_count="68">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create transform pipleine to resize image</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>custom_image_transform <span class="op">=</span> transforms.Compose([</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((<span class="dv">64</span>, <span class="dv">64</span>)),</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform target image</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>custom_image_transformed <span class="op">=</span> custom_image_transform(custom_image)</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Print out original shape and new shape</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Original shape: </span><span class="sc">{</span>custom_image<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"New shape: </span><span class="sc">{</span>custom_image_transformed<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original shape: torch.Size([3, 4032, 3024])
New shape: torch.Size([3, 64, 64])</code></pre>
</div>
</div>
<p>Woohoo!</p>
<p>Let’s finally make a prediction on our own custom image.</p>
<div id="cell-152" class="cell" data-execution_count="69">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>model_1.<span class="bu">eval</span>()</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.inference_mode():</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    custom_image_pred <span class="op">=</span> model_1(custom_image_transformed)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg ansi-bold">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg ansi-bold">RuntimeError</span>                              Traceback (most recent call last)
Input <span class="ansi-green-fg ansi-bold">In [69]</span>, in <span class="ansi-cyan-fg">&lt;cell line: 2&gt;</span><span class="ansi-blue-fg ansi-bold">()</span>
<span class="ansi-green-fg">      1</span> model_1<span style="color:rgb(98,98,98)">.</span>eval()
<span class="ansi-green-fg">      2</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> torch<span style="color:rgb(98,98,98)">.</span>inference_mode():
<span class="ansi-green-fg ansi-bold">----&gt; 3</span>     custom_image_pred <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">model_1</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">custom_image_transformed</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\module.py:1110</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *input, **kwargs)</span>
<span class="ansi-green-fg">   1106</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg">   1107</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg">   1108</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg">   1109</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg ansi-bold">-&gt; 1110</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> forward_call(<span style="color:rgb(98,98,98)">*</span><span style="color:rgb(0,135,0)">input</span>, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">   1111</span> <span style="font-style:italic;color:rgb(95,135,135)"># Do not call functions when jit is used</span>
<span class="ansi-green-fg">   1112</span> full_backward_hooks, non_full_backward_hooks <span style="color:rgb(98,98,98)">=</span> [], []

Input <span class="ansi-green-fg ansi-bold">In [45]</span>, in <span class="ansi-cyan-fg">TinyVGG.forward</span><span class="ansi-blue-fg ansi-bold">(self, x)</span>
<span class="ansi-green-fg">     39</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x: torch<span style="color:rgb(98,98,98)">.</span>Tensor):
<span class="ansi-green-fg ansi-bold">---&gt; 40</span>     x <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">conv_block_1</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">     41</span>     <span style="font-style:italic;color:rgb(95,135,135)"># print(x.shape)</span>
<span class="ansi-green-fg">     42</span>     x <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>conv_block_2(x)

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\module.py:1110</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *input, **kwargs)</span>
<span class="ansi-green-fg">   1106</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg">   1107</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg">   1108</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg">   1109</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg ansi-bold">-&gt; 1110</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> forward_call(<span style="color:rgb(98,98,98)">*</span><span style="color:rgb(0,135,0)">input</span>, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">   1111</span> <span style="font-style:italic;color:rgb(95,135,135)"># Do not call functions when jit is used</span>
<span class="ansi-green-fg">   1112</span> full_backward_hooks, non_full_backward_hooks <span style="color:rgb(98,98,98)">=</span> [], []

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\container.py:141</span>, in <span class="ansi-cyan-fg">Sequential.forward</span><span class="ansi-blue-fg ansi-bold">(self, input)</span>
<span class="ansi-green-fg">    139</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>):
<span class="ansi-green-fg">    140</span>     <span style="font-weight:bold;color:rgb(0,135,0)">for</span> module <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span>:
<span class="ansi-green-fg ansi-bold">--&gt; 141</span>         <span style="color:rgb(0,135,0)">input</span> <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">module</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    142</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">input</span>

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\module.py:1110</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *input, **kwargs)</span>
<span class="ansi-green-fg">   1106</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg">   1107</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg">   1108</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg">   1109</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg ansi-bold">-&gt; 1110</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> forward_call(<span style="color:rgb(98,98,98)">*</span><span style="color:rgb(0,135,0)">input</span>, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">   1111</span> <span style="font-style:italic;color:rgb(95,135,135)"># Do not call functions when jit is used</span>
<span class="ansi-green-fg">   1112</span> full_backward_hooks, non_full_backward_hooks <span style="color:rgb(98,98,98)">=</span> [], []

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\conv.py:447</span>, in <span class="ansi-cyan-fg">Conv2d.forward</span><span class="ansi-blue-fg ansi-bold">(self, input)</span>
<span class="ansi-green-fg">    446</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Tensor:
<span class="ansi-green-fg ansi-bold">--&gt; 447</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_conv_forward</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">bias</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\conv.py:443</span>, in <span class="ansi-cyan-fg">Conv2d._conv_forward</span><span class="ansi-blue-fg ansi-bold">(self, input, weight, bias)</span>
<span class="ansi-green-fg">    439</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>padding_mode <span style="color:rgb(98,98,98)">!=</span> <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">zeros</span><span style="color:rgb(175,0,0)">'</span>:
<span class="ansi-green-fg">    440</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> F<span style="color:rgb(98,98,98)">.</span>conv2d(F<span style="color:rgb(98,98,98)">.</span>pad(<span style="color:rgb(0,135,0)">input</span>, <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_reversed_padding_repeated_twice, mode<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>padding_mode),
<span class="ansi-green-fg">    441</span>                     weight, bias, <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>stride,
<span class="ansi-green-fg">    442</span>                     _pair(<span style="color:rgb(98,98,98)">0</span>), <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>dilation, <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>groups)
<span class="ansi-green-fg ansi-bold">--&gt; 443</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">F</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">conv2d</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">bias</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">stride</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    444</span> <span class="ansi-yellow-bg">                </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">padding</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">dilation</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">groups</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg ansi-bold">RuntimeError</span>: Expected all tensors to be on the same device, but found at least two devices, cpu and cuda:0! (when checking argument for argument weight in method wrapper___slow_conv2d_forward)</pre>
</div>
</div>
</div>
<p>Oh my goodness…</p>
<p>Despite our preparations our custom image and model are on different devices.</p>
<p>And we get the error:</p>
<blockquote class="blockquote">
<p><code>RuntimeError: Expected all tensors to be on the same device, but found at least two devices, cpu and cuda:0! (when checking argument for argument weight in method wrapper___slow_conv2d_forward)</code></p>
</blockquote>
<p>Let’s fix that by putting our <code>custom_image_transformed</code> on the target device.</p>
<div id="cell-154" class="cell" data-execution_count="70">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>model_1.<span class="bu">eval</span>()</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.inference_mode():</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    custom_image_pred <span class="op">=</span> model_1(custom_image_transformed.to(device))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg ansi-bold">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg ansi-bold">RuntimeError</span>                              Traceback (most recent call last)
Input <span class="ansi-green-fg ansi-bold">In [70]</span>, in <span class="ansi-cyan-fg">&lt;cell line: 2&gt;</span><span class="ansi-blue-fg ansi-bold">()</span>
<span class="ansi-green-fg">      1</span> model_1<span style="color:rgb(98,98,98)">.</span>eval()
<span class="ansi-green-fg">      2</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> torch<span style="color:rgb(98,98,98)">.</span>inference_mode():
<span class="ansi-green-fg ansi-bold">----&gt; 3</span>     custom_image_pred <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">model_1</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">custom_image_transformed</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">to</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">device</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\module.py:1110</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *input, **kwargs)</span>
<span class="ansi-green-fg">   1106</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg">   1107</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg">   1108</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg">   1109</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg ansi-bold">-&gt; 1110</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> forward_call(<span style="color:rgb(98,98,98)">*</span><span style="color:rgb(0,135,0)">input</span>, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">   1111</span> <span style="font-style:italic;color:rgb(95,135,135)"># Do not call functions when jit is used</span>
<span class="ansi-green-fg">   1112</span> full_backward_hooks, non_full_backward_hooks <span style="color:rgb(98,98,98)">=</span> [], []

Input <span class="ansi-green-fg ansi-bold">In [45]</span>, in <span class="ansi-cyan-fg">TinyVGG.forward</span><span class="ansi-blue-fg ansi-bold">(self, x)</span>
<span class="ansi-green-fg">     42</span> x <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>conv_block_2(x)
<span class="ansi-green-fg">     43</span> <span style="font-style:italic;color:rgb(95,135,135)"># print(x.shape)</span>
<span class="ansi-green-fg ansi-bold">---&gt; 44</span> x <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">classifier</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">     45</span> <span style="font-style:italic;color:rgb(95,135,135)"># print(x.shape)</span>
<span class="ansi-green-fg">     46</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> x

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\module.py:1110</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *input, **kwargs)</span>
<span class="ansi-green-fg">   1106</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg">   1107</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg">   1108</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg">   1109</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg ansi-bold">-&gt; 1110</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> forward_call(<span style="color:rgb(98,98,98)">*</span><span style="color:rgb(0,135,0)">input</span>, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">   1111</span> <span style="font-style:italic;color:rgb(95,135,135)"># Do not call functions when jit is used</span>
<span class="ansi-green-fg">   1112</span> full_backward_hooks, non_full_backward_hooks <span style="color:rgb(98,98,98)">=</span> [], []

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\container.py:141</span>, in <span class="ansi-cyan-fg">Sequential.forward</span><span class="ansi-blue-fg ansi-bold">(self, input)</span>
<span class="ansi-green-fg">    139</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>):
<span class="ansi-green-fg">    140</span>     <span style="font-weight:bold;color:rgb(0,135,0)">for</span> module <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span>:
<span class="ansi-green-fg ansi-bold">--&gt; 141</span>         <span style="color:rgb(0,135,0)">input</span> <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">module</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    142</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">input</span>

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\module.py:1110</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *input, **kwargs)</span>
<span class="ansi-green-fg">   1106</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg">   1107</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg">   1108</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg">   1109</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg ansi-bold">-&gt; 1110</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> forward_call(<span style="color:rgb(98,98,98)">*</span><span style="color:rgb(0,135,0)">input</span>, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">   1111</span> <span style="font-style:italic;color:rgb(95,135,135)"># Do not call functions when jit is used</span>
<span class="ansi-green-fg">   1112</span> full_backward_hooks, non_full_backward_hooks <span style="color:rgb(98,98,98)">=</span> [], []

File <span class="ansi-green-fg ansi-bold">~\mambaforge\envs\ds\lib\site-packages\torch\nn\modules\linear.py:103</span>, in <span class="ansi-cyan-fg">Linear.forward</span><span class="ansi-blue-fg ansi-bold">(self, input)</span>
<span class="ansi-green-fg">    102</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Tensor:
<span class="ansi-green-fg ansi-bold">--&gt; 103</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">F</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">linear</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">bias</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg ansi-bold">RuntimeError</span>: mat1 and mat2 shapes cannot be multiplied (10x256 and 2560x3)</pre>
</div>
</div>
</div>
<p>What now?</p>
<p>It looks like we’re getting a shape error.</p>
<p>Why might this be?</p>
<p>We converted our custom image to be the same size as the images our model was trained on…</p>
<p>Oh wait…</p>
<p>There’s one dimension we forgot about.</p>
<p>The batch size.</p>
<p>Our model expects image tensors with a batch size dimension at the start (<code>NCHW</code> where <code>N</code> is the batch size).</p>
<p>Except our custom image is currently only <code>CHW</code>.</p>
<p>We can add a batch size dimension using <code>torch.unsqueeze(dim=0)</code> to add an extra dimension our image and <em>finally</em> make a prediction.</p>
<p>Essentially we’ll be telling our model to predict on a single image (an image with a <code>batch_size</code> of 1).</p>
<div id="cell-156" class="cell" data-execution_count="71">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>model_1.<span class="bu">eval</span>()</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.inference_mode():</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add an extra dimension to image</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    custom_image_transformed_with_batch_size <span class="op">=</span> custom_image_transformed.unsqueeze(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print out different shapes</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Custom image transformed shape: </span><span class="sc">{</span>custom_image_transformed<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Unsqueezed custom image shape: </span><span class="sc">{</span>custom_image_transformed_with_batch_size<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make a prediction on image with an extra dimension</span></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>    custom_image_pred <span class="op">=</span> model_1(custom_image_transformed.unsqueeze(dim<span class="op">=</span><span class="dv">0</span>).to(device))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Custom image transformed shape: torch.Size([3, 64, 64])
Unsqueezed custom image shape: torch.Size([1, 3, 64, 64])</code></pre>
</div>
</div>
<p>Yes!!!</p>
<p>It looks like it worked!</p>
<blockquote class="blockquote">
<p><strong>참고:</strong> What we’ve just gone through are three of the classical and most common deep learning and PyTorch issues: 1. <strong>Wrong datatypes</strong> - our model expects <code>torch.float32</code> where our original custom image was <code>uint8</code>. 2. <strong>Wrong device</strong> - our model was on the target <code>device</code> (in our case, the GPU) whereas our target data hadn’t been moved to the target <code>device</code> yet. 3. <strong>Wrong shapes</strong> - our model expected an input image of shape <code>[N, C, H, W]</code> or <code>[batch_size, color_channels, height, width]</code> whereas our custom image tensor was of shape <code>[color_channels, height, width]</code>.</p>
<p>Keep in mind, these errors aren’t just for predicting on custom images.</p>
<p>They will be present with almost every kind of data type (text, audio, structured data) and problem you work with.</p>
</blockquote>
<p>Now let’s take a look at our model’s predictions.</p>
<div id="cell-158" class="cell" data-execution_count="72">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>custom_image_pred</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>tensor([[ 0.1161,  0.0213, -0.1422]], device='cuda:0')</code></pre>
</div>
</div>
<p>Alright, these are still in <em>logit form</em> (the raw outputs of a model are called logits).</p>
<p>Let’s convert them from logits -&gt; prediction probabilities -&gt; prediction labels.</p>
<div id="cell-160" class="cell" data-execution_count="73">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print out prediction logits</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Prediction logits: </span><span class="sc">{</span>custom_image_pred<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert logits -&gt; prediction probabilities (using torch.softmax() for multi-class classification)</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>custom_image_pred_probs <span class="op">=</span> torch.softmax(custom_image_pred, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Prediction probabilities: </span><span class="sc">{</span>custom_image_pred_probs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert prediction probabilities -&gt; prediction labels</span></span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>custom_image_pred_label <span class="op">=</span> torch.argmax(custom_image_pred_probs, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Prediction label: </span><span class="sc">{</span>custom_image_pred_label<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Prediction logits: tensor([[ 0.1161,  0.0213, -0.1422]], device='cuda:0')
Prediction probabilities: tensor([[0.3729, 0.3392, 0.2880]], device='cuda:0')
Prediction label: tensor([0], device='cuda:0')</code></pre>
</div>
</div>
<p>Alright!</p>
<p>Looking good.</p>
<p>But of course our prediction label is still in index/tensor form.</p>
<p>We can convert it to a string class name prediction by indexing on the <code>class_names</code> list.</p>
<div id="cell-162" class="cell" data-execution_count="74">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the predicted label</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>custom_image_pred_class <span class="op">=</span> class_names[custom_image_pred_label.cpu()] <span class="co"># put pred label to CPU, otherwise will error</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>custom_image_pred_class</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>'pizza'</code></pre>
</div>
</div>
<p>Wow.</p>
<p>It looks like the model gets the prediction right, even though it was performing poorly based on our evaluation metrics.</p>
<blockquote class="blockquote">
<p><strong>참고:</strong> The model in its current form will predict “pizza”, “steak” or “sushi” no matter what image it’s given. If you wanted your model to predict on a different class, you’d have to train it to do so.</p>
</blockquote>
<p>But if we check the <code>custom_image_pred_probs</code>, we’ll notice that the model gives almost equal weight (the values are similar) to every class.</p>
<div id="cell-164" class="cell" data-execution_count="75">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The values of the prediction probabilities are quite similar</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>custom_image_pred_probs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>tensor([[0.3729, 0.3392, 0.2880]], device='cuda:0')</code></pre>
</div>
</div>
<p>Having prediction probabilities this similar could mean a couple of things: 1. The model is trying to predict all three classes at the same time (there may be an image containing pizza, steak and sushi). 2. The model doesn’t really know what it wants to predict and is in turn just assigning similar values to each of the classes.</p>
<p>Our case is number 2, since our model is poorly trained, it is basically <em>guessing</em> the prediction.</p>
</section>
<section id="putting-custom-image-prediction-together-building-a-function" class="level3" data-number="6.15.3">
<h3 data-number="6.15.3" class="anchored" data-anchor-id="putting-custom-image-prediction-together-building-a-function"><span class="header-section-number">6.15.3</span> 11.3 Putting custom image prediction together: building a function</h3>
<p>Doing all of the above steps every time you’d like to make a prediction on a custom image would quickly become tedious.</p>
<p>So let’s put them all together in a function we can easily use over and over again.</p>
<p>Specifically, let’s make a function that: 1. Takes in a target image path and converts to the right datatype for our model (<code>torch.float32</code>). 2. Makes sure the target image pixel values are in the range <code>[0, 1]</code>. 3. Transforms the target image if necessary. 4. Makes sure the model is on the target device. 5. Makes a prediction on the target image with a trained model (ensuring the image is the right size and on the same device as the model). 6. Converts the model’s output logits to prediction probabilities. 7. Converts the prediction probabilities to prediction labels. 8. Plots the target image alongside the model prediction and prediction probability.</p>
<p>A fair few steps but we’ve got this!</p>
<div id="cell-167" class="cell" data-execution_count="76">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pred_and_plot_image(model: torch.nn.Module, </span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>                        image_path: <span class="bu">str</span>, </span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>                        class_names: List[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>, </span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>                        transform<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>                        device: torch.device <span class="op">=</span> device):</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Makes a prediction on a target image and plots the image with its prediction."""</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Load in image and convert the tensor values to float32</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>    target_image <span class="op">=</span> torchvision.io.read_image(<span class="bu">str</span>(image_path)).<span class="bu">type</span>(torch.float32)</span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Divide the image pixel values by 255 to get them between [0, 1]</span></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>    target_image <span class="op">=</span> target_image <span class="op">/</span> <span class="fl">255.</span> </span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Transform if necessary</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> transform:</span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>        target_image <span class="op">=</span> transform(target_image)</span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Make sure the model is on the target device</span></span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a>    model.to(device)</span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Turn on model evaluation mode and inference mode</span></span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.inference_mode():</span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add an extra dimension to the image</span></span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a>        target_image <span class="op">=</span> target_image.unsqueeze(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Make a prediction on image with an extra dimension and send it to the target device</span></span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a>        target_image_pred <span class="op">=</span> model(target_image.to(device))</span>
<span id="cb119-29"><a href="#cb119-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb119-30"><a href="#cb119-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6. Convert logits -&gt; prediction probabilities (using torch.softmax() for multi-class classification)</span></span>
<span id="cb119-31"><a href="#cb119-31" aria-hidden="true" tabindex="-1"></a>    target_image_pred_probs <span class="op">=</span> torch.softmax(target_image_pred, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb119-32"><a href="#cb119-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-33"><a href="#cb119-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 7. Convert prediction probabilities -&gt; prediction labels</span></span>
<span id="cb119-34"><a href="#cb119-34" aria-hidden="true" tabindex="-1"></a>    target_image_pred_label <span class="op">=</span> torch.argmax(target_image_pred_probs, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb119-35"><a href="#cb119-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-36"><a href="#cb119-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 8. Plot the image alongside the prediction and prediction probability</span></span>
<span id="cb119-37"><a href="#cb119-37" aria-hidden="true" tabindex="-1"></a>    plt.imshow(target_image.squeeze().permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>)) <span class="co"># make sure it's the right size for matplotlib</span></span>
<span id="cb119-38"><a href="#cb119-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> class_names:</span>
<span id="cb119-39"><a href="#cb119-39" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="ss">f"Pred: </span><span class="sc">{</span>class_names[target_image_pred_label.cpu()]<span class="sc">}</span><span class="ss"> | Prob: </span><span class="sc">{</span>target_image_pred_probs<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>cpu()<span class="sc">:.3f}</span><span class="ss">"</span></span>
<span id="cb119-40"><a href="#cb119-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: </span>
<span id="cb119-41"><a href="#cb119-41" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="ss">f"Pred: </span><span class="sc">{</span>target_image_pred_label<span class="sc">}</span><span class="ss"> | Prob: </span><span class="sc">{</span>target_image_pred_probs<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>cpu()<span class="sc">:.3f}</span><span class="ss">"</span></span>
<span id="cb119-42"><a href="#cb119-42" aria-hidden="true" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb119-43"><a href="#cb119-43" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="va">False</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>What a nice looking function, let’s test it out.</p>
<div id="cell-169" class="cell" data-execution_count="77">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pred on our custom image</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>pred_and_plot_image(model<span class="op">=</span>model_1,</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>                    image_path<span class="op">=</span>custom_image_path,</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>                    class_names<span class="op">=</span>class_names,</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>                    transform<span class="op">=</span>custom_image_transform,</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>                    device<span class="op">=</span>device)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_pytorch_custom_datasets_files/figure-html/cell-74-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Two thumbs up again!</p>
<p>Looks like our model got the prediction right just by guessing.</p>
<p>This won’t always be the case with other images though…</p>
<p>The image is pixelated too because we resized it to <code>[64, 64]</code> using <code>custom_image_transform</code>.</p>
<blockquote class="blockquote">
<p><strong>Exercise:</strong> Try making a prediction with one of your own images of pizza, steak or sushi and see what happens.</p>
</blockquote>
</section>
</section>
<section id="main-takeaways" class="level2" data-number="6.16">
<h2 data-number="6.16" class="anchored" data-anchor-id="main-takeaways"><span class="header-section-number">6.16</span> Main takeaways</h2>
<p>We’ve covered a fair bit in this module.</p>
<p>Let’s summarise it with a few dot points.</p>
<ul>
<li>PyTorch has many in-built functions to deal with all kinds of data, from vision to text to audio to recommendation systems.</li>
<li>If PyTorch’s built-in data loading functions don’t suit your requirements, you can write code to create your own custom datasets by subclassing <code>torch.utils.data.Dataset</code>.</li>
<li><code>torch.utils.data.DataLoader</code>’s in PyTorch help turn your <code>Dataset</code>’s into iterables that can be used when training and testing a model.</li>
<li>A lot of machine learning is dealing with the balance between <strong>overfitting</strong> and <strong>underfitting</strong> (we discussed different methods for each above, so a good exercise would be to research more and writing code to try out the different techniques).</li>
<li>Predicting on your own custom data with a trained model is possible, as long as you format the data into a similar format to what the model was trained on. Make sure you take care of the three big PyTorch and deep learning errors:
<ol type="1">
<li><strong>Wrong datatypes</strong> - Your model expected <code>torch.float32</code> when your data is <code>torch.uint8</code>.</li>
<li><strong>Wrong data shapes</strong> - Your model expected <code>[batch_size, color_channels, height, width]</code> when your data is <code>[color_channels, height, width]</code>.</li>
<li><strong>Wrong devices</strong> - Your model is on the GPU but your data is on the CPU.</li>
</ol></li>
</ul>
</section>
<section id="연습-문제" class="level2" data-number="6.17">
<h2 data-number="6.17" class="anchored" data-anchor-id="연습-문제"><span class="header-section-number">6.17</span> 연습 문제</h2>
<p>All of the exercises are focused on practicing the code in the sections above.</p>
<p>You should be able to complete them by referencing each section or by following the resource(s) linked.</p>
<p>All exercises should be completed using <a href="https://pytorch.org/docs/stable/notes/cuda.html#device-agnostic-code">device-agnostic code</a>.</p>
<p><strong>Resources:</strong> * <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/extras/exercises/04_pytorch_custom_datasets_exercises.ipynb">Exercise template notebook for 04</a> * <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/extras/solutions/04_pytorch_custom_datasets_exercise_solutions.ipynb">Example solutions notebook for 04</a> (try the exercises <em>before</em> looking at this)</p>
<ol type="1">
<li>Our models are underperforming (not fitting the data well). What are 3 methods for preventing underfitting? Write them down and explain each with a sentence.</li>
<li>Recreate the data loading functions we built in sections 1, 2, 3 and 4. You should have train and test <code>DataLoader</code>’s ready to use.</li>
<li>Recreate <code>model_0</code> we built in section 7.</li>
<li>Create training and testing functions for <code>model_0</code>.</li>
<li>Try training the model you made in exercise 3 for 5, 20 and 50 epochs, what happens to the results?
<ul>
<li>Use <code>torch.optim.Adam()</code> with a learning rate of 0.001 as the optimizer.</li>
</ul></li>
<li>Double the number of hidden units in your model and train it for 20 epochs, what happens to the results?</li>
<li>Double the data you’re using with your model and train it for 20 epochs, what happens to the results?
<ul>
<li><strong>참고:</strong> You can use the <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/extras/04_custom_data_creation.ipynb">custom data creation notebook</a> to scale up your Food101 dataset.</li>
<li>You can also find the <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/data/pizza_steak_sushi_20_percent.zip">already formatted double data (20% instead of 10% subset) dataset on GitHub</a>, you will need to write download code like in exercise 2 to get it into this notebook.</li>
</ul></li>
<li>Make a prediction on your own custom image of pizza/steak/sushi (you could even download one from the internet) and share your prediction.
<ul>
<li>Does the model you trained in exercise 7 get it right?</li>
<li>If not, what do you think you could do to improve it?</li>
</ul></li>
</ol>
</section>
<section id="추가-학습-자료" class="level2" data-number="6.18">
<h2 data-number="6.18" class="anchored" data-anchor-id="추가-학습-자료"><span class="header-section-number">6.18</span> 추가 학습 자료</h2>
<ul>
<li>To practice your knowledge of PyTorch <code>Dataset</code>’s and <code>DataLoader</code>’s through PyTorch <a href="https://pytorch.org/tutorials/beginner/basics/data_tutorial.html">datasets and dataloaders tutorial notebook</a>.</li>
<li>Spend 10-minutes reading the <a href="https://pytorch.org/vision/stable/transforms.html">PyTorch <code>torchvision.transforms</code> documentation</a>.
<ul>
<li>You can see demos of transforms in action in the <a href="https://pytorch.org/vision/main/auto_examples/transforms/plot_transforms_illustrations.html">illustrations of transforms tutorial</a>.</li>
</ul></li>
<li>Spend 10-minutes reading the PyTorch <a href="https://pytorch.org/vision/stable/datasets.html"><code>torchvision.datasets</code> documentation</a>.
<ul>
<li>What are some datasets that stand out to you?</li>
<li>How could you try building a model on these?</li>
</ul></li>
<li><a href="https://pytorch.org/data/beta/index.html">TorchData is currently in beta</a> (as of April 2022), it’ll be a future way of loading data in PyTorch, but you can start to check it out now.</li>
<li>To speed up deep learning models, you can do a few tricks to improve compute, memory and overhead computations, for more read the post <a href="https://horace.io/brrr_intro.html"><em>Making Deep Learning Go Brrrr From First Principles</em></a> by Horace He.</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./03_pytorch_computer_vision.html" class="pagination-link" aria-label="03 - PyTorch 컴퓨터 비전">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">03 - PyTorch 컴퓨터 비전</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./05_pytorch_going_modular.html" class="pagination-link" aria-label="05 - PyTorch 모듈화">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">05 - PyTorch 모듈화</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>9&nbsp; 07 - PyTorch 실험 추적 – 파이토치 딥러닝 입문</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./08_pytorch_paper_replicating.html" rel="next">
<link href="./06_pytorch_transfer_learning.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-803ae4f7a8810f475153517dc3c4ebae.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./07_pytorch_experiment_tracking.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">07 - PyTorch 실험 추적</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">파이토치 딥러닝 입문</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">딥러닝을 위한 PyTorch 배우기</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_pytorch_fundamentals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">00 - PyTorch 기초</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_pytorch_workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">01 - PyTorch 워크플로우</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_pytorch_classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">02 - PyTorch 신경망 분류</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_pytorch_computer_vision.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">03 - PyTorch 컴퓨터 비전</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_pytorch_custom_datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">04 - PyTorch 사용자 정의 데이터셋</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_pytorch_going_modular.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">05 - PyTorch 모듈화</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_pytorch_transfer_learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">06 - PyTorch 전이 학습</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_pytorch_experiment_tracking.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">07 - PyTorch 실험 추적</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_pytorch_paper_replicating.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">08 - PyTorch 논문 복제</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09_pytorch_model_deployment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">09 - PyTorch 모델 배포</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#what-is-experiment-tracking" id="toc-what-is-experiment-tracking" class="nav-link active" data-scroll-target="#what-is-experiment-tracking"><span class="header-section-number">9.1</span> What is experiment tracking?</a></li>
  <li><a href="#why-track-experiments" id="toc-why-track-experiments" class="nav-link" data-scroll-target="#why-track-experiments"><span class="header-section-number">9.2</span> Why track experiments?</a></li>
  <li><a href="#different-ways-to-track-machine-learning-experiments" id="toc-different-ways-to-track-machine-learning-experiments" class="nav-link" data-scroll-target="#different-ways-to-track-machine-learning-experiments"><span class="header-section-number">9.3</span> Different ways to track machine learning experiments</a></li>
  <li><a href="#what-were-going-to-cover" id="toc-what-were-going-to-cover" class="nav-link" data-scroll-target="#what-were-going-to-cover"><span class="header-section-number">9.4</span> What we’re going to cover</a></li>
  <li><a href="#where-can-you-get-help" id="toc-where-can-you-get-help" class="nav-link" data-scroll-target="#where-can-you-get-help"><span class="header-section-number">9.5</span> Where can you get help?</a></li>
  <li><a href="#getting-setup" id="toc-getting-setup" class="nav-link" data-scroll-target="#getting-setup"><span class="header-section-number">9.6</span> 0. Getting setup</a>
  <ul class="collapse">
  <li><a href="#create-a-helper-function-to-set-seeds" id="toc-create-a-helper-function-to-set-seeds" class="nav-link" data-scroll-target="#create-a-helper-function-to-set-seeds"><span class="header-section-number">9.6.1</span> Create a helper function to set seeds</a></li>
  </ul></li>
  <li><a href="#get-data" id="toc-get-data" class="nav-link" data-scroll-target="#get-data"><span class="header-section-number">9.7</span> 1. Get data</a></li>
  <li><a href="#create-datasets-and-dataloaders" id="toc-create-datasets-and-dataloaders" class="nav-link" data-scroll-target="#create-datasets-and-dataloaders"><span class="header-section-number">9.8</span> 2. Create Datasets and DataLoaders</a>
  <ul class="collapse">
  <li><a href="#create-dataloaders-using-manually-created-transforms" id="toc-create-dataloaders-using-manually-created-transforms" class="nav-link" data-scroll-target="#create-dataloaders-using-manually-created-transforms"><span class="header-section-number">9.8.1</span> 2.1 Create DataLoaders using manually created transforms</a></li>
  <li><a href="#create-dataloaders-using-automatically-created-transforms" id="toc-create-dataloaders-using-automatically-created-transforms" class="nav-link" data-scroll-target="#create-dataloaders-using-automatically-created-transforms"><span class="header-section-number">9.8.2</span> 2.2 Create DataLoaders using automatically created transforms</a></li>
  </ul></li>
  <li><a href="#getting-a-pretrained-model-freezing-the-base-layers-and-changing-the-classifier-head" id="toc-getting-a-pretrained-model-freezing-the-base-layers-and-changing-the-classifier-head" class="nav-link" data-scroll-target="#getting-a-pretrained-model-freezing-the-base-layers-and-changing-the-classifier-head"><span class="header-section-number">9.9</span> 3. Getting a pretrained model, freezing the base layers and changing the classifier head</a></li>
  <li><a href="#train-model-and-track-results" id="toc-train-model-and-track-results" class="nav-link" data-scroll-target="#train-model-and-track-results"><span class="header-section-number">9.10</span> 4. Train model and track results</a>
  <ul class="collapse">
  <li><a href="#adjust-train-function-to-track-results-with-summarywriter" id="toc-adjust-train-function-to-track-results-with-summarywriter" class="nav-link" data-scroll-target="#adjust-train-function-to-track-results-with-summarywriter"><span class="header-section-number">9.10.1</span> Adjust <code>train()</code> function to track results with <code>SummaryWriter()</code></a></li>
  </ul></li>
  <li><a href="#view-our-models-results-in-tensorboard" id="toc-view-our-models-results-in-tensorboard" class="nav-link" data-scroll-target="#view-our-models-results-in-tensorboard"><span class="header-section-number">9.11</span> 5. View our model’s results in TensorBoard</a></li>
  <li><a href="#create-a-helper-function-to-build-summarywriter-instances" id="toc-create-a-helper-function-to-build-summarywriter-instances" class="nav-link" data-scroll-target="#create-a-helper-function-to-build-summarywriter-instances"><span class="header-section-number">9.12</span> 6. Create a helper function to build <code>SummaryWriter()</code> instances</a>
  <ul class="collapse">
  <li><a href="#update-the-train-function-to-include-a-writer-parameter" id="toc-update-the-train-function-to-include-a-writer-parameter" class="nav-link" data-scroll-target="#update-the-train-function-to-include-a-writer-parameter"><span class="header-section-number">9.12.1</span> 6.1 Update the <code>train()</code> function to include a <code>writer</code> parameter</a></li>
  </ul></li>
  <li><a href="#setting-up-a-series-of-modelling-experiments" id="toc-setting-up-a-series-of-modelling-experiments" class="nav-link" data-scroll-target="#setting-up-a-series-of-modelling-experiments"><span class="header-section-number">9.13</span> 7. Setting up a series of modelling experiments</a>
  <ul class="collapse">
  <li><a href="#what-kind-of-experiments-should-you-run" id="toc-what-kind-of-experiments-should-you-run" class="nav-link" data-scroll-target="#what-kind-of-experiments-should-you-run"><span class="header-section-number">9.13.1</span> 7.1 What kind of experiments should you run?</a></li>
  <li><a href="#what-experiments-are-we-going-to-run" id="toc-what-experiments-are-we-going-to-run" class="nav-link" data-scroll-target="#what-experiments-are-we-going-to-run"><span class="header-section-number">9.13.2</span> 7.2 What experiments are we going to run?</a></li>
  <li><a href="#download-different-datasets" id="toc-download-different-datasets" class="nav-link" data-scroll-target="#download-different-datasets"><span class="header-section-number">9.13.3</span> 7.3 Download different datasets</a></li>
  <li><a href="#transform-datasets-and-create-dataloaders" id="toc-transform-datasets-and-create-dataloaders" class="nav-link" data-scroll-target="#transform-datasets-and-create-dataloaders"><span class="header-section-number">9.13.4</span> 7.4 Transform Datasets and create DataLoaders</a></li>
  <li><a href="#create-feature-extractor-models" id="toc-create-feature-extractor-models" class="nav-link" data-scroll-target="#create-feature-extractor-models"><span class="header-section-number">9.13.5</span> 7.5 Create feature extractor models</a></li>
  <li><a href="#create-experiments-and-set-up-training-code" id="toc-create-experiments-and-set-up-training-code" class="nav-link" data-scroll-target="#create-experiments-and-set-up-training-code"><span class="header-section-number">9.13.6</span> 7.6 Create experiments and set up training code</a></li>
  </ul></li>
  <li><a href="#view-experiments-in-tensorboard" id="toc-view-experiments-in-tensorboard" class="nav-link" data-scroll-target="#view-experiments-in-tensorboard"><span class="header-section-number">9.14</span> 8. View experiments in TensorBoard</a></li>
  <li><a href="#load-in-the-best-model-and-make-predictions-with-it" id="toc-load-in-the-best-model-and-make-predictions-with-it" class="nav-link" data-scroll-target="#load-in-the-best-model-and-make-predictions-with-it"><span class="header-section-number">9.15</span> 9. Load in the best model and make predictions with it</a>
  <ul class="collapse">
  <li><a href="#predict-on-a-custom-image-with-the-best-model" id="toc-predict-on-a-custom-image-with-the-best-model" class="nav-link" data-scroll-target="#predict-on-a-custom-image-with-the-best-model"><span class="header-section-number">9.15.1</span> 9.1 Predict on a custom image with the best model</a></li>
  </ul></li>
  <li><a href="#main-takeaways" id="toc-main-takeaways" class="nav-link" data-scroll-target="#main-takeaways"><span class="header-section-number">9.16</span> Main takeaways</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">9.17</span> Exercises</a></li>
  <li><a href="#extra-curriculum" id="toc-extra-curriculum" class="nav-link" data-scroll-target="#extra-curriculum"><span class="header-section-number">9.18</span> Extra-curriculum</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">07 - PyTorch 실험 추적</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><a href="https://colab.research.google.com/github/mrdbourke/pytorch-deep-learning/blob/main/07_pytorch_experiment_tracking.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<blockquote class="blockquote">
<p><strong>Note:</strong> This notebook uses <code>torchvision</code>’s upcoming <a href="https://pytorch.org/blog/introducing-torchvision-new-multi-weight-support-api/">multi-weight support API (coming in <code>torchvision</code> v0.13)</a>.</p>
<p>As of June 2022, it requires the <a href="https://pytorch.org/get-started/locally/">nightly versions of PyTorch and <code>torchvision</code> be installed</a>.</p>
<p>Once <code>torchvision</code> v0.13 becomes the standard (not nightly), the nightly version of <code>torchvision</code> will no longer need to be installed.</p>
</blockquote>
<p>We’ve trained a fair few models now on the journey to making FoodVision Mini (an image classification model to classify images of pizza, steak or sushi).</p>
<p>And so far we’ve keep track of them via Python dictionaries.</p>
<p>Or just comparing them by the metric print outs during training.</p>
<p>What if you wanted to run a dozen (or more) different models at once?</p>
<p>Surely there’s a better way…</p>
<p>There is.</p>
<p><strong>Experiment tracking.</strong></p>
<p>And since experiment tracking is so important and integral to machine learning, you can consider this notebook your first milestone project.</p>
<p>So welcome to Milestone Project 1: FoodVision Mini Experiment Tracking.</p>
<p>We’re going to answer the question: <strong>how do I track my machine learning experiments?</strong></p>
<section id="what-is-experiment-tracking" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="what-is-experiment-tracking"><span class="header-section-number">9.1</span> What is experiment tracking?</h2>
<p>Machine learning and deep learning are very experimental.</p>
<p>You have to put on your artist’s beret/chef’s hat to cook up lots of different models.</p>
<p>And you have to put on your scientist’s coat to track the results of various combinations of data, model architectures and training regimes.</p>
<p>That’s where <strong>experiment tracking</strong> comes in.</p>
<p>If you’re running lots of different experiments, <strong>experiment tracking helps you figure out what works and what doesn’t</strong>.</p>
</section>
<section id="why-track-experiments" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="why-track-experiments"><span class="header-section-number">9.2</span> Why track experiments?</h2>
<p>If you’re only running a handful of models (like we’ve done so far), it might be okay just to track their results in print outs and a few dictionaries.</p>
<p>However, as the number of experiments you run starts to increase, this naive way of tracking could get out of hand.</p>
<p>So if you’re following the machine learning practitioner’s motto of <em>experiment, experiment, experiment!</em>, you’ll want a way to track them.</p>
<p><img src="https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/07-experiment-tracking-can-get-out-of-hand.png" alt="experiment tracking can get out of hand, many different experiments with different names" width="900/"></p>
<p><em>After building a few models and tracking their results, you’ll start to notice how quickly it can get out of hand.</em></p>
</section>
<section id="different-ways-to-track-machine-learning-experiments" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="different-ways-to-track-machine-learning-experiments"><span class="header-section-number">9.3</span> Different ways to track machine learning experiments</h2>
<p>There are as many different ways to track machine learning experiments as there is experiments to run.</p>
<p>This table covers a few.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th><strong>Method</strong></th>
<th><strong>Setup</strong></th>
<th><strong>Pros</strong></th>
<th><strong>Cons</strong></th>
<th><strong>Cost</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Python dictionaries, CSV files, print outs</td>
<td>None</td>
<td>Easy to setup, runs in pure Python</td>
<td>Hard to keep track of large numbers of experiments</td>
<td>Free</td>
</tr>
<tr class="even">
<td><a href="https://www.tensorflow.org/tensorboard/get_started">TensorBoard</a></td>
<td>Minimal, install <a href="https://pypi.org/project/tensorboard/"><code>tensorboard</code></a></td>
<td>Extensions built into PyTorch, widely recognized and used, easily scales.</td>
<td>User-experience not as nice as other options.</td>
<td>Free</td>
</tr>
<tr class="odd">
<td><a href="https://wandb.ai/site/experiment-tracking">Weights &amp; Biases Experiment Tracking</a></td>
<td>Minimal, install <a href="https://docs.wandb.ai/quickstart"><code>wandb</code></a>, make an account</td>
<td>Incredible user experience, make experiments public, tracks almost anything.</td>
<td>Requires external resource outside of PyTorch.</td>
<td>Free for personal use</td>
</tr>
<tr class="even">
<td><a href="https://mlflow.org/">MLFlow</a></td>
<td>Minimal, install <code>mlflow</code> and starting tracking</td>
<td>Fully open-source MLOps lifecycle management, many integrations.</td>
<td>Little bit harder to setup a remote tracking server than other services.</td>
<td>Free</td>
</tr>
</tbody>
</table>
<p><img src="https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/07-different-places-to-track-experiments.png" alt="various places to track machine learning experiments" width="900/"></p>
<p><em>Various places and techniques you can use to track your machine learning experiments. <strong>Note:</strong> There are various other options similar to Weights &amp; Biases and open-source options similar to MLflow but I’ve left them out for brevity. You can find more by searching “machine learning experiment tracking”.</em></p>
</section>
<section id="what-were-going-to-cover" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="what-were-going-to-cover"><span class="header-section-number">9.4</span> What we’re going to cover</h2>
<p>We’re going to be running several different modelling experiments with various levels of data, model size and training time to try and improve on FoodVision Mini.</p>
<p>And due to its tight integration with PyTorch and widespread use, this notebook focuses on using TensorBoard to track our experiments.</p>
<p>However, the principles we’re going to cover are similar across all of the other tools for experiment tracking.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Topic</strong></th>
<th><strong>Contents</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>0. Getting setup</strong></td>
<td>We’ve written a fair bit of useful code over the past few sections, let’s download it and make sure we can use it again.</td>
</tr>
<tr class="even">
<td><strong>1. Get data</strong></td>
<td>Let’s get the pizza, steak and sushi image classification dataset we’ve been using to try and improve our FoodVision Mini model’s results.</td>
</tr>
<tr class="odd">
<td><strong>2. Create Datasets and DataLoaders</strong></td>
<td>We’ll use the <code>data_setup.py</code> script we wrote in chapter 05. PyTorch Going Modular to setup our DataLoaders.</td>
</tr>
<tr class="even">
<td><strong>3. Get and customise a pretrained model</strong></td>
<td>Just like the last section, 06. PyTorch Transfer Learning we’ll download a pretrained model from <code>torchvision.models</code> and customise it to our own problem.</td>
</tr>
<tr class="odd">
<td><strong>4. Train model amd track results</strong></td>
<td>Let’s see what it’s like to train and track the training results of a single model using TensorBoard.</td>
</tr>
<tr class="even">
<td><strong>5. View our model’s results in TensorBoard</strong></td>
<td>Previously we visualized our model’s loss curves with a helper function, now let’s see what they look like in TensorBoard.</td>
</tr>
<tr class="odd">
<td><strong>6. Creating a helper function to track experiments</strong></td>
<td>If we’re going to be adhering to the machine learner practitioner’s motto of <em>experiment, experiment, experiment!</em>, we best create a function that will help us save our modelling experiment results.</td>
</tr>
<tr class="even">
<td><strong>7. Setting up a series of modelling experiments</strong></td>
<td>Instead of running experiments one by one, how about we write some code to run several experiments at once, with different models, different amounts of data and different training times.</td>
</tr>
<tr class="odd">
<td><strong>8. View modelling experiments in TensorBoard</strong></td>
<td>By this stage we’ll have run eight modelling experiments in one go, a fair bit to keep track of, let’s what their results look like in TensorBoard.</td>
</tr>
<tr class="even">
<td><strong>9. Load in the best model and make predictions with it</strong></td>
<td>The point of experiment tracking is to figure out which model performs the best, let’s load in the best performing model and make some predictions with it to <em>visualize, visualize, visualize!</em>.</td>
</tr>
</tbody>
</table>
</section>
<section id="where-can-you-get-help" class="level2" data-number="9.5">
<h2 data-number="9.5" class="anchored" data-anchor-id="where-can-you-get-help"><span class="header-section-number">9.5</span> Where can you get help?</h2>
<p>All of the materials for this course <a href="https://github.com/mrdbourke/pytorch-deep-learning">are available on GitHub</a>.</p>
<p>If you run into trouble, you can ask a question on the course <a href="https://github.com/mrdbourke/pytorch-deep-learning/discussions">GitHub Discussions page</a>.</p>
<p>And of course, there’s the <a href="https://pytorch.org/docs/stable/index.html">PyTorch documentation</a> and <a href="https://discuss.pytorch.org/">PyTorch developer forums</a>, a very helpful place for all things PyTorch.</p>
</section>
<section id="getting-setup" class="level2" data-number="9.6">
<h2 data-number="9.6" class="anchored" data-anchor-id="getting-setup"><span class="header-section-number">9.6</span> 0. Getting setup</h2>
<p>Let’s start by downloading all of the modules we’ll need for this section.</p>
<p>To save us writing extra code, we’re going to be leveraging some of the Python scripts (such as <code>data_setup.py</code> and <code>engine.py</code>) we created in section, <a href="https://www.learnpytorch.io/05_pytorch_going_modular/">05. PyTorch Going Modular</a>.</p>
<p>Specifically, we’re going to download the <a href="https://github.com/mrdbourke/pytorch-deep-learning/tree/main/going_modular"><code>going_modular</code></a> directory from the <code>pytorch-deep-learning</code> repository (if we don’t already have it).</p>
<p>We’ll also get the <a href="https://github.com/TylerYep/torchinfo"><code>torchinfo</code></a> package if it’s not available.</p>
<p><code>torchinfo</code> will help later on to give us visual summaries of our model(s).</p>
<p>And since we’re using a newer version of the <code>torchvision</code> package (v0.13 as of June 2022), we’ll make sure we’ve got the latest versions.</p>
<div id="cell-8" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For this notebook to run with updated APIs, we need torch 1.12+ and torchvision 0.13+</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> torch</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> torchvision</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">int</span>(torch.__version__.split(<span class="st">"."</span>)[<span class="dv">1</span>]) <span class="op">&gt;=</span> <span class="dv">12</span>, <span class="st">"torch version should be 1.12+"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">int</span>(torchvision.__version__.split(<span class="st">"."</span>)[<span class="dv">1</span>]) <span class="op">&gt;=</span> <span class="dv">13</span>, <span class="st">"torchvision version should be 0.13+"</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"torch version: </span><span class="sc">{</span>torch<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"torchvision version: </span><span class="sc">{</span>torchvision<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"[INFO] torch/torchvision versions not as required, installing nightly versions."</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>pip3 install <span class="op">-</span>U <span class="op">--</span>pre torch torchvision torchaudio <span class="op">--</span>extra<span class="op">-</span>index<span class="op">-</span>url https:<span class="op">//</span>download.pytorch.org<span class="op">/</span>whl<span class="op">/</span>nightly<span class="op">/</span>cu113</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> torch</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> torchvision</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"torch version: </span><span class="sc">{</span>torch<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"torchvision version: </span><span class="sc">{</span>torchvision<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>torch version: 1.13.0.dev20220620+cu113
torchvision version: 0.14.0.dev20220620+cu113</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p><strong>Note:</strong> If you’re using Google Colab, you may have to restart your runtime after running the above cell. After restarting, you can run the cell again and verify you’ve got the right versions of <code>torch</code> (0.12+) and <code>torchvision</code> (0.13+).</p>
</blockquote>
<div id="cell-10" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Continue with regular imports</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> transforms</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Try to get torchinfo, install it if it doesn't work</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> torchinfo <span class="im">import</span> summary</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"[INFO] Couldn't find torchinfo... installing it."</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>pip install <span class="op">-</span>q torchinfo</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> torchinfo <span class="im">import</span> summary</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Try to import the going_modular directory, download it from GitHub if it doesn't work</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> going_modular.going_modular <span class="im">import</span> data_setup, engine</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the going_modular scripts</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"[INFO] Couldn't find going_modular scripts... downloading them from GitHub."</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>git clone https:<span class="op">//</span>github.com<span class="op">/</span>mrdbourke<span class="op">/</span>pytorch<span class="op">-</span>deep<span class="op">-</span>learning</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>mv pytorch<span class="op">-</span>deep<span class="op">-</span>learning<span class="op">/</span>going_modular .</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>rm <span class="op">-</span>rf pytorch<span class="op">-</span>deep<span class="op">-</span>learning</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> going_modular.going_modular <span class="im">import</span> data_setup, engine</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now let’s setup device agnostic code.</p>
<blockquote class="blockquote">
<p><strong>Note:</strong> If you’re using Google Colab, and you don’t have a GPU turned on yet, it’s now time to turn one on via <code>Runtime -&gt; Change runtime type -&gt; Hardware accelerator -&gt; GPU</code>.</p>
</blockquote>
<div id="cell-12" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> <span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>device</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>'cuda'</code></pre>
</div>
</div>
<section id="create-a-helper-function-to-set-seeds" class="level3" data-number="9.6.1">
<h3 data-number="9.6.1" class="anchored" data-anchor-id="create-a-helper-function-to-set-seeds"><span class="header-section-number">9.6.1</span> Create a helper function to set seeds</h3>
<p>Since we’ve been setting random seeds a whole bunch throughout previous sections, how about we functionize it?</p>
<p>Let’s create a function to “set the seeds” called <code>set_seeds()</code>.</p>
<blockquote class="blockquote">
<p><strong>Note:</strong> Recall a <a href="https://en.wikipedia.org/wiki/Random_seed">random seed</a> is a way of flavouring the randomness generated by a computer. They aren’t necessary to always set when running machine learning code, however, they help ensure there’s an element of reproducibility (the numbers I get with my code are similar to the numbers you get with your code). Outside of an education or experimental setting, random seeds generally aren’t required.</p>
</blockquote>
<div id="cell-14" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seeds</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_seeds(seed: <span class="bu">int</span><span class="op">=</span><span class="dv">42</span>):</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Sets random sets for torch operations.</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">        seed (int, optional): Random seed to set. Defaults to 42.</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the seed for general torch operations</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    torch.manual_seed(seed)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the seed for CUDA torch operations (ones that happen on the GPU)</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    torch.cuda.manual_seed(seed)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="get-data" class="level2" data-number="9.7">
<h2 data-number="9.7" class="anchored" data-anchor-id="get-data"><span class="header-section-number">9.7</span> 1. Get data</h2>
<p>As always, before we can run machine learning experiments, we’ll need a dataset.</p>
<p>We’re going to continue trying to improve upon the results we’ve been getting on FoodVision Mini.</p>
<p>In the previous section, <a href="https://www.learnpytorch.io/06_pytorch_transfer_learning/">06. PyTorch Transfer Learning</a>, we saw how powerful using a pretrained model and transfer learning could be when classifying images of pizza, steak and sushi.</p>
<p>So how about we run some experiments and try to further improve our results?</p>
<p>To do so, we’ll use similar code to the previous section to download the <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/data/pizza_steak_sushi.zip"><code>pizza_steak_sushi.zip</code></a> (if the data doesn’t already exist) except this time its been functionised.</p>
<p>This will allow us to use it again later.</p>
<div id="cell-16" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zipfile</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_data(source: <span class="bu">str</span>, </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                  destination: <span class="bu">str</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                  remove_source: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> Path:</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Downloads a zipped dataset from source and unzips to destination.</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">        source (str): A link to a zipped file containing data.</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">        destination (str): A target directory to unzip data to.</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co">        remove_source (bool): Whether to remove the source after downloading and extracting.</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="co">        pathlib.Path to downloaded data.</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Example usage:</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="co">        download_data(source="https://github.com/mrdbourke/pytorch-deep-learning/raw/main/data/pizza_steak_sushi.zip",</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="co">                      destination="pizza_steak_sushi")</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup path to data folder</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    data_path <span class="op">=</span> Path(<span class="st">"data/"</span>)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    image_path <span class="op">=</span> data_path <span class="op">/</span> destination</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the image folder doesn't exist, download it and prepare it... </span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> image_path.is_dir():</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"[INFO] </span><span class="sc">{</span>image_path<span class="sc">}</span><span class="ss"> directory exists, skipping download."</span>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"[INFO] Did not find </span><span class="sc">{</span>image_path<span class="sc">}</span><span class="ss"> directory, creating one..."</span>)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        image_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Download pizza, steak, sushi data</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>        target_file <span class="op">=</span> Path(source).name</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(data_path <span class="op">/</span> target_file, <span class="st">"wb"</span>) <span class="im">as</span> f:</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>            request <span class="op">=</span> requests.get(source)</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"[INFO] Downloading </span><span class="sc">{</span>target_file<span class="sc">}</span><span class="ss"> from </span><span class="sc">{</span>source<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>            f.write(request.content)</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Unzip pizza, steak, sushi data</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> zipfile.ZipFile(data_path <span class="op">/</span> target_file, <span class="st">"r"</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"[INFO] Unzipping </span><span class="sc">{</span>target_file<span class="sc">}</span><span class="ss"> data..."</span>) </span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>            zip_ref.extractall(image_path)</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove .zip file</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> remove_source:</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>            os.remove(data_path <span class="op">/</span> target_file)</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image_path</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>image_path <span class="op">=</span> download_data(source<span class="op">=</span><span class="st">"https://github.com/mrdbourke/pytorch-deep-learning/raw/main/data/pizza_steak_sushi.zip"</span>,</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>                           destination<span class="op">=</span><span class="st">"pizza_steak_sushi"</span>)</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>image_path</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] data/pizza_steak_sushi directory exists, skipping download.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>PosixPath('data/pizza_steak_sushi')</code></pre>
</div>
</div>
<p>Excellent! Looks like we’ve got our pizza, steak and sushi images in standard image classification format ready to go.</p>
</section>
<section id="create-datasets-and-dataloaders" class="level2" data-number="9.8">
<h2 data-number="9.8" class="anchored" data-anchor-id="create-datasets-and-dataloaders"><span class="header-section-number">9.8</span> 2. Create Datasets and DataLoaders</h2>
<p>Now we’ve got some data, let’s turn it into PyTorch DataLoaders.</p>
<p>We can do so using the <code>create_dataloaders()</code> function we created in <a href="https://www.learnpytorch.io/05_pytorch_going_modular/#2-create-datasets-and-dataloaders-data_setuppy">05. PyTorch Going Modular part 2</a>.</p>
<p>And since we’ll be using transfer learning and specifically pretrained models from <a href="https://pytorch.org/vision/stable/models.html"><code>torchvision.models</code></a>, we’ll create a transform to prepare our images correctly.</p>
<p>To transform our images in tensors, we can use: 1. Manually created transforms using <code>torchvision.transforms</code>. 2. Automatically created transforms using <code>torchvision.models.MODEL_NAME.MODEL_WEIGHTS.DEFAULT.transforms()</code>. * Where <code>MODEL_NAME</code> is a specific <code>torchvision.models</code> architecture, <code>MODEL_WEIGHTS</code> is a specific set of pretrained weights and <code>DEFAULT</code> means the “best available weights”.</p>
<p>We saw an example of each of these in <a href="https://www.learnpytorch.io/06_pytorch_transfer_learning/#2-create-datasets-and-dataloaders">06. PyTorch Transfer Learning section 2</a>.</p>
<p>Let’s see first an example of manually creating a <code>torchvision.transforms</code> pipeline (creating a transforms pipeline this way gives the most customization but can potentially result in performance degradation if the transforms don’t match the pretrained model).</p>
<p>The main manual transformation we need to be sure of is that all of our images are normalized in ImageNet format (this is because pretrained <code>torchvision.models</code> are all pretrained on <a href="https://www.image-net.org/">ImageNet</a>).</p>
<p>We can do this with:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>normalize <span class="op">=</span> transforms.Normalize(mean<span class="op">=</span>[<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>],</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                                 std<span class="op">=</span>[<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="create-dataloaders-using-manually-created-transforms" class="level3" data-number="9.8.1">
<h3 data-number="9.8.1" class="anchored" data-anchor-id="create-dataloaders-using-manually-created-transforms"><span class="header-section-number">9.8.1</span> 2.1 Create DataLoaders using manually created transforms</h3>
<div id="cell-20" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup directories</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>train_dir <span class="op">=</span> image_path <span class="op">/</span> <span class="st">"train"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>test_dir <span class="op">=</span> image_path <span class="op">/</span> <span class="st">"test"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup ImageNet normalization levels (turns all images into similar distribution as ImageNet)</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>normalize <span class="op">=</span> transforms.Normalize(mean<span class="op">=</span>[<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>],</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                                 std<span class="op">=</span>[<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>])</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create transform pipeline manually</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>manual_transforms <span class="op">=</span> transforms.Compose([</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((<span class="dv">224</span>, <span class="dv">224</span>)),</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor(),</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    normalize</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>])           </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Manually created transforms: </span><span class="sc">{</span>manual_transforms<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data loaders</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>train_dataloader, test_dataloader, class_names <span class="op">=</span> data_setup.create_dataloaders(</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    train_dir<span class="op">=</span>train_dir,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    test_dir<span class="op">=</span>test_dir,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    transform<span class="op">=</span>manual_transforms, <span class="co"># use manually created transforms</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">32</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>train_dataloader, test_dataloader, class_names</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Manually created transforms: Compose(
    Resize(size=(224, 224), interpolation=bilinear, max_size=None, antialias=None)
    ToTensor()
    Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225])
)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>(&lt;torch.utils.data.dataloader.DataLoader at 0x7febf1d218e0&gt;,
 &lt;torch.utils.data.dataloader.DataLoader at 0x7febf1d216a0&gt;,
 ['pizza', 'steak', 'sushi'])</code></pre>
</div>
</div>
</section>
<section id="create-dataloaders-using-automatically-created-transforms" class="level3" data-number="9.8.2">
<h3 data-number="9.8.2" class="anchored" data-anchor-id="create-dataloaders-using-automatically-created-transforms"><span class="header-section-number">9.8.2</span> 2.2 Create DataLoaders using automatically created transforms</h3>
<p>Data transformed and DataLoaders created!</p>
<p>Let’s now see what the same transformation pipeline looks like but this time by using automatic transforms.</p>
<p>We can do this by first instantiating a set of pretrained weights (for example <code>weights = torchvision.models.EfficientNet_B0_Weights.DEFAULT</code>) we’d like to use and calling the <code>transforms()</code> method on it.</p>
<div id="cell-22" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup dirs</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>train_dir <span class="op">=</span> image_path <span class="op">/</span> <span class="st">"train"</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>test_dir <span class="op">=</span> image_path <span class="op">/</span> <span class="st">"test"</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup pretrained weights (plenty of these available in torchvision.models)</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> torchvision.models.EfficientNet_B0_Weights.DEFAULT</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Get transforms from weights (these are the transforms that were used to obtain the weights)</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>automatic_transforms <span class="op">=</span> weights.transforms() </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Automatically created transforms: </span><span class="sc">{</span>automatic_transforms<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data loaders</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>train_dataloader, test_dataloader, class_names <span class="op">=</span> data_setup.create_dataloaders(</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    train_dir<span class="op">=</span>train_dir,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    test_dir<span class="op">=</span>test_dir,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    transform<span class="op">=</span>automatic_transforms, <span class="co"># use automatic created transforms</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">32</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>train_dataloader, test_dataloader, class_names</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Automatically created transforms: ImageClassification(
    crop_size=[224]
    resize_size=[256]
    mean=[0.485, 0.456, 0.406]
    std=[0.229, 0.224, 0.225]
    interpolation=InterpolationMode.BICUBIC
)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>(&lt;torch.utils.data.dataloader.DataLoader at 0x7febf1d213a0&gt;,
 &lt;torch.utils.data.dataloader.DataLoader at 0x7febf1d21490&gt;,
 ['pizza', 'steak', 'sushi'])</code></pre>
</div>
</div>
</section>
</section>
<section id="getting-a-pretrained-model-freezing-the-base-layers-and-changing-the-classifier-head" class="level2" data-number="9.9">
<h2 data-number="9.9" class="anchored" data-anchor-id="getting-a-pretrained-model-freezing-the-base-layers-and-changing-the-classifier-head"><span class="header-section-number">9.9</span> 3. Getting a pretrained model, freezing the base layers and changing the classifier head</h2>
<p>Before we run and track multiple modelling experiments, let’s see what it’s like to run and track a single one.</p>
<p>And since our data is ready, the next thing we’ll need is a model.</p>
<p>Let’s download the pretrained weights for a <code>torchvision.models.efficientnet_b0()</code> model and prepare it for use with our own data.</p>
<div id="cell-24" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: This is how a pretrained model would be created in torchvision &gt; 0.13, it will be deprecated in future versions.</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># model = torchvision.models.efficientnet_b0(pretrained=True).to(device) # OLD </span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the pretrained weights for EfficientNet_B0</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> torchvision.models.EfficientNet_B0_Weights.DEFAULT <span class="co"># NEW in torchvision 0.13, "DEFAULT" means "best weights available"</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup the model with the pretrained weights and send it to the target device</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> torchvision.models.efficientnet_b0(weights<span class="op">=</span>weights).to(device)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># View the output of the model</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># model</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Wonderful!</p>
<p>Now we’ve got a pretrained model let’s turn into a feature extractor model.</p>
<p>In essence, we’ll freeze the base layers of the model (we’ll use these to extract features from our input images) and we’ll change the classifier head (output layer) to suit the number of classes we’re working with (we’ve got 3 classes: pizza, steak, sushi).</p>
<blockquote class="blockquote">
<p><strong>Note:</strong> The idea of creating a feature extractor model (what we’re doing here) was covered in more depth in <a href="https://www.learnpytorch.io/06_pytorch_transfer_learning/#32-setting-up-a-pretrained-model">06. PyTorch Transfer Learning section 3.2: Setting up a pretrained model</a>.</p>
</blockquote>
<div id="cell-26" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Freeze all base layers by setting requires_grad attribute to False</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> param <span class="kw">in</span> model.features.parameters():</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    param.requires_grad <span class="op">=</span> <span class="va">False</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we're creating a new layer with random weights (torch.nn.Linear), </span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># let's set the seeds</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>set_seeds() </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Update the classifier head to suit our problem</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>model.classifier <span class="op">=</span> torch.nn.Sequential(</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    nn.Dropout(p<span class="op">=</span><span class="fl">0.2</span>, inplace<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    nn.Linear(in_features<span class="op">=</span><span class="dv">1280</span>, </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>              out_features<span class="op">=</span><span class="bu">len</span>(class_names),</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>              bias<span class="op">=</span><span class="va">True</span>).to(device))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Base layers frozen, classifier head changed, let’s get a summary of our model with <code>torchinfo.summary()</code>.</p>
<div id="cell-28" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchinfo <span class="im">import</span> summary</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># # Get a summary of the model (uncomment for full output)</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(model, </span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">#         input_size=(32, 3, 224, 224), # make sure this is "input_size", not "input_shape" (batch_size, color_channels, height, width)</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">#         verbose=0,</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">#         col_names=["input_size", "output_size", "num_params", "trainable"],</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">#         col_width=20,</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         row_settings=["var_names"]</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><img src="https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/07-output-of-torchinfo-summary.png" alt="output of torchinfo.summary() when passed our model when base layers are frozen and classifier head is updated" width="900/"></p>
<p><em>Output of <code>torchinfo.summary()</code> with our feature extractor EffNetB0 model, notice how the base layers are frozen (not trainable) and the output layers are customized to our own problem.</em></p>
</section>
<section id="train-model-and-track-results" class="level2" data-number="9.10">
<h2 data-number="9.10" class="anchored" data-anchor-id="train-model-and-track-results"><span class="header-section-number">9.10</span> 4. Train model and track results</h2>
<p>Model ready to go!</p>
<p>Let’s get ready to train it by creating a loss function and an optimizer.</p>
<p>Since we’re working with multiple classes, we’ll use <a href="https://pytorch.org/docs/stable/generated/torch.nn.CrossEntropyLoss.html"><code>torch.nn.CrossEntropyLoss()</code></a> as the loss function.</p>
<p>And we’ll stick with <a href="https://pytorch.org/docs/stable/optim.html"><code>torch.optim.Adam()</code></a> with learning rate of <code>0.001</code> for the optimizer.</p>
<div id="cell-31" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define loss and optimizer</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="adjust-train-function-to-track-results-with-summarywriter" class="level3" data-number="9.10.1">
<h3 data-number="9.10.1" class="anchored" data-anchor-id="adjust-train-function-to-track-results-with-summarywriter"><span class="header-section-number">9.10.1</span> Adjust <code>train()</code> function to track results with <code>SummaryWriter()</code></h3>
<p>Beautiful!</p>
<p>All of the pieces of our training code are starting to come together.</p>
<p>Let’s now add the final piece to track our experiments.</p>
<p>Previously, we’ve tracked our modelling experiments using multiple Python dictionaries (one for each model).</p>
<p>But you can imagine this could get out of hand if we were running anything more than a few experiments.</p>
<p>Not to worry, there’s a better option!</p>
<p>We can use PyTorch’s <a href="https://pytorch.org/docs/stable/tensorboard.html"><code>torch.utils.tensorboard.SummaryWriter()</code></a> class to save various parts of our model’s training progress to file.</p>
<p>By default, the <code>SummaryWriter()</code> class saves various information about our model to a file set by the <code>log_dir</code> parameter.</p>
<p>The default location for <code>log_dir</code> is under <code>runs/CURRENT_DATETIME_HOSTNAME</code>, where the <code>HOSTNAME</code> is the name of your computer.</p>
<p>But of course, you can change where your experiments are tracked (the filename is as customisable as you’d like).</p>
<p>The outputs of the <code>SummaryWriter()</code> are saved in <a href="https://www.tensorflow.org/tensorboard/">TensorBoard format</a>.</p>
<p>TensorBoard is a part of the TensorFlow deep learning library and is an excellent way to visualize different parts of your model.</p>
<p>To start tracking our modelling experiments, let’s create a default <code>SummaryWriter()</code> instance.</p>
<div id="cell-33" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> torch.utils.tensorboard <span class="im">import</span> SummaryWriter</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"[INFO] Couldn't find tensorboard... installing it."</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>pip install <span class="op">-</span>q tensorboard</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> torch.utils.tensorboard <span class="im">import</span> SummaryWriter</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a writer with all default settings</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>writer <span class="op">=</span> SummaryWriter()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now to use the writer, we could write a new training loop or we could adjust the existing <code>train()</code> function we created in <a href="https://www.learnpytorch.io/05_pytorch_going_modular/#4-creating-train_step-and-test_step-functions-and-train-to-combine-them">05. PyTorch Going Modular section 4</a>.</p>
<p>Let’s take the latter option.</p>
<p>We’ll get the <code>train()</code> function from <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/going_modular/going_modular/engine.py"><code>engine.py</code></a> and adjust it to use <code>writer</code>.</p>
<p>Specifically, we’ll add the ability for our <code>train()</code> function to log our model’s training and test loss and accuracy values.</p>
<p>We can do this with <a href="https://pytorch.org/docs/stable/tensorboard.html#torch.utils.tensorboard.writer.SummaryWriter.add_scalars"><code>writer.add_scalars(main_tag, tag_scalar_dict)</code></a>, where: * <code>main_tag</code> (string) - the name for the scalars being tracked (e.g.&nbsp;“Accuracy”) * <code>tag_scalar_dict</code> (dict) - a dictionary of the values being tracked (e.g.&nbsp;<code>{"train_loss": 0.3454}</code>) * &gt; <strong>Note:</strong> The method is called <code>add_scalars()</code> because our loss and accuracy values are generally scalars (single values).</p>
<p>Once we’ve finished tracking values, we’ll call <code>writer.close()</code> to tell the <code>writer</code> to stop looking for values to track.</p>
<p>To start modifying <code>train()</code> we’ll also import <code>train_step()</code> and <code>test_step()</code> from <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/going_modular/going_modular/engine.py"><code>engine.py</code></a>.</p>
<blockquote class="blockquote">
<p><strong>Note:</strong> You can track information about your model almost anywhere in your code. But quite often experiments will be tracked <em>while</em> a model is training (inside a training/testing loop).</p>
<p>The <code>torch.utils.tensorboard.SummaryWriter()</code> class also has many different methods to track different things about your model/data, such as <a href="https://pytorch.org/docs/stable/tensorboard.html#torch.utils.tensorboard.writer.SummaryWriter.add_graph"><code>add_graph()</code></a> which tracks the computation graph of your model. For more options, <a href="https://pytorch.org/docs/stable/tensorboard.html#torch.utils.tensorboard.writer.SummaryWriter">check the <code>SummaryWriter()</code> documentation</a>.</p>
</blockquote>
<div id="cell-35" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> going_modular.going_modular.engine <span class="im">import</span> train_step, test_step</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Import train() function from: </span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/mrdbourke/pytorch-deep-learning/blob/main/going_modular/going_modular/engine.py</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(model: torch.nn.Module, </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>          train_dataloader: torch.utils.data.DataLoader, </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>          test_dataloader: torch.utils.data.DataLoader, </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>          optimizer: torch.optim.Optimizer,</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>          loss_fn: torch.nn.Module,</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>          epochs: <span class="bu">int</span>,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>          device: torch.device) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, List]:</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Trains and tests a PyTorch model.</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Passes a target PyTorch models through train_step() and test_step()</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co">    functions for a number of epochs, training and testing the model</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="co">    in the same epoch loop.</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculates, prints and stores evaluation metrics throughout.</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="co">      model: A PyTorch model to be trained and tested.</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="co">      train_dataloader: A DataLoader instance for the model to be trained on.</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="co">      test_dataloader: A DataLoader instance for the model to be tested on.</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="co">      optimizer: A PyTorch optimizer to help minimize the loss function.</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="co">      loss_fn: A PyTorch loss function to calculate loss on both datasets.</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="co">      epochs: An integer indicating how many epochs to train for.</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="co">      device: A target device to compute on (e.g. "cuda" or "cpu").</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="co">      </span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="co">      A dictionary of training and testing loss as well as training and</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="co">      testing accuracy metrics. Each metric has a value in a list for </span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="co">      each epoch.</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="co">      In the form: {train_loss: [...],</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="co">                train_acc: [...],</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="co">                test_loss: [...],</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="co">                test_acc: [...]} </span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="co">      For example if training for epochs=2: </span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="co">              {train_loss: [2.0616, 1.0537],</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="co">                train_acc: [0.3945, 0.3945],</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="co">                test_loss: [1.2641, 1.5706],</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="co">                test_acc: [0.3400, 0.2973]} </span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create empty results dictionary</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {<span class="st">"train_loss"</span>: [],</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>               <span class="st">"train_acc"</span>: [],</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>               <span class="st">"test_loss"</span>: [],</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>               <span class="st">"test_acc"</span>: []</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through training and testing steps for a number of epochs</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(epochs)):</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>        train_loss, train_acc <span class="op">=</span> train_step(model<span class="op">=</span>model,</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>                                           dataloader<span class="op">=</span>train_dataloader,</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>                                           loss_fn<span class="op">=</span>loss_fn,</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>                                           optimizer<span class="op">=</span>optimizer,</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>                                           device<span class="op">=</span>device)</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>        test_loss, test_acc <span class="op">=</span> test_step(model<span class="op">=</span>model,</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>                                        dataloader<span class="op">=</span>test_dataloader,</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>                                        loss_fn<span class="op">=</span>loss_fn,</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>                                        device<span class="op">=</span>device)</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print out what's happening</span></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"Epoch: </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss"> | "</span></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"train_loss: </span><span class="sc">{</span>train_loss<span class="sc">:.4f}</span><span class="ss"> | "</span></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"train_acc: </span><span class="sc">{</span>train_acc<span class="sc">:.4f}</span><span class="ss"> | "</span></span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"test_loss: </span><span class="sc">{</span>test_loss<span class="sc">:.4f}</span><span class="ss"> | "</span></span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"test_acc: </span><span class="sc">{</span>test_acc<span class="sc">:.4f}</span><span class="ss">"</span></span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update results dictionary</span></span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"train_loss"</span>].append(train_loss)</span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"train_acc"</span>].append(train_acc)</span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"test_loss"</span>].append(test_loss)</span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"test_acc"</span>].append(test_acc)</span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a>        <span class="co">### New: Experiment tracking </span><span class="al">###</span></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add loss results to SummaryWriter</span></span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>        writer.add_scalars(main_tag<span class="op">=</span><span class="st">"Loss"</span>, </span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a>                           tag_scalar_dict<span class="op">=</span>{<span class="st">"train_loss"</span>: train_loss,</span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">"test_loss"</span>: test_loss},</span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>                           global_step<span class="op">=</span>epoch)</span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add accuracy results to SummaryWriter</span></span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>        writer.add_scalars(main_tag<span class="op">=</span><span class="st">"Accuracy"</span>, </span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>                           tag_scalar_dict<span class="op">=</span>{<span class="st">"train_acc"</span>: train_acc,</span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">"test_acc"</span>: test_acc}, </span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a>                           global_step<span class="op">=</span>epoch)</span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Track the PyTorch model architecture</span></span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a>        writer.add_graph(model<span class="op">=</span>model, </span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># Pass in an example input</span></span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a>                         input_to_model<span class="op">=</span>torch.randn(<span class="dv">32</span>, <span class="dv">3</span>, <span class="dv">224</span>, <span class="dv">224</span>).to(device))</span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Close the writer</span></span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a>    writer.close()</span>
<span id="cb22-100"><a href="#cb22-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-101"><a href="#cb22-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">### End new </span><span class="al">###</span></span>
<span id="cb22-102"><a href="#cb22-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-103"><a href="#cb22-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the filled results at the end of the epochs</span></span>
<span id="cb22-104"><a href="#cb22-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Woohoo!</p>
<p>Our <code>train()</code> function is now updated to use a <code>SummaryWriter()</code> instance to track our model’s results.</p>
<p>How about we try it out for 5 epochs?</p>
<div id="cell-37" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train model</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: Not using engine.train() since the original script isn't updated to use writer</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>set_seeds()</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> train(model<span class="op">=</span>model,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                train_dataloader<span class="op">=</span>train_dataloader,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                test_dataloader<span class="op">=</span>test_dataloader,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                optimizer<span class="op">=</span>optimizer,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                loss_fn<span class="op">=</span>loss_fn,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>                epochs<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>                device<span class="op">=</span>device)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bf70c256625142c283475bdf9af948a1","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch: 1 | train_loss: 1.0924 | train_acc: 0.3984 | test_loss: 0.9133 | test_acc: 0.5398
Epoch: 2 | train_loss: 0.8975 | train_acc: 0.6562 | test_loss: 0.7838 | test_acc: 0.8561
Epoch: 3 | train_loss: 0.8037 | train_acc: 0.7461 | test_loss: 0.6723 | test_acc: 0.8864
Epoch: 4 | train_loss: 0.6769 | train_acc: 0.8516 | test_loss: 0.6698 | test_acc: 0.8049
Epoch: 5 | train_loss: 0.7065 | train_acc: 0.7188 | test_loss: 0.6746 | test_acc: 0.7737</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p><strong>Note:</strong> You might notice the results here are slightly different to what our model got in 06. PyTorch Transfer Learning. The difference comes from using the <code>engine.train()</code> and our modified <code>train()</code> function. Can you guess why? The <a href="https://pytorch.org/docs/stable/notes/randomness.html">PyTorch documentation on randomness</a> may help more.</p>
</blockquote>
<p>Running the cell above we get similar outputs we got in <a href="https://www.learnpytorch.io/06_pytorch_transfer_learning/#4-train-model">06. PyTorch Transfer Learning section 4: Train model</a> but the difference is behind the scenes our <code>writer</code> instance has created a <code>runs/</code> directory storing our model’s results.</p>
<p>For example, the save location might look like:</p>
<pre><code>runs/Jun21_00-46-03_daniels_macbook_pro</code></pre>
<p>Where the <a href="https://pytorch.org/docs/stable/tensorboard.html#torch.utils.tensorboard.writer.SummaryWriter">default format</a> is <code>runs/CURRENT_DATETIME_HOSTNAME</code>.</p>
<p>We’ll check these out in a second but just as a reminder, we were previously tracking our model’s results in a dictionary.</p>
<div id="cell-39" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check out the model results</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>results</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>{'train_loss': [1.0923754647374153,
  0.8974628075957298,
  0.803724929690361,
  0.6769256368279457,
  0.7064960040152073],
 'train_acc': [0.3984375, 0.65625, 0.74609375, 0.8515625, 0.71875],
 'test_loss': [0.9132757981618246,
  0.7837507526079813,
  0.6722926497459412,
  0.6698453426361084,
  0.6746167540550232],
 'test_acc': [0.5397727272727273,
  0.8560606060606061,
  0.8863636363636364,
  0.8049242424242425,
  0.7736742424242425]}</code></pre>
</div>
</div>
<p>Hmmm, we could format this to be a nice plot but could you image keeping track of a bunch of these dictionaries?</p>
<p>There has to be a better way…</p>
</section>
</section>
<section id="view-our-models-results-in-tensorboard" class="level2" data-number="9.11">
<h2 data-number="9.11" class="anchored" data-anchor-id="view-our-models-results-in-tensorboard"><span class="header-section-number">9.11</span> 5. View our model’s results in TensorBoard</h2>
<p>The <code>SummaryWriter()</code> class stores our model’s results in a directory called <code>runs/</code> in TensorBoard format by default.</p>
<p>TensorBoard is a visualization program created by the TensorFlow team to view and inspect information about models and data.</p>
<p>You know what that means?</p>
<p>It’s time to follow the data visualizer’s motto and <em>visualize, visualize, visualize!</em></p>
<p>You can view TensorBoard in a number of ways:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Code environment</th>
<th>How to view TensorBoard</th>
<th>Resource</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>VS Code (notebooks or Python scripts)</td>
<td>Press <code>SHIFT + CMD + P</code> to open the Command Palette and search for the command “Python: Launch TensorBoard”.</td>
<td><a href="https://code.visualstudio.com/docs/datascience/pytorch-support#_tensorboard-integration">VS Code Guide on TensorBoard and PyTorch</a></td>
</tr>
<tr class="even">
<td>Jupyter and Colab Notebooks</td>
<td>Make sure <a href="https://pypi.org/project/tensorboard/">TensorBoard is installed</a>, load it with <code>%load_ext tensorboard</code> and then view your results with <code>%tensorboard --logdir DIR_WITH_LOGS</code>.</td>
<td><a href="https://pytorch.org/docs/stable/tensorboard.html"><code>torch.utils.tensorboard</code></a> and <a href="https://www.tensorflow.org/tensorboard/get_started">Get started with TensorBoard</a></td>
</tr>
</tbody>
</table>
<p>You can also upload your experiments to <a href="https://tensorboard.dev/">tensorboard.dev</a> to share them publicly with others.</p>
<p>Running the following code in a Google Colab or Jupyter Notebook will start an interactive TensorBoard session to view TensorBoard files in the <code>runs/</code> directory.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext tensorboard <span class="co"># line magic to load TensorBoard</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>tensorboard <span class="op">--</span>logdir runs <span class="co"># run TensorBoard session with the "runs/" directory</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="cell-42" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example code to run in Jupyter or Google Colab Notebook (uncomment to try it out)</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># %load_ext tensorboard</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># %tensorboard --logdir runs</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>If all went correctly, you should see something like the following:</p>
<p><img src="https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/07-tensorboard-single-experiment.png" alt="output of viewing a single experiment in tensorboard" width="900/"></p>
<p><em>Viewing a single modelling experiment’s results for accuracy and loss in TensorBoard.</em></p>
<blockquote class="blockquote">
<p><strong>Note:</strong> For more information on running TensorBoard in notebooks or in other locations, see the following: * <a href="https://www.tensorflow.org/tensorboard/tensorboard_in_notebooks">Using TensorBoard in Notebooks guide by TensorFlow</a> * <a href="https://tensorboard.dev/#get-started">Get started with TensorBoard.dev</a> (helpful for uploading your TensorBoard logs to a shareable link)</p>
</blockquote>
</section>
<section id="create-a-helper-function-to-build-summarywriter-instances" class="level2" data-number="9.12">
<h2 data-number="9.12" class="anchored" data-anchor-id="create-a-helper-function-to-build-summarywriter-instances"><span class="header-section-number">9.12</span> 6. Create a helper function to build <code>SummaryWriter()</code> instances</h2>
<p>The <code>SummaryWriter()</code> class logs various information to a directory specified by the <code>log_dir</code> parameter.</p>
<p>How about we make a helper function to create a custom directory per experiment?</p>
<p>In essence, each experiment gets its own logs directory.</p>
<p>For example, say we’d like to track things like: * <strong>Experiment date/timestamp</strong> - when did the experiment take place? * <strong>Experiment name</strong> - is there something we’d like to call the experiment? * <strong>Model name</strong> - what model was used? * <strong>Extra</strong> - should anything else be tracked?</p>
<p>You could track almost anything here and be as creative as you want but these should be enough to start.</p>
<p>Let’s create a helper function called <code>create_writer()</code> that produces a <code>SummaryWriter()</code> instance tracking to a custom <code>log_dir</code>.</p>
<p>Ideally, we’d like the <code>log_dir</code> to be something like:</p>
<p><code>runs/YYYY-MM-DD/experiment_name/model_name/extra</code></p>
<p>Where <code>YYYY-MM-DD</code> is the date the experiment was run (you could add the time if you wanted to as well).</p>
<div id="cell-45" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_writer(experiment_name: <span class="bu">str</span>, </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>                  model_name: <span class="bu">str</span>, </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                  extra: <span class="bu">str</span><span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> torch.utils.tensorboard.writer.SummaryWriter():</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Creates a torch.utils.tensorboard.writer.SummaryWriter() instance saving to a specific log_dir.</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co">    log_dir is a combination of runs/timestamp/experiment_name/model_name/extra.</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Where timestamp is the current date in YYYY-MM-DD format.</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">        experiment_name (str): Name of experiment.</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co">        model_name (str): Name of model.</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co">        extra (str, optional): Anything extra to add to the directory. Defaults to None.</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="co">        torch.utils.tensorboard.writer.SummaryWriter(): Instance of a writer saving to log_dir.</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Example usage:</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="co">        # Create a writer saving to "runs/2022-06-04/data_10_percent/effnetb2/5_epochs/"</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="co">        writer = create_writer(experiment_name="data_10_percent",</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="co">                               model_name="effnetb2",</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="co">                               extra="5_epochs")</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="co">        # The above is the same as:</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="co">        writer = SummaryWriter(log_dir="runs/2022-06-04/data_10_percent/effnetb2/5_epochs/")</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> os</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get timestamp of current date (all experiments on certain day live in same folder)</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    timestamp <span class="op">=</span> datetime.now().strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>) <span class="co"># returns current date in YYYY-MM-DD format</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> extra:</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create log directory path</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>        log_dir <span class="op">=</span> os.path.join(<span class="st">"runs"</span>, timestamp, experiment_name, model_name, extra)</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>        log_dir <span class="op">=</span> os.path.join(<span class="st">"runs"</span>, timestamp, experiment_name, model_name)</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"[INFO] Created SummaryWriter, saving to: </span><span class="sc">{</span>log_dir<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> SummaryWriter(log_dir<span class="op">=</span>log_dir)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Beautiful!</p>
<p>Now we’ve got a <code>create_writer()</code> function, let’s try it out.</p>
<div id="cell-47" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an example writer</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>example_writer <span class="op">=</span> create_writer(experiment_name<span class="op">=</span><span class="st">"data_10_percent"</span>,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                               model_name<span class="op">=</span><span class="st">"effnetb0"</span>,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                               extra<span class="op">=</span><span class="st">"5_epochs"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Created SummaryWriter, saving to: runs/2022-06-23/data_10_percent/effnetb0/5_epochs...</code></pre>
</div>
</div>
<p>Looking good, now we’ve got a way to log and trace back our various experiments.</p>
<section id="update-the-train-function-to-include-a-writer-parameter" class="level3" data-number="9.12.1">
<h3 data-number="9.12.1" class="anchored" data-anchor-id="update-the-train-function-to-include-a-writer-parameter"><span class="header-section-number">9.12.1</span> 6.1 Update the <code>train()</code> function to include a <code>writer</code> parameter</h3>
<p>Our <code>create_writer()</code> function works fantastic.</p>
<p>How about we give our <code>train()</code> function the ability to take in a <code>writer</code> parameter so we actively update the <code>SummaryWriter()</code> instance we’re using each time we call <code>train()</code>.</p>
<p>For example, say we’re running a series of experiments, calling <code>train()</code> multiple times for multiple different models, it would be good if each experiment used a different <code>writer</code>.</p>
<p>One <code>writer</code> per experiment = one logs directory per experiment.</p>
<p>To adjust the <code>train()</code> function we’ll add a <code>writer</code> parameter to the function and then we’ll add some code to see if there’s a <code>writer</code> and if so, we’ll track our information there.</p>
<div id="cell-50" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add writer parameter to train()</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(model: torch.nn.Module, </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>          train_dataloader: torch.utils.data.DataLoader, </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>          test_dataloader: torch.utils.data.DataLoader, </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>          optimizer: torch.optim.Optimizer,</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>          loss_fn: torch.nn.Module,</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>          epochs: <span class="bu">int</span>,</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>          device: torch.device, </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>          writer: torch.utils.tensorboard.writer.SummaryWriter <span class="co"># new parameter to take in a writer</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>          ) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, List]:</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Trains and tests a PyTorch model.</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Passes a target PyTorch models through train_step() and test_step()</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="co">    functions for a number of epochs, training and testing the model</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="co">    in the same epoch loop.</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculates, prints and stores evaluation metrics throughout.</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Stores metrics to specified writer log_dir if present.</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a><span class="co">      model: A PyTorch model to be trained and tested.</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a><span class="co">      train_dataloader: A DataLoader instance for the model to be trained on.</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="co">      test_dataloader: A DataLoader instance for the model to be tested on.</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a><span class="co">      optimizer: A PyTorch optimizer to help minimize the loss function.</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a><span class="co">      loss_fn: A PyTorch loss function to calculate loss on both datasets.</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a><span class="co">      epochs: An integer indicating how many epochs to train for.</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a><span class="co">      device: A target device to compute on (e.g. "cuda" or "cpu").</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="co">      writer: A SummaryWriter() instance to log model results to.</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a><span class="co">      A dictionary of training and testing loss as well as training and</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a><span class="co">      testing accuracy metrics. Each metric has a value in a list for </span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a><span class="co">      each epoch.</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a><span class="co">      In the form: {train_loss: [...],</span></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a><span class="co">                train_acc: [...],</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a><span class="co">                test_loss: [...],</span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a><span class="co">                test_acc: [...]} </span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a><span class="co">      For example if training for epochs=2: </span></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a><span class="co">              {train_loss: [2.0616, 1.0537],</span></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a><span class="co">                train_acc: [0.3945, 0.3945],</span></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a><span class="co">                test_loss: [1.2641, 1.5706],</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a><span class="co">                test_acc: [0.3400, 0.2973]} </span></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create empty results dictionary</span></span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {<span class="st">"train_loss"</span>: [],</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>               <span class="st">"train_acc"</span>: [],</span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>               <span class="st">"test_loss"</span>: [],</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>               <span class="st">"test_acc"</span>: []</span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through training and testing steps for a number of epochs</span></span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(epochs)):</span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>        train_loss, train_acc <span class="op">=</span> train_step(model<span class="op">=</span>model,</span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>                                          dataloader<span class="op">=</span>train_dataloader,</span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>                                          loss_fn<span class="op">=</span>loss_fn,</span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a>                                          optimizer<span class="op">=</span>optimizer,</span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>                                          device<span class="op">=</span>device)</span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>        test_loss, test_acc <span class="op">=</span> test_step(model<span class="op">=</span>model,</span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>          dataloader<span class="op">=</span>test_dataloader,</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>          loss_fn<span class="op">=</span>loss_fn,</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>          device<span class="op">=</span>device)</span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print out what's happening</span></span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(</span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"Epoch: </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss"> | "</span></span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"train_loss: </span><span class="sc">{</span>train_loss<span class="sc">:.4f}</span><span class="ss"> | "</span></span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"train_acc: </span><span class="sc">{</span>train_acc<span class="sc">:.4f}</span><span class="ss"> | "</span></span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"test_loss: </span><span class="sc">{</span>test_loss<span class="sc">:.4f}</span><span class="ss"> | "</span></span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"test_acc: </span><span class="sc">{</span>test_acc<span class="sc">:.4f}</span><span class="ss">"</span></span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update results dictionary</span></span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"train_loss"</span>].append(train_loss)</span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"train_acc"</span>].append(train_acc)</span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"test_loss"</span>].append(test_loss)</span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"test_acc"</span>].append(test_acc)</span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a>        <span class="co">### New: Use the writer parameter to track experiments </span><span class="al">###</span></span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># See if there's a writer, if so, log to it</span></span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> writer:</span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add results to SummaryWriter</span></span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a>            writer.add_scalars(main_tag<span class="op">=</span><span class="st">"Loss"</span>, </span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a>                               tag_scalar_dict<span class="op">=</span>{<span class="st">"train_loss"</span>: train_loss,</span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">"test_loss"</span>: test_loss},</span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a>                               global_step<span class="op">=</span>epoch)</span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a>            writer.add_scalars(main_tag<span class="op">=</span><span class="st">"Accuracy"</span>, </span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a>                               tag_scalar_dict<span class="op">=</span>{<span class="st">"train_acc"</span>: train_acc,</span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">"test_acc"</span>: test_acc}, </span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a>                               global_step<span class="op">=</span>epoch)</span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Close the writer</span></span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a>            writer.close()</span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">### End new </span><span class="al">###</span></span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the filled results at the end of the epochs</span></span>
<span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="setting-up-a-series-of-modelling-experiments" class="level2" data-number="9.13">
<h2 data-number="9.13" class="anchored" data-anchor-id="setting-up-a-series-of-modelling-experiments"><span class="header-section-number">9.13</span> 7. Setting up a series of modelling experiments</h2>
<p>It’s to step things up a notch.</p>
<p>Previously we’ve been running various experiments and inspecting the results one by one.</p>
<p>But what if we could run multiple experiments and then inspect the results all together?</p>
<p>You in?</p>
<p>C’mon, let’s go.</p>
<section id="what-kind-of-experiments-should-you-run" class="level3" data-number="9.13.1">
<h3 data-number="9.13.1" class="anchored" data-anchor-id="what-kind-of-experiments-should-you-run"><span class="header-section-number">9.13.1</span> 7.1 What kind of experiments should you run?</h3>
<p>That’s the million dollar question in machine learning.</p>
<p>Because there’s really no limit to the experiments you can run.</p>
<p>Such a freedom is why machine learning is so exciting and terrifying at the same time.</p>
<p>This is where you’ll have to put on your scientist coat and remember the machine learning practitioner’s motto: <em>experiment, experiment, experiment!</em></p>
<p>Every hyperparameter stands as a starting point for a different experiment: * Change the number of <strong>epochs</strong>. * Change the number of <strong>layers/hidden units</strong>. * Change the amount of <strong>data</strong>. * Change the <strong>learning rate</strong>. * Try different kinds of <strong>data augmentation</strong>. * Choose a different <strong>model architecture</strong>.</p>
<p>With practice and running many different experiments, you’ll start to build an intuition of what <em>might</em> help your model.</p>
<p>I say <em>might</em> on purpose because there’s no guarantees.</p>
<p>But generally, in light of <a href="http://www.incompleteideas.net/IncIdeas/BitterLesson.html"><em>The Bitter Lesson</em></a> (I’ve mentioned this twice now because it’s an important essay in the world of AI), generally the bigger your model (more learnable parameters) and the more data you have (more opportunities to learn), the better the performance.</p>
<p>However, when you’re first approaching a machine learning problem: start small and if something works, scale it up.</p>
<p>Your first batch of experiments should take no longer than a few seconds to a few minutes to run.</p>
<p>The quicker you can experiment, the faster you can work out what <em>doesn’t</em> work, in turn, the faster you can work out what <em>does</em> work.</p>
</section>
<section id="what-experiments-are-we-going-to-run" class="level3" data-number="9.13.2">
<h3 data-number="9.13.2" class="anchored" data-anchor-id="what-experiments-are-we-going-to-run"><span class="header-section-number">9.13.2</span> 7.2 What experiments are we going to run?</h3>
<p>Our goal is to improve the model powering FoodVision Mini without it getting too big.</p>
<p>In essence, our ideal model achieves a high level of test set accuracy (90%+) but doesn’t take too long to train/perform inference (make predictions).</p>
<p>We’ve got plenty of options but how about we keep things simple?</p>
<p>Let’s try a combination of: 1. A different amount of data (10% of Pizza, Steak, Sushi vs.&nbsp;20%) 2. A different model (<a href="https://pytorch.org/vision/stable/generated/torchvision.models.efficientnet_b0.html#torchvision.models.efficientnet_b0"><code>torchvision.models.efficientnet_b0</code></a> vs.&nbsp;<a href="https://pytorch.org/vision/stable/generated/torchvision.models.efficientnet_b2.html#torchvision.models.efficientnet_b2"><code>torchvision.models.efficientnet_b2</code></a>) 3. A different training time (5 epochs vs.&nbsp;10 epochs)</p>
<p>Breaking these down we get:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Experiment number</th>
<th>Training Dataset</th>
<th>Model (pretrained on ImageNet)</th>
<th>Number of epochs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Pizza, Steak, Sushi 10% percent</td>
<td>EfficientNetB0</td>
<td>5</td>
</tr>
<tr class="even">
<td>2</td>
<td>Pizza, Steak, Sushi 10% percent</td>
<td>EfficientNetB2</td>
<td>5</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Pizza, Steak, Sushi 10% percent</td>
<td>EfficientNetB0</td>
<td>10</td>
</tr>
<tr class="even">
<td>4</td>
<td>Pizza, Steak, Sushi 10% percent</td>
<td>EfficientNetB2</td>
<td>10</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Pizza, Steak, Sushi 20% percent</td>
<td>EfficientNetB0</td>
<td>5</td>
</tr>
<tr class="even">
<td>6</td>
<td>Pizza, Steak, Sushi 20% percent</td>
<td>EfficientNetB2</td>
<td>5</td>
</tr>
<tr class="odd">
<td>7</td>
<td>Pizza, Steak, Sushi 20% percent</td>
<td>EfficientNetB0</td>
<td>10</td>
</tr>
<tr class="even">
<td>8</td>
<td>Pizza, Steak, Sushi 20% percent</td>
<td>EfficientNetB2</td>
<td>10</td>
</tr>
</tbody>
</table>
<p>Notice how we’re slowly scaling things up.</p>
<p>With each experiment we slowly increase the amount of data, the model size and the length of training.</p>
<p>By the end, experiment 8 will be using double the data, double the model size and double the length of training compared to experiment 1.</p>
<blockquote class="blockquote">
<p><strong>Note:</strong> I want to be clear that there truly is no limit to amount of experiments you can run. What we’ve designed here is only a very small subset of options. However, you can’t test <em>everything</em> so best to try a few things to begin with and then follow the ones which work the best.</p>
<p>And as a reminder, the datasets we’re using are a subset of the <a href="https://pytorch.org/vision/stable/generated/torchvision.datasets.Food101.html#torchvision.datasets.Food101">Food101 dataset</a> (3 classes, pizza, steak, suhsi, instead of 101) and 10% and 20% of the images rather than 100%. If our experiments work, we could start to run more on more data (though this will take longer to compute). You can see how the datasets were created via the <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/extras/04_custom_data_creation.ipynb"><code>04_custom_data_creation.ipynb</code> notebook</a>.</p>
</blockquote>
</section>
<section id="download-different-datasets" class="level3" data-number="9.13.3">
<h3 data-number="9.13.3" class="anchored" data-anchor-id="download-different-datasets"><span class="header-section-number">9.13.3</span> 7.3 Download different datasets</h3>
<p>Before we start running our series of experiments, we need to make sure our datasets are ready.</p>
<p>We’ll need two forms of a training set: 1. A training set with <strong>10% of the data</strong> of Food101 pizza, steak, sushi images (we’ve already created this above but we’ll do it again for completeness). 2. A training set with <strong>20% of the data</strong> of Food101 pizza, steak, sushi images.</p>
<p>For consistency, all experiments will use the same testing dataset (the one from the 10% data split).</p>
<p>We’ll start by downloading the various datasets we need using the <code>download_data()</code> function we created earlier.</p>
<p>Both datasets are available from the course GitHub: 1. <a href="https://github.com/mrdbourke/pytorch-deep-learning/raw/main/data/pizza_steak_sushi.zip">Pizza, steak, sushi 10% training data</a>. 2. <a href="https://github.com/mrdbourke/pytorch-deep-learning/raw/main/data/pizza_steak_sushi_20_percent.zip">Pizza, steak, sushi 20% training data</a>.</p>
<div id="cell-55" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download 10 percent and 20 percent training data (if necessary)</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>data_10_percent_path <span class="op">=</span> download_data(source<span class="op">=</span><span class="st">"https://github.com/mrdbourke/pytorch-deep-learning/raw/main/data/pizza_steak_sushi.zip"</span>,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>                                     destination<span class="op">=</span><span class="st">"pizza_steak_sushi"</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>data_20_percent_path <span class="op">=</span> download_data(source<span class="op">=</span><span class="st">"https://github.com/mrdbourke/pytorch-deep-learning/raw/main/data/pizza_steak_sushi_20_percent.zip"</span>,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>                                     destination<span class="op">=</span><span class="st">"pizza_steak_sushi_20_percent"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] data/pizza_steak_sushi directory exists, skipping download.
[INFO] data/pizza_steak_sushi_20_percent directory exists, skipping download.</code></pre>
</div>
</div>
<p>Data downloaded!</p>
<p>Now let’s setup the filepaths to data we’ll be using for the different experiments.</p>
<p>We’ll create different training directory paths but we’ll only need one testing directory path since all experiments will be using the same test dataset (the test dataset from pizza, steak, sushi 10%).</p>
<div id="cell-57" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup training directory paths</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>train_dir_10_percent <span class="op">=</span> data_10_percent_path <span class="op">/</span> <span class="st">"train"</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>train_dir_20_percent <span class="op">=</span> data_20_percent_path <span class="op">/</span> <span class="st">"train"</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup testing directory paths (note: use the same test dataset for both to compare the results)</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>test_dir <span class="op">=</span> data_10_percent_path <span class="op">/</span> <span class="st">"test"</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the directories</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Training directory 10%: </span><span class="sc">{</span>train_dir_10_percent<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Training directory 20%: </span><span class="sc">{</span>train_dir_20_percent<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Testing directory: </span><span class="sc">{</span>test_dir<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training directory 10%: data/pizza_steak_sushi/train
Training directory 20%: data/pizza_steak_sushi_20_percent/train
Testing directory: data/pizza_steak_sushi/test</code></pre>
</div>
</div>
</section>
<section id="transform-datasets-and-create-dataloaders" class="level3" data-number="9.13.4">
<h3 data-number="9.13.4" class="anchored" data-anchor-id="transform-datasets-and-create-dataloaders"><span class="header-section-number">9.13.4</span> 7.4 Transform Datasets and create DataLoaders</h3>
<p>Next we’ll create a series of transforms to prepare our images for our model(s).</p>
<p>To keep things consistent, we’ll manually create a transform (just like we did above) and use the same transform across all of the datasets.</p>
<p>The transform will: 1. Resize all the images (we’ll start with 224, 224 but this could be changed). 2. Turn them into tensors with values between 0 &amp; 1. 3. Normalize them in way so their distributions are inline with the ImageNet dataset (we do this because our models from <a href="https://pytorch.org/vision/stable/models.html"><code>torchvision.models</code></a> have been pretrained on ImageNet).</p>
<div id="cell-59" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> transforms</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a transform to normalize data distribution to be inline with ImageNet</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>normalize <span class="op">=</span> transforms.Normalize(mean<span class="op">=</span>[<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>], <span class="co"># values per colour channel [red, green, blue]</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>                                 std<span class="op">=</span>[<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>]) <span class="co"># values per colour channel [red, green, blue]</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Compose transforms into a pipeline</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>simple_transform <span class="op">=</span> transforms.Compose([</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((<span class="dv">224</span>, <span class="dv">224</span>)), <span class="co"># 1. Resize the images</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor(), <span class="co"># 2. Turn the images into tensors with values between 0 &amp; 1</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    normalize <span class="co"># 3. Normalize the images so their distributions match the ImageNet dataset </span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Transform ready!</p>
<p>Now let’s create our DataLoaders using the <code>create_dataloaders()</code> function from <code>data_setup.py</code> we created in <a href="https://www.learnpytorch.io/05_pytorch_going_modular/#2-create-datasets-and-dataloaders-data_setuppy">05. PyTorch Going Modular section 2</a>.</p>
<p>We’ll create the DataLoaders with a batch size of 32.</p>
<p>For all of our experiments we’ll be using the same <code>test_dataloader</code> (to keep comparisons consistent).</p>
<div id="cell-61" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create 10% training and test DataLoaders</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>train_dataloader_10_percent, test_dataloader, class_names <span class="op">=</span> data_setup.create_dataloaders(train_dir<span class="op">=</span>train_dir_10_percent,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    test_dir<span class="op">=</span>test_dir, </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    transform<span class="op">=</span>simple_transform,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>BATCH_SIZE</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create 20% training and test data DataLoders</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>train_dataloader_20_percent, test_dataloader, class_names <span class="op">=</span> data_setup.create_dataloaders(train_dir<span class="op">=</span>train_dir_20_percent,</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    test_dir<span class="op">=</span>test_dir,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    transform<span class="op">=</span>simple_transform,</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>BATCH_SIZE</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the number of samples/batches per dataloader (using the same test_dataloader for both experiments)</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of batches of size </span><span class="sc">{</span>BATCH_SIZE<span class="sc">}</span><span class="ss"> in 10 percent training data: </span><span class="sc">{</span><span class="bu">len</span>(train_dataloader_10_percent)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of batches of size </span><span class="sc">{</span>BATCH_SIZE<span class="sc">}</span><span class="ss"> in 20 percent training data: </span><span class="sc">{</span><span class="bu">len</span>(train_dataloader_20_percent)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of batches of size </span><span class="sc">{</span>BATCH_SIZE<span class="sc">}</span><span class="ss"> in testing data: </span><span class="sc">{</span><span class="bu">len</span>(train_dataloader_10_percent)<span class="sc">}</span><span class="ss"> (all experiments will use the same test set)"</span>)</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of classes: </span><span class="sc">{</span><span class="bu">len</span>(class_names)<span class="sc">}</span><span class="ss">, class names: </span><span class="sc">{</span>class_names<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of batches of size 32 in 10 percent training data: 8
Number of batches of size 32 in 20 percent training data: 15
Number of batches of size 32 in testing data: 8 (all experiments will use the same test set)
Number of classes: 3, class names: ['pizza', 'steak', 'sushi']</code></pre>
</div>
</div>
</section>
<section id="create-feature-extractor-models" class="level3" data-number="9.13.5">
<h3 data-number="9.13.5" class="anchored" data-anchor-id="create-feature-extractor-models"><span class="header-section-number">9.13.5</span> 7.5 Create feature extractor models</h3>
<p>Time to start building our models.</p>
<p>We’re going to create two feature extractor models:</p>
<ol type="1">
<li><a href="https://pytorch.org/vision/main/models/generated/torchvision.models.efficientnet_b0.html"><code>torchvision.models.efficientnet_b0()</code></a> pretrained backbone + custom classifier head (EffNetB0 for short).</li>
<li><a href="https://pytorch.org/vision/main/models/generated/torchvision.models.efficientnet_b2.html"><code>torchvision.models.efficientnet_b2()</code></a> pretrained backbone + custom classifier head (EffNetB2 for short).</li>
</ol>
<p>To do this, we’ll freeze the base layers (the feature layers) and update the model’s classifier heads (output layers) to suit our problem just like we did in <a href="https://www.learnpytorch.io/06_pytorch_transfer_learning/#34-freezing-the-base-model-and-changing-the-output-layer-to-suit-our-needs">06. PyTorch Transfer Learning section 3.4</a>.</p>
<p>We saw in the previous chapter the <code>in_features</code> parameter to the classifier head of EffNetB0 is <code>1280</code> (the backbone turns the input image into a feature vector of size <code>1280</code>).</p>
<p>Since EffNetB2 has a different number of layers and parameters, we’ll need to adapt it accordingly.</p>
<blockquote class="blockquote">
<p><strong>Note:</strong> Whenever you use a different model, one of the first things you should inspect is the input and output shapes. That way you’ll know how you’ll have to prepare your input data/update the model to have the correct output shape.</p>
</blockquote>
<p>We can find the input and output shapes of EffNetB2 using <a href="https://github.com/TylerYep/torchinfo"><code>torchinfo.summary()</code></a> and passing in the <code>input_size=(32, 3, 224, 224)</code> parameter (<code>(32, 3, 224, 224)</code> is equivalent to <code>(batch_size, color_channels, height, width)</code>, i.e we pass in an example of what a single batch of data would be to our model).</p>
<blockquote class="blockquote">
<p><strong>Note:</strong> Many modern models can handle input images of varying sizes thanks to <a href="https://pytorch.org/docs/stable/generated/torch.nn.AdaptiveAvgPool2d.html"><code>torch.nn.AdaptiveAvgPool2d()</code></a> layer, this layer adaptively adjusts the <code>output_size</code> of a given input as required. You can try this out by passing different size input images to <code>torchinfo.summary()</code> or to your own models using the layer.</p>
</blockquote>
<p>To find the required input shape to the final layer of EffNetB2, let’s: 1. Create an instance of <code>torchvision.models.efficientnet_b2(pretrained=True)</code>. 2. See the various input and output shapes by running <code>torchinfo.summary()</code>. 3. Print out the number of <code>in_features</code> by inspecting <code>state_dict()</code> of the classifier portion of EffNetB2 and printing the length of the weight matrix. * <strong>Note:</strong> You could also just inspect the output of <code>effnetb2.classifier</code>.</p>
<div id="cell-63" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchinfo <span class="im">import</span> summary</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Create an instance of EffNetB2 with pretrained weights</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>effnetb2_weights <span class="op">=</span> torchvision.models.EfficientNet_B2_Weights.DEFAULT <span class="co"># "DEFAULT" means best available weights</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>effnetb2 <span class="op">=</span> torchvision.models.efficientnet_b2(weights<span class="op">=</span>effnetb2_weights)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co"># # 2. Get a summary of standard EffNetB2 from torchvision.models (uncomment for full output)</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(model=effnetb2, </span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co">#         input_size=(32, 3, 224, 224), # make sure this is "input_size", not "input_shape"</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="co">#         # col_names=["input_size"], # uncomment for smaller output</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="co">#         col_names=["input_size", "output_size", "num_params", "trainable"],</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="co">#         col_width=20,</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="co">#         row_settings=["var_names"]</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="co"># ) </span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Get the number of in_features of the EfficientNetB2 classifier layer</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of in_features to final layer of EfficientNetB2: </span><span class="sc">{</span><span class="bu">len</span>(effnetb2.classifier.state_dict()[<span class="st">'1.weight'</span>][<span class="dv">0</span>])<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of in_features to final layer of EfficientNetB2: 1408</code></pre>
</div>
</div>
<p><img src="https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/07-effnetb2-unfrozen-summary-output.png" alt="output of torchinfo.summary() when passed our effnetb2 model with all layers trainable and default classifier head" width="900/"></p>
<p><em>Model summary of EffNetB2 feature extractor model with all layers unfrozen (trainable) and default classifier head from ImageNet pretraining.</em></p>
<p>Now we know the required number of <code>in_features</code> for the EffNetB2 model, let’s create a couple of helper functions to setup our EffNetB0 and EffNetB2 feature extractor models.</p>
<p>We want these functions to: 1. Get the base model from <code>torchvision.models</code> 2. Freeze the base layers in the model (set <code>requires_grad=False</code>) 3. Set the random seeds (we don’t <em>need</em> to do this but since we’re running a series of experiments and initalizing a new layer with random weights, we want the randomness to be similar for each experiment) 4. Change the classifier head (to suit our problem) 5. Give the model a name (e.g.&nbsp;“effnetb0” for EffNetB0)</p>
<div id="cell-65" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get num out features (one for each class pizza, steak, sushi)</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>OUT_FEATURES <span class="op">=</span> <span class="bu">len</span>(class_names)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an EffNetB0 feature extractor</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_effnetb0():</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Get the base mdoel with pretrained weights and send to target device</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> torchvision.models.EfficientNet_B0_Weights.DEFAULT</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> torchvision.models.efficientnet_b0(weights<span class="op">=</span>weights).to(device)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Freeze the base model layers</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> param <span class="kw">in</span> model.features.parameters():</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>        param.requires_grad <span class="op">=</span> <span class="va">False</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Set the seeds</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    set_seeds()</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Change the classifier head</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    model.classifier <span class="op">=</span> nn.Sequential(</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>        nn.Dropout(p<span class="op">=</span><span class="fl">0.2</span>),</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>        nn.Linear(in_features<span class="op">=</span><span class="dv">1280</span>, out_features<span class="op">=</span>OUT_FEATURES)</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    ).to(device)</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Give the model a name</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    model.name <span class="op">=</span> <span class="st">"effnetb0"</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"[INFO] Created new </span><span class="sc">{</span>model<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> model."</span>)</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an EffNetB2 feature extractor</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_effnetb2():</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Get the base model with pretrained weights and send to target device</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> torchvision.models.EfficientNet_B2_Weights.DEFAULT</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> torchvision.models.efficientnet_b2(weights<span class="op">=</span>weights).to(device)</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Freeze the base model layers</span></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> param <span class="kw">in</span> model.features.parameters():</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>        param.requires_grad <span class="op">=</span> <span class="va">False</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Set the seeds</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>    set_seeds()</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Change the classifier head</span></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>    model.classifier <span class="op">=</span> nn.Sequential(</span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>        nn.Dropout(p<span class="op">=</span><span class="fl">0.3</span>),</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>        nn.Linear(in_features<span class="op">=</span><span class="dv">1408</span>, out_features<span class="op">=</span>OUT_FEATURES)</span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>    ).to(device)</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Give the model a name</span></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>    model.name <span class="op">=</span> <span class="st">"effnetb2"</span></span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"[INFO] Created new </span><span class="sc">{</span>model<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> model."</span>)</span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Those are some nice looking functions!</p>
<p>Let’s test them out by creating an instance of EffNetB0 and EffNetB2 and checking out their <code>summary()</code>.</p>
<div id="cell-67" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>effnetb0 <span class="op">=</span> create_effnetb0() </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get an output summary of the layers in our EffNetB0 feature extractor model (uncomment to view full output)</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(model=effnetb0, </span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co">#         input_size=(32, 3, 224, 224), # make sure this is "input_size", not "input_shape"</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co">#         # col_names=["input_size"], # uncomment for smaller output</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co">#         col_names=["input_size", "output_size", "num_params", "trainable"],</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="co">#         col_width=20,</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         row_settings=["var_names"]</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ) </span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Created new effnetb0 model.</code></pre>
</div>
</div>
<p><img src="https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/07-effnetb0-frozen-summary-output.png" alt="output of torchinfo.summary() when passed our effnetb0 model with base layers are frozen and classifier head is updated" width="900/"></p>
<p><em>Model summary of EffNetB0 model with base layers frozen (untrainable) and updated classifier head (suited for pizza, steak, sushi image classification).</em></p>
<div id="cell-69" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>effnetb2 <span class="op">=</span> create_effnetb2()</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get an output summary of the layers in our EffNetB2 feature extractor model (uncomment to view full output)</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(model=effnetb2, </span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co">#         input_size=(32, 3, 224, 224), # make sure this is "input_size", not "input_shape"</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co">#         # col_names=["input_size"], # uncomment for smaller output</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="co">#         col_names=["input_size", "output_size", "num_params", "trainable"],</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co">#         col_width=20,</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         row_settings=["var_names"]</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ) </span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Created new effnetb2 model.</code></pre>
</div>
</div>
<p><img src="https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/07-effnetb2-frozen-summary-output.png" alt="output of torchinfo.summary() when passed our effnetb2 model with base layers are frozen and classifier head is updated" width="900/"></p>
<p><em>Model summary of EffNetB2 model with base layers frozen (untrainable) and updated classifier head (suited for pizza, steak, sushi image classification).</em></p>
<p>Looking at the outputs of the summaries, it seems the EffNetB2 backbone has nearly double the amount of parameters as EffNetB0.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Total parameters (before freezing/changing head)</th>
<th>Total parameters (after freezing/changing head)</th>
<th>Total trainable parameters (after freezing/changing head)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>EfficientNetB0</td>
<td>5,288,548</td>
<td>4,011,391</td>
<td>3,843</td>
</tr>
<tr class="even">
<td>EfficientNetB2</td>
<td>9,109,994</td>
<td>7,705,221</td>
<td>4,227</td>
</tr>
</tbody>
</table>
<p>This gives the backbone of the EffNetB2 model more opportunities to form a representation of our pizza, steak and sushi data.</p>
<p>However, the trainable parameters for each model (the classifier heads) aren’t very different.</p>
<p>Will these extra parameters lead to better results?</p>
<p>We’ll have to wait and see…</p>
<blockquote class="blockquote">
<p><strong>Note:</strong> In the spirit of experimenting, you really could try almost any model from <code>torchvision.models</code> in a similar fashion to what we’re doing here. I’ve only chosen EffNetB0 and EffNetB2 as examples. Perhaps you might want to throw something like <code>torchvision.models.convnext_tiny()</code> or <code>torchvision.models.convnext_small()</code> into the mix.</p>
</blockquote>
</section>
<section id="create-experiments-and-set-up-training-code" class="level3" data-number="9.13.6">
<h3 data-number="9.13.6" class="anchored" data-anchor-id="create-experiments-and-set-up-training-code"><span class="header-section-number">9.13.6</span> 7.6 Create experiments and set up training code</h3>
<p>We’ve prepared our data and prepared our models, the time has come to setup some experiments!</p>
<p>We’ll start by creating two lists and a dictionary: 1. A list of the number of epochs we’d like to test (<code>[5, 10]</code>) 2. A list of the models we’d like to test (<code>["effnetb0", "effnetb2"]</code>) 3. A dictionary of the different training DataLoaders</p>
<div id="cell-73" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Create epochs list</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>num_epochs <span class="op">=</span> [<span class="dv">5</span>, <span class="dv">10</span>]</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Create models list (need to create a new model for each experiment)</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> [<span class="st">"effnetb0"</span>, <span class="st">"effnetb2"</span>]</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Create dataloaders dictionary for various dataloaders</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>train_dataloaders <span class="op">=</span> {<span class="st">"data_10_percent"</span>: train_dataloader_10_percent,</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"data_20_percent"</span>: train_dataloader_20_percent}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Lists and dictionary created!</p>
<p>Now we can write code to iterate through each of the different options and try out each of the different combinations.</p>
<p>We’ll also save the model at the end of each experiment so later on we can load back in the best model and use it for making predictions.</p>
<p>Specifically, let’s go through the following steps: 1. Set the random seeds (so our experiment results are reproducible, in practice, you might run the same experiment across ~3 different seeds and average the results). 2. Keep track of different experiment numbers (this is mostly for pretty print outs). 3. Loop through the <code>train_dataloaders</code> dictionary items for each of the different training DataLoaders. 4. Loop through the list of epoch numbers. 5. Loop through the list of different model names. 6. Create information print outs for the current running experiment (so we know what’s happening). 7. Check which model is the target model and create a new EffNetB0 or EffNetB2 instance (we create a new model instance each experiment so all models start from the same standpoint). 8. Create a new loss function (<code>torch.nn.CrossEntropyLoss()</code>) and optimizer (<code>torch.optim.Adam(params=model.parameters(), lr=0.001)</code>) for each new experiment. 9. Train the model with the modified <code>train()</code> function passing the appropriate details to the <code>writer</code> parameter. 10. Save the trained model with an appropriate file name to file with <code>save_model()</code> from <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/going_modular/going_modular/utils.py"><code>utils.py</code></a>.</p>
<p>We can also use the <code>%%time</code> magic to see how long all of our experiments take together in a single Jupyter/Google Colab cell.</p>
<p>Let’s do it!</p>
<div id="cell-75" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> going_modular.going_modular.utils <span class="im">import</span> save_model</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Set the random seeds</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>set_seeds(seed<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Keep track of experiment numbers</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>experiment_number <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Loop through each DataLoader</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> dataloader_name, train_dataloader <span class="kw">in</span> train_dataloaders.items():</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Loop through each number of epochs</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epochs <span class="kw">in</span> num_epochs: </span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 5. Loop through each model name and create a new model based on the name</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> model_name <span class="kw">in</span> models:</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 6. Create information print outs</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>            experiment_number <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"[INFO] Experiment number: </span><span class="sc">{</span>experiment_number<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"[INFO] Model: </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"[INFO] DataLoader: </span><span class="sc">{</span>dataloader_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"[INFO] Number of epochs: </span><span class="sc">{</span>epochs<span class="sc">}</span><span class="ss">"</span>)  </span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 7. Select the model</span></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> model_name <span class="op">==</span> <span class="st">"effnetb0"</span>:</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>                model <span class="op">=</span> create_effnetb0() <span class="co"># creates a new model each time (important because we want each experiment to start from scratch)</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>                model <span class="op">=</span> create_effnetb2() <span class="co"># creates a new model each time (important because we want each experiment to start from scratch)</span></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 8. Create a new loss and optimizer for every model</span></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>            loss_fn <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>            optimizer <span class="op">=</span> torch.optim.Adam(params<span class="op">=</span>model.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 9. Train target model with target dataloaders and track experiments</span></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>            train(model<span class="op">=</span>model,</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>                  train_dataloader<span class="op">=</span>train_dataloader,</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>                  test_dataloader<span class="op">=</span>test_dataloader, </span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>                  optimizer<span class="op">=</span>optimizer,</span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>                  loss_fn<span class="op">=</span>loss_fn,</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>                  epochs<span class="op">=</span>epochs,</span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>                  device<span class="op">=</span>device,</span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>                  writer<span class="op">=</span>create_writer(experiment_name<span class="op">=</span>dataloader_name,</span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>                                       model_name<span class="op">=</span>model_name,</span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>                                       extra<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>epochs<span class="sc">}</span><span class="ss">_epochs"</span>))</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 10. Save the model to file so we can get back the best model</span></span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>            save_filepath <span class="op">=</span> <span class="ss">f"07_</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>dataloader_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>epochs<span class="sc">}</span><span class="ss">_epochs.pth"</span></span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a>            save_model(model<span class="op">=</span>model,</span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>                       target_dir<span class="op">=</span><span class="st">"models"</span>,</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>                       model_name<span class="op">=</span>save_filepath)</span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">50</span> <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Experiment number: 1
[INFO] Model: effnetb0
[INFO] DataLoader: data_10_percent
[INFO] Number of epochs: 5
[INFO] Created new effnetb0 model.
[INFO] Created SummaryWriter, saving to: runs/2022-06-23/data_10_percent/effnetb0/5_epochs...</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7f724e8d22604328b6f2c69ab0b3948f","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch: 1 | train_loss: 1.0528 | train_acc: 0.4961 | test_loss: 0.9217 | test_acc: 0.4678
Epoch: 2 | train_loss: 0.8747 | train_acc: 0.6992 | test_loss: 0.8138 | test_acc: 0.6203
Epoch: 3 | train_loss: 0.8099 | train_acc: 0.6445 | test_loss: 0.7175 | test_acc: 0.8258
Epoch: 4 | train_loss: 0.7097 | train_acc: 0.7578 | test_loss: 0.5897 | test_acc: 0.8864
Epoch: 5 | train_loss: 0.5980 | train_acc: 0.9141 | test_loss: 0.5676 | test_acc: 0.8864
[INFO] Saving model to: models/07_effnetb0_data_10_percent_5_epochs.pth
--------------------------------------------------

[INFO] Experiment number: 2
[INFO] Model: effnetb2
[INFO] DataLoader: data_10_percent
[INFO] Number of epochs: 5
[INFO] Created new effnetb2 model.
[INFO] Created SummaryWriter, saving to: runs/2022-06-23/data_10_percent/effnetb2/5_epochs...</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"36ca9faf96d443b38c6e3f71c427c567","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch: 1 | train_loss: 1.0928 | train_acc: 0.3711 | test_loss: 0.9557 | test_acc: 0.6610
Epoch: 2 | train_loss: 0.9247 | train_acc: 0.6445 | test_loss: 0.8711 | test_acc: 0.8144
Epoch: 3 | train_loss: 0.8086 | train_acc: 0.7656 | test_loss: 0.7511 | test_acc: 0.9176
Epoch: 4 | train_loss: 0.7191 | train_acc: 0.8867 | test_loss: 0.7150 | test_acc: 0.9081
Epoch: 5 | train_loss: 0.6851 | train_acc: 0.7695 | test_loss: 0.7076 | test_acc: 0.8873
[INFO] Saving model to: models/07_effnetb2_data_10_percent_5_epochs.pth
--------------------------------------------------

[INFO] Experiment number: 3
[INFO] Model: effnetb0
[INFO] DataLoader: data_10_percent
[INFO] Number of epochs: 10
[INFO] Created new effnetb0 model.
[INFO] Created SummaryWriter, saving to: runs/2022-06-23/data_10_percent/effnetb0/10_epochs...</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"85b88ac8b65a41139edf9ef59763f6cc","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch: 1 | train_loss: 1.0528 | train_acc: 0.4961 | test_loss: 0.9217 | test_acc: 0.4678
Epoch: 2 | train_loss: 0.8747 | train_acc: 0.6992 | test_loss: 0.8138 | test_acc: 0.6203
Epoch: 3 | train_loss: 0.8099 | train_acc: 0.6445 | test_loss: 0.7175 | test_acc: 0.8258
Epoch: 4 | train_loss: 0.7097 | train_acc: 0.7578 | test_loss: 0.5897 | test_acc: 0.8864
Epoch: 5 | train_loss: 0.5980 | train_acc: 0.9141 | test_loss: 0.5676 | test_acc: 0.8864
Epoch: 6 | train_loss: 0.5611 | train_acc: 0.8984 | test_loss: 0.5949 | test_acc: 0.8864
Epoch: 7 | train_loss: 0.5573 | train_acc: 0.7930 | test_loss: 0.5566 | test_acc: 0.8864
Epoch: 8 | train_loss: 0.4702 | train_acc: 0.9492 | test_loss: 0.5176 | test_acc: 0.8759
Epoch: 9 | train_loss: 0.5728 | train_acc: 0.7773 | test_loss: 0.5095 | test_acc: 0.8873
Epoch: 10 | train_loss: 0.4794 | train_acc: 0.8242 | test_loss: 0.4640 | test_acc: 0.9072
[INFO] Saving model to: models/07_effnetb0_data_10_percent_10_epochs.pth
--------------------------------------------------

[INFO] Experiment number: 4
[INFO] Model: effnetb2
[INFO] DataLoader: data_10_percent
[INFO] Number of epochs: 10
[INFO] Created new effnetb2 model.
[INFO] Created SummaryWriter, saving to: runs/2022-06-23/data_10_percent/effnetb2/10_epochs...</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b4df178559d448539d3e159fb9a3b0fb","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch: 1 | train_loss: 1.0928 | train_acc: 0.3711 | test_loss: 0.9557 | test_acc: 0.6610
Epoch: 2 | train_loss: 0.9247 | train_acc: 0.6445 | test_loss: 0.8711 | test_acc: 0.8144
Epoch: 3 | train_loss: 0.8086 | train_acc: 0.7656 | test_loss: 0.7511 | test_acc: 0.9176
Epoch: 4 | train_loss: 0.7191 | train_acc: 0.8867 | test_loss: 0.7150 | test_acc: 0.9081
Epoch: 5 | train_loss: 0.6851 | train_acc: 0.7695 | test_loss: 0.7076 | test_acc: 0.8873
Epoch: 6 | train_loss: 0.6111 | train_acc: 0.7812 | test_loss: 0.6325 | test_acc: 0.9280
Epoch: 7 | train_loss: 0.6127 | train_acc: 0.8008 | test_loss: 0.6404 | test_acc: 0.8769
Epoch: 8 | train_loss: 0.5202 | train_acc: 0.9336 | test_loss: 0.6200 | test_acc: 0.8977
Epoch: 9 | train_loss: 0.5425 | train_acc: 0.8008 | test_loss: 0.6227 | test_acc: 0.8466
Epoch: 10 | train_loss: 0.4908 | train_acc: 0.8125 | test_loss: 0.5870 | test_acc: 0.8873
[INFO] Saving model to: models/07_effnetb2_data_10_percent_10_epochs.pth
--------------------------------------------------

[INFO] Experiment number: 5
[INFO] Model: effnetb0
[INFO] DataLoader: data_20_percent
[INFO] Number of epochs: 5
[INFO] Created new effnetb0 model.
[INFO] Created SummaryWriter, saving to: runs/2022-06-23/data_20_percent/effnetb0/5_epochs...</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"067d7002a70443edb72e0dc5f61b60d1","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch: 1 | train_loss: 0.9577 | train_acc: 0.6167 | test_loss: 0.6545 | test_acc: 0.8655
Epoch: 2 | train_loss: 0.6881 | train_acc: 0.8438 | test_loss: 0.5798 | test_acc: 0.9176
Epoch: 3 | train_loss: 0.5798 | train_acc: 0.8604 | test_loss: 0.4575 | test_acc: 0.9176
Epoch: 4 | train_loss: 0.4930 | train_acc: 0.8646 | test_loss: 0.4458 | test_acc: 0.9176
Epoch: 5 | train_loss: 0.4886 | train_acc: 0.8500 | test_loss: 0.3909 | test_acc: 0.9176
[INFO] Saving model to: models/07_effnetb0_data_20_percent_5_epochs.pth
--------------------------------------------------

[INFO] Experiment number: 6
[INFO] Model: effnetb2
[INFO] DataLoader: data_20_percent
[INFO] Number of epochs: 5
[INFO] Created new effnetb2 model.
[INFO] Created SummaryWriter, saving to: runs/2022-06-23/data_20_percent/effnetb2/5_epochs...</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"50eee46e57ec47948c11b0b51a2460e3","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch: 1 | train_loss: 0.9830 | train_acc: 0.5521 | test_loss: 0.7767 | test_acc: 0.8153
Epoch: 2 | train_loss: 0.7298 | train_acc: 0.7604 | test_loss: 0.6673 | test_acc: 0.8873
Epoch: 3 | train_loss: 0.6022 | train_acc: 0.8458 | test_loss: 0.5622 | test_acc: 0.9280
Epoch: 4 | train_loss: 0.5435 | train_acc: 0.8354 | test_loss: 0.5679 | test_acc: 0.9186
Epoch: 5 | train_loss: 0.4404 | train_acc: 0.9042 | test_loss: 0.4462 | test_acc: 0.9489
[INFO] Saving model to: models/07_effnetb2_data_20_percent_5_epochs.pth
--------------------------------------------------

[INFO] Experiment number: 7
[INFO] Model: effnetb0
[INFO] DataLoader: data_20_percent
[INFO] Number of epochs: 10
[INFO] Created new effnetb0 model.
[INFO] Created SummaryWriter, saving to: runs/2022-06-23/data_20_percent/effnetb0/10_epochs...</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"564c35143a874dd1ad829e03034101f2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch: 1 | train_loss: 0.9577 | train_acc: 0.6167 | test_loss: 0.6545 | test_acc: 0.8655
Epoch: 2 | train_loss: 0.6881 | train_acc: 0.8438 | test_loss: 0.5798 | test_acc: 0.9176
Epoch: 3 | train_loss: 0.5798 | train_acc: 0.8604 | test_loss: 0.4575 | test_acc: 0.9176
Epoch: 4 | train_loss: 0.4930 | train_acc: 0.8646 | test_loss: 0.4458 | test_acc: 0.9176
Epoch: 5 | train_loss: 0.4886 | train_acc: 0.8500 | test_loss: 0.3909 | test_acc: 0.9176
Epoch: 6 | train_loss: 0.3705 | train_acc: 0.8854 | test_loss: 0.3568 | test_acc: 0.9072
Epoch: 7 | train_loss: 0.3551 | train_acc: 0.9250 | test_loss: 0.3187 | test_acc: 0.9072
Epoch: 8 | train_loss: 0.3745 | train_acc: 0.8938 | test_loss: 0.3349 | test_acc: 0.8873
Epoch: 9 | train_loss: 0.2972 | train_acc: 0.9396 | test_loss: 0.3092 | test_acc: 0.9280
Epoch: 10 | train_loss: 0.3620 | train_acc: 0.8479 | test_loss: 0.2780 | test_acc: 0.9072
[INFO] Saving model to: models/07_effnetb0_data_20_percent_10_epochs.pth
--------------------------------------------------

[INFO] Experiment number: 8
[INFO] Model: effnetb2
[INFO] DataLoader: data_20_percent
[INFO] Number of epochs: 10
[INFO] Created new effnetb2 model.
[INFO] Created SummaryWriter, saving to: runs/2022-06-23/data_20_percent/effnetb2/10_epochs...</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c53f44132ccf45d4aeb1e8cc18383798","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch: 1 | train_loss: 0.9830 | train_acc: 0.5521 | test_loss: 0.7767 | test_acc: 0.8153
Epoch: 2 | train_loss: 0.7298 | train_acc: 0.7604 | test_loss: 0.6673 | test_acc: 0.8873
Epoch: 3 | train_loss: 0.6022 | train_acc: 0.8458 | test_loss: 0.5622 | test_acc: 0.9280
Epoch: 4 | train_loss: 0.5435 | train_acc: 0.8354 | test_loss: 0.5679 | test_acc: 0.9186
Epoch: 5 | train_loss: 0.4404 | train_acc: 0.9042 | test_loss: 0.4462 | test_acc: 0.9489
Epoch: 6 | train_loss: 0.3889 | train_acc: 0.9104 | test_loss: 0.4555 | test_acc: 0.8977
Epoch: 7 | train_loss: 0.3483 | train_acc: 0.9271 | test_loss: 0.4227 | test_acc: 0.9384
Epoch: 8 | train_loss: 0.3862 | train_acc: 0.8771 | test_loss: 0.4344 | test_acc: 0.9280
Epoch: 9 | train_loss: 0.3308 | train_acc: 0.8979 | test_loss: 0.4242 | test_acc: 0.9384
Epoch: 10 | train_loss: 0.3383 | train_acc: 0.8896 | test_loss: 0.3906 | test_acc: 0.9384
[INFO] Saving model to: models/07_effnetb2_data_20_percent_10_epochs.pth
--------------------------------------------------

CPU times: user 29.5 s, sys: 1min 28s, total: 1min 58s
Wall time: 2min 33s</code></pre>
</div>
</div>
</section>
</section>
<section id="view-experiments-in-tensorboard" class="level2" data-number="9.14">
<h2 data-number="9.14" class="anchored" data-anchor-id="view-experiments-in-tensorboard"><span class="header-section-number">9.14</span> 8. View experiments in TensorBoard</h2>
<p>Ho, ho!</p>
<p>Look at us go!</p>
<p>Training eight models in one go?</p>
<p>Now that’s living up to the motto!</p>
<p><em>Experiment, experiment, experiment!</em></p>
<p>How about we check out the results in TensorBoard?</p>
<div id="cell-77" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Viewing TensorBoard in Jupyter and Google Colab Notebooks (uncomment to view full TensorBoard instance)</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="co"># %load_ext tensorboard</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co"># %tensorboard --logdir runs</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Running the cell above we should get an output similar to the following.</p>
<blockquote class="blockquote">
<p><strong>Note:</strong> Depending on the random seeds you used/hardware you used there’s a chance your numbers aren’t exactly the same as what’s here. This is okay. It’s due to the inherent randomness of deep learning. What matters most is the trend. Where your numbers are heading. If they’re off by a large amount, perhaps there’s something wrong and best to go back and check the code. But if they’re off by a small amount (say a couple of decimal places or so), that’s okay.</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/07-tensorboard-lowest-test-loss.png" alt="various modelling experiments visualized on tensorboard with model that has the lowest test loss highlighted" width="900/"></p>
<p><em>Visualizing the test loss values for the different modelling experiments in TensorBoard, you can see that the EffNetB2 model trained for 10 epochs and with 20% of the data achieves the lowest loss. This sticks with the overall trend of the experiments that: more data, larger model and longer training time is generally better.</em></p>
<p>You can also upload your TensorBoard experiment results to <a href="https://tensorboard.dev">tensorboard.dev</a> to host them publically for free.</p>
<p>For example, running code similiar to the following:</p>
<div id="cell-79" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # Upload the results to TensorBoard.dev (uncomment to try it out)</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co"># !tensorboard dev upload --logdir runs \</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     --name "07. PyTorch Experiment Tracking: FoodVision Mini model results" \</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     --description "Comparing results of different model size, training data amount and training time."</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Running the cell above results in the experiments from this notebook being publically viewable at: https://tensorboard.dev/experiment/VySxUYY7Rje0xREYvCvZXA/</p>
<blockquote class="blockquote">
<p><strong>Note:</strong> Beware that anything you upload to tensorboard.dev is publically available for anyone to see. So if you do upload your experiments, be careful they don’t contain sensitive information.</p>
</blockquote>
</section>
<section id="load-in-the-best-model-and-make-predictions-with-it" class="level2" data-number="9.15">
<h2 data-number="9.15" class="anchored" data-anchor-id="load-in-the-best-model-and-make-predictions-with-it"><span class="header-section-number">9.15</span> 9. Load in the best model and make predictions with it</h2>
<p>Looking at the TensorBoard logs for our eight experiments, it seems experiment number eight achieved the best overall results (highest test accuracy, second lowest test loss).</p>
<p>This is the experiment that used: * EffNetB2 (double the parameters of EffNetB0) * 20% pizza, steak, sushi training data (double the original training data) * 10 epochs (double the original training time)</p>
<p>In essence, our biggest model achieved the best results.</p>
<p>Though it wasn’t as if these results were far better than the other models.</p>
<p>The same model on the same data achieved similar results in half the training time (experiment number 6).</p>
<p>This suggests that potentially the most influential parts of our experiments were the number of parameters and the amount of data.</p>
<p>Inspecting the results further it seems that generally a model with more parameters (EffNetB2) and more data (20% pizza, steak, sushi training data) performs better (lower test loss and higher test accuracy).</p>
<p>More experiments could be done to further test this but for now, let’s import our best performing model from experiment eight (saved to: <code>models/07_effnetb2_data_20_percent_10_epochs.pth</code>, you can <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/models/07_effnetb2_data_20_percent_10_epochs.pth">download this model from the course GitHub</a>) and perform some qualitative evaluations.</p>
<p>In other words, let’s <em>visualize, visualize, visualize!</em></p>
<p>We can import the best saved model by creating a new instance of EffNetB2 using the <code>create_effnetb2()</code> function and then load in the saved <code>state_dict()</code> with <code>torch.load()</code>.</p>
<div id="cell-82" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup the best model filepath</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>best_model_path <span class="op">=</span> <span class="st">"models/07_effnetb2_data_20_percent_10_epochs.pth"</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate a new instance of EffNetB2 (to load the saved state_dict() to)</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>best_model <span class="op">=</span> create_effnetb2()</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the saved best model state_dict()</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>best_model.load_state_dict(torch.load(best_model_path))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Created new effnetb2 model.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>&lt;All keys matched successfully&gt;</code></pre>
</div>
</div>
<p>Best model loaded!</p>
<p>While we’re here, let’s check its filesize.</p>
<p>This is an important consideration later on when deploying the model (incorporating it in an app).</p>
<p>If the model is too large, it can be hard to deploy.</p>
<div id="cell-84" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the model file size</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the model size in bytes then convert to megabytes</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>effnetb2_model_size <span class="op">=</span> Path(best_model_path).stat().st_size <span class="op">//</span> (<span class="dv">1024</span><span class="op">*</span><span class="dv">1024</span>)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"EfficientNetB2 feature extractor model size: </span><span class="sc">{</span>effnetb2_model_size<span class="sc">}</span><span class="ss"> MB"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>EfficientNetB2 feature extractor model size: 29 MB</code></pre>
</div>
</div>
<p>Looks like our best model so far is 29 MB in size. We’ll keep this in mind if we wanted to deploy it later on.</p>
<p>Time to make and visualize some predictions.</p>
<p>We created a <code>pred_and_plot_image()</code> function use a trained model to make predictions on an image in <a href="https://www.learnpytorch.io/06_pytorch_transfer_learning/#6-make-predictions-on-images-from-the-test-set">06. PyTorch Transfer Learning section 6</a>.</p>
<p>And we can reuse this function by importing it from <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/going_modular/going_modular/predictions.py"><code>going_modular.going_modular.predictions.py</code></a> (I put the <code>pred_and_plot_image()</code> function in a script so we could reuse it).</p>
<p>So to make predictions on various images the model hasn’t seen before, we’ll first get a list of all the image filepaths from the 20% pizza, steak, sushi testing dataset and then we’ll randomly select a subset of these filepaths to pass to our <code>pred_and_plot_image()</code> function.</p>
<div id="cell-86" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import function to make predictions on images and plot them </span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="co"># See the function previously created in section: https://www.learnpytorch.io/06_pytorch_transfer_learning/#6-make-predictions-on-images-from-the-test-set</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> going_modular.going_modular.predictions <span class="im">import</span> pred_and_plot_image</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a random list of 3 images from 20% test set</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>num_images_to_plot <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>test_image_path_list <span class="op">=</span> <span class="bu">list</span>(Path(data_20_percent_path <span class="op">/</span> <span class="st">"test"</span>).glob(<span class="st">"*/*.jpg"</span>)) <span class="co"># get all test image paths from 20% dataset</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>test_image_path_sample <span class="op">=</span> random.sample(population<span class="op">=</span>test_image_path_list,</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>                                       k<span class="op">=</span>num_images_to_plot) <span class="co"># randomly select k number of images</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate through random test image paths, make predictions on them and plot them</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> image_path <span class="kw">in</span> test_image_path_sample:</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    pred_and_plot_image(model<span class="op">=</span>best_model,</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>                        image_path<span class="op">=</span>image_path,</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>                        class_names<span class="op">=</span>class_names,</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>                        image_size<span class="op">=</span>(<span class="dv">224</span>, <span class="dv">224</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07_pytorch_experiment_tracking_files/figure-html/cell-35-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07_pytorch_experiment_tracking_files/figure-html/cell-35-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07_pytorch_experiment_tracking_files/figure-html/cell-35-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Nice!</p>
<p>Running the cell above a few times we can see our model performs quite well and often has higher prediction probabilities than previous models we’ve built.</p>
<p>This suggests the model is more confident in the decisions it’s making.</p>
<section id="predict-on-a-custom-image-with-the-best-model" class="level3" data-number="9.15.1">
<h3 data-number="9.15.1" class="anchored" data-anchor-id="predict-on-a-custom-image-with-the-best-model"><span class="header-section-number">9.15.1</span> 9.1 Predict on a custom image with the best model</h3>
<p>Making predictions on the test dataset is cool but the real magic of machine learning is making predictions on custom images of your own.</p>
<p>So let’s import the trusty <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/images/04-pizza-dad.jpeg">pizza dad image</a> (a photo of my dad in front of a pizza) we’ve been using for the past couple of sections and see how our model performs on it.</p>
<div id="cell-89" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download custom image</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup custom image path</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>custom_image_path <span class="op">=</span> Path(<span class="st">"data/04-pizza-dad.jpeg"</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the image if it doesn't already exist</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> custom_image_path.is_file():</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(custom_image_path, <span class="st">"wb"</span>) <span class="im">as</span> f:</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># When downloading from GitHub, need to use the "raw" file link</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>        request <span class="op">=</span> requests.get(<span class="st">"https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/04-pizza-dad.jpeg"</span>)</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Downloading </span><span class="sc">{</span>custom_image_path<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>        f.write(request.content)</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>custom_image_path<span class="sc">}</span><span class="ss"> already exists, skipping download."</span>)</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict on custom image</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>pred_and_plot_image(model<span class="op">=</span>model,</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>                    image_path<span class="op">=</span>custom_image_path,</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>                    class_names<span class="op">=</span>class_names)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>data/04-pizza-dad.jpeg already exists, skipping download.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07_pytorch_experiment_tracking_files/figure-html/cell-36-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Woah!</p>
<p>Two thumbs again!</p>
<p>Our best model predicts “pizza” correctly and this time with an even higher prediction probability (0.978) than the first feature extraction model we trained and used in <a href="https://www.learnpytorch.io/06_pytorch_transfer_learning/#61-making-predictions-on-a-custom-image">06. PyTorch Transfer Learning section 6.1</a>.</p>
<p>This again suggests our current best model (EffNetB2 feature extractor trained on 20% of the pizza, steak, sushi training data and for 10 epochs) has learned patterns to make it more confident of its decision to predict pizza.</p>
<p>I wonder what could improve our model’s performance even further?</p>
<p>I’ll leave that as a challenge for you to investigate.</p>
</section>
</section>
<section id="main-takeaways" class="level2" data-number="9.16">
<h2 data-number="9.16" class="anchored" data-anchor-id="main-takeaways"><span class="header-section-number">9.16</span> Main takeaways</h2>
<p>We’ve now gone full circle on the PyTorch workflow introduced in <a href="https://www.learnpytorch.io/01_pytorch_workflow/">01. PyTorch Workflow Fundamentals</a>, we’ve gotten data ready, we’ve built and picked a pretrained model, we’ve used our various helper functions to train and evaluate the model and in this notebook we’ve improved our FoodVision Mini model by running and tracking a series of experiments.</p>
<p><img src="https://raw.githubusercontent.com/mrdbourke/pytorch-deep-learning/main/images/01_a_pytorch_workflow.png" width="900" alt="a pytorch workflow flowchat"></p>
<p>You should be proud of yourself, this is no small feat!</p>
<p>The main ideas you should take away from this Milestone Project 1 are:</p>
<ul>
<li>The machine learning practioner’s motto: <em>experiment, experiment, experiment!</em> (though we’ve been doing plenty of this already).</li>
<li>In the beginning, keep your experiments small so you can work fast, your first few experiments shouldn’t take more than a few seconds to a few minutes to run.</li>
<li>The more experiments you do, the quicker you can figure out what <em>doesn’t</em> work.</li>
<li>Scale up when you find something that works. For example, since we’ve found a pretty good performing model with EffNetB2 as a feature extractor, perhaps you’d now like to see what happens when you scale it up to the whole <a href="https://pytorch.org/vision/main/generated/torchvision.datasets.Food101.html">Food101 dataset</a> from <code>torchvision.datasets</code>.</li>
<li>Programmatically tracking your experiments takes a few steps to set up but it’s worth it in the long run so you can figure out what works and what doesn’t.
<ul>
<li>There are many different machine learning experiment trackers out there so explore a few and try them out.</li>
</ul></li>
</ul>
</section>
<section id="exercises" class="level2" data-number="9.17">
<h2 data-number="9.17" class="anchored" data-anchor-id="exercises"><span class="header-section-number">9.17</span> Exercises</h2>
<blockquote class="blockquote">
<p><strong>Note:</strong> These exercises expect the use of <code>torchvision</code> v0.13+ (currently in beta as of June 2022). You can install the nightly version via the PyTorch getting started page.</p>
</blockquote>
<p>All of the exercises are focused on practicing the code above.</p>
<p>You should be able to complete them by referencing each section or by following the resource(s) linked.</p>
<p>All exercises should be completed using <a href="https://pytorch.org/docs/stable/notes/cuda.html#device-agnostic-code">device-agnostic code</a>.</p>
<p><strong>Resources:</strong> * <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/extras/exercises/07_pytorch_experiment_tracking_exercise_template.ipynb">Exercise template notebook for 07</a> * <a href="https://github.com/mrdbourke/pytorch-deep-learning/blob/main/extras/solutions/07_pytorch_experiment_tracking_exercise_solutions.ipynb">Example solutions notebook for 07</a> (try the exercises <em>before</em> looking at this) * See a live <a href="https://youtu.be/cO_r2FYcAjU">video walkthrough of the solutions on YouTube</a> (errors and all)</p>
<ol type="1">
<li>Pick a larger model from <a href="https://pytorch.org/vision/main/models.html"><code>torchvision.models</code></a> to add to the list of experiments (for example, EffNetB3 or higher).
<ul>
<li>How does it perform compared to our existing models?</li>
</ul></li>
<li>Introduce data augmentation to the list of experiments using the 20% pizza, steak, sushi training and test datasets, does this change anything?
<ul>
<li>For example, you could have one training DataLoader that uses data augmentation (e.g.&nbsp;<code>train_dataloader_20_percent_aug</code> and <code>train_dataloader_20_percent_no_aug</code>) and then compare the results of two of the same model types training on these two DataLoaders.</li>
<li><strong>Note:</strong> You may need to alter the <code>create_dataloaders()</code> function to be able to take a transform for the training data and the testing data (because you don’t need to perform data augmentation on the test data). See <a href="https://www.learnpytorch.io/04_pytorch_custom_datasets/#6-other-forms-of-transforms-data-augmentation">04. PyTorch Custom Datasets section 6</a> for examples of using data augmentation or the script below for an example:</li>
</ul></li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: Data augmentation transform like this should only be performed on training data</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>train_transform_data_aug <span class="op">=</span> transforms.Compose([</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((<span class="dv">224</span>, <span class="dv">224</span>)),</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    transforms.TrivialAugmentWide(),</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor(),</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    normalize</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to view images in a DataLoader (works with data augmentation transforms or not) </span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> view_dataloader_images(dataloader, n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Having n higher than 10 will create messy plots, lowering to 10."</span>)</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>    imgs, labels <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(dataloader))</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">8</span>))</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Min max scale the image for display purposes</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>        targ_image <span class="op">=</span> imgs[i]</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>        sample_min, sample_max <span class="op">=</span> targ_image.<span class="bu">min</span>(), targ_image.<span class="bu">max</span>()</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>        sample_scaled <span class="op">=</span> (targ_image <span class="op">-</span> sample_min)<span class="op">/</span>(sample_max <span class="op">-</span> sample_min)</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot images with appropriate axes information</span></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">1</span>, <span class="dv">10</span>, i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>        plt.imshow(sample_scaled.permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>)) <span class="co"># resize for Matplotlib requirements</span></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>        plt.title(class_names[labels[i]])</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>        plt.axis(<span class="va">False</span>)</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Have to update `create_dataloaders()` to handle different augmentations</span></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> datasets</span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>NUM_WORKERS <span class="op">=</span> os.cpu_count() <span class="co"># use maximum number of CPUs for workers to load data </span></span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: this is an update version of data_setup.create_dataloaders to handle</span></span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a><span class="co"># differnt train and test transforms.</span></span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_dataloaders(</span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a>    train_dir, </span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a>    test_dir, </span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>    train_transform, <span class="co"># add parameter for train transform (transforms on train dataset)</span></span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>    test_transform,  <span class="co"># add parameter for test transform (transforms on test dataset)</span></span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">32</span>, num_workers<span class="op">=</span>NUM_WORKERS</span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use ImageFolder to create dataset(s)</span></span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a>    train_data <span class="op">=</span> datasets.ImageFolder(train_dir, transform<span class="op">=</span>train_transform)</span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a>    test_data <span class="op">=</span> datasets.ImageFolder(test_dir, transform<span class="op">=</span>test_transform)</span>
<span id="cb69-47"><a href="#cb69-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-48"><a href="#cb69-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get class names</span></span>
<span id="cb69-49"><a href="#cb69-49" aria-hidden="true" tabindex="-1"></a>    class_names <span class="op">=</span> train_data.classes</span>
<span id="cb69-50"><a href="#cb69-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-51"><a href="#cb69-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turn images into data loaders</span></span>
<span id="cb69-52"><a href="#cb69-52" aria-hidden="true" tabindex="-1"></a>    train_dataloader <span class="op">=</span> DataLoader(</span>
<span id="cb69-53"><a href="#cb69-53" aria-hidden="true" tabindex="-1"></a>        train_data,</span>
<span id="cb69-54"><a href="#cb69-54" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span>batch_size,</span>
<span id="cb69-55"><a href="#cb69-55" aria-hidden="true" tabindex="-1"></a>        shuffle<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb69-56"><a href="#cb69-56" aria-hidden="true" tabindex="-1"></a>        num_workers<span class="op">=</span>num_workers,</span>
<span id="cb69-57"><a href="#cb69-57" aria-hidden="true" tabindex="-1"></a>        pin_memory<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb69-58"><a href="#cb69-58" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-59"><a href="#cb69-59" aria-hidden="true" tabindex="-1"></a>    test_dataloader <span class="op">=</span> DataLoader(</span>
<span id="cb69-60"><a href="#cb69-60" aria-hidden="true" tabindex="-1"></a>        test_data,</span>
<span id="cb69-61"><a href="#cb69-61" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span>batch_size,</span>
<span id="cb69-62"><a href="#cb69-62" aria-hidden="true" tabindex="-1"></a>        shuffle<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb69-63"><a href="#cb69-63" aria-hidden="true" tabindex="-1"></a>        num_workers<span class="op">=</span>num_workers,</span>
<span id="cb69-64"><a href="#cb69-64" aria-hidden="true" tabindex="-1"></a>        pin_memory<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb69-65"><a href="#cb69-65" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-66"><a href="#cb69-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-67"><a href="#cb69-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_dataloader, test_dataloader, class_names</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ol start="3" type="1">
<li>Scale up the dataset to turn FoodVision Mini into FoodVision Big using the entire <a href="https://pytorch.org/vision/stable/generated/torchvision.datasets.Food101.html#torchvision.datasets.Food101">Food101 dataset from <code>torchvision.models</code></a>
<ul>
<li>You could take the best performing model from your various experiments or even the EffNetB2 feature extractor we created in this notebook and see how it goes fitting for 5 epochs on all of Food101.</li>
<li>If you try more than one model, it would be good to have the model’s results tracked.</li>
<li>If you load the Food101 dataset from <code>torchvision.models</code>, you’ll have to create PyTorch DataLoaders to use it in training.</li>
<li><strong>Note:</strong> Due to the larger amount of data in Food101 compared to our pizza, steak, sushi dataset, this model will take longer to train.</li>
</ul></li>
</ol>
</section>
<section id="extra-curriculum" class="level2" data-number="9.18">
<h2 data-number="9.18" class="anchored" data-anchor-id="extra-curriculum"><span class="header-section-number">9.18</span> Extra-curriculum</h2>
<ul>
<li>Read <a href="http://www.incompleteideas.net/IncIdeas/BitterLesson.html">The Bitter Lesson</a> blog post by Richard Sutton to get an idea of how many of the latest advancements in AI have come from increased scale (bigger datasets and bigger models) and more general (less meticulously crafted) methods.</li>
<li>Go through the <a href="https://pytorch.org/tutorials/beginner/introyt/tensorboardyt_tutorial.html">PyTorch YouTube/code tutorial</a> for TensorBoard for 20-minutes and see how it compares to the code we’ve written in this notebook.</li>
<li>Perhaps you may want to view and rearrange your model’s TensorBoard logs with a DataFrame (so you can sort the results by lowest loss or highest accuracy), there’s a guide for this <a href="https://www.tensorflow.org/tensorboard/dataframe_api">in the TensorBoard documentation</a>.</li>
<li>If you like to use VSCode for development using scripts or notebooks (VSCode can now use Jupyter Notebooks natively), you can setup TensorBoard right within VSCode using the <a href="https://code.visualstudio.com/docs/datascience/pytorch-support">PyTorch Development in VSCode guide</a>.</li>
<li>To go further with experiment tracking and see how your PyTorch model is performing from a speed perspective (are there any bottlenecks that could be improved to speed up training?), see the <a href="https://pytorch.org/blog/introducing-pytorch-profiler-the-new-and-improved-performance-tool/">PyTorch documentation for the PyTorch profiler</a>.</li>
<li>Made With ML is an outstanding resource for all things machine learning by Goku Mohandas and their <a href="https://madewithml.com/courses/mlops/experiment-tracking/">guide on experiment tracking</a> contains a fantastic introduction to tracking machine learning experiments with MLflow.</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./06_pytorch_transfer_learning.html" class="pagination-link" aria-label="06 - PyTorch 전이 학습">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">06 - PyTorch 전이 학습</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./08_pytorch_paper_replicating.html" class="pagination-link" aria-label="08 - PyTorch 논문 복제">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">08 - PyTorch 논문 복제</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>